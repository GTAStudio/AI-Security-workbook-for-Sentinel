{
    "version": "Notebook/2.0",
    "items": [
        {
            "type": 1,
            "content": {
                "json": "# \ud83d\udee1\ufe0f AI安全情报监控平台\n---\n## 企业级AI安全态势360监控平台\n### 作者: Jason Liang\n\n<div style=\"background: linear-gradient(135deg, #0078D4 0%, #004E8C 100%); padding: 20px; border-radius: 10px; color: white; margin: 15px 0;\">\n  <h3 style=\"margin: 0 0 10px 0; font-size: 18px;\">\ud83d\udcca 监控仪表板</h3>\n  <p style=\"margin: 0; font-size: 14px;\">该仪表板为企业AI应用提供360度安全可视化，涵盖威胁检测、合规分析、风险评估等关键领域。</p>\n  <p style=\"margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;\">开发者: Jason Liang</p>\n</div>\n\n<div style=\"display: flex; flex-wrap: wrap; justify-content: space-between; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f2f9ff; margin: 5px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83d\udea8 威胁监控</h4>\n    <p style=\"font-size: 13px; color: #333;\">实时检测AI相关安全威胁</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f2f9ff; margin: 5px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83d\udccb 合规监管</h4>\n    <p style=\"font-size: 13px; color: #333;\">监控AI使用是否符合企业与监管政策</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f2f9ff; margin: 5px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\u26a0\ufe0f 风险评估</h4>\n    <p style=\"font-size: 13px; color: #333;\">多维风险分析与预测</p>\n  </div>\n</div>\n<div style=\"display: flex; flex-wrap: wrap; justify-content: space-between; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f2f9ff; margin: 5px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83d\udcc8 使用分析</h4>\n    <p style=\"font-size: 13px; color: #333;\">跟踪AI采用程度与使用模式</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f2f9ff; margin: 5px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83c\udf0d 地理洞察</h4>\n    <p style=\"font-size: 13px; color: #333;\">全球威胁态势情报</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f2f9ff; margin: 5px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83d\udce6 资产清单</h4>\n    <p style=\"font-size: 13px; color: #333;\">管理AI模型与服务资产</p>\n  </div>\n</div>\n\n---"
            },
            "name": "header_banner",
            "id": "7cdd6831-047f-45ff-a05d-afa60afc6c3b"
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "parameters": [
                    {
                        "id": "timeRange",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "\u23f1\ufe0f 时间范围",
                        "type": 4,
                        "isRequired": true,
                        "value": {
                            "durationMs": 7776000000
                        },
                        "typeSettings": {
                            "selectableValues": [
                                {
                                    "durationMs": 3600000,
                                    "display": "1 Hour"
                                },
                                {
                                    "durationMs": 86400000,
                                    "display": "1 Day"
                                },
                                {
                                    "durationMs": 604800000,
                                    "display": "7 Days"
                                },
                                {
                                    "durationMs": 2592000000,
                                    "display": "30 Days"
                                },
                                {
                                    "durationMs": 7776000000,
                                    "display": "90 Days"
                                }
                            ],
                            "allowCustom": true
                        }
                    },
                    {
                        "id": "trendDays",
                        "version": "KqlParameterItem/1.0",
                        "name": "TrendDays",
                        "label": "\ud83d\udcc5 趋势分析周期",
                        "type": 2,
                        "isRequired": true,
                        "typeSettings": {
                            "additionalResourceOptions": []
                        },
                        "jsonData": "[\"1\", \"7\", \"30\"]",
                        "value": "7"
                    },
                    {
                        "id": "selectedTab",
                        "version": "KqlParameterItem/1.0",
                        "name": "selectedTab",
                        "type": 1,
                        "isRequired": true,
                        "value": "overview"
                    },
                    {
                        "id": "严重级别Filter",
                        "version": "KqlParameterItem/1.0",
                        "name": "严重级别Filter",
                        "label": " 告警严重级别筛选",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "SecurityAlert\n| distinct Alert严重级别\n| order by Alert严重级别 asc",
                        "value": [
                            "value::all"
                        ],
                        "typeSettings": {
                            "additionalResourceOptions": [
                                "value::all"
                            ],
                            "selectAllValue": "*"
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                    }
                ],
                "style": "pills"
            },
            "name": "global_parameters",
            "id": "8706cf24-3f1c-46ef-b99f-c9b22d04c35f"
        },
        {
            "type": 11,
            "content": {
                "version": "LinkItem/1.0",
                "style": "tabs",
                "links": [
                    {
                        "id": "overview-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udcca 概览仪表板",
                        "subTarget": "overview",
                        "style": "link"
                    },
                    {
                        "id": "compliance-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udccb 合规监控",
                        "subTarget": "compliance",
                        "style": "link"
                    },
                    {
                        "id": "risk-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\u26a0\ufe0f 风险评估",
                        "subTarget": "risk",
                        "style": "link"
                    },
                    {
                        "id": "geo-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83c\udf0d 地理分析",
                        "subTarget": "geo",
                        "style": "link"
                    },
                    {
                        "id": "behavior-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83c\udfaf 行为分析",
                        "subTarget": "behavior",
                        "style": "link"
                    },
                    {
                        "id": "timeline-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\u23f1\ufe0f 时间分析",
                        "subTarget": "timeline",
                        "style": "link"
                    },
                    {
                        "id": "mitre-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udee1\ufe0f ATT&CK 映射",
                        "subTarget": "mitre",
                        "style": "link"
                    },
                    {
                        "id": "response-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udea8 响应与缓解",
                        "subTarget": "response",
                        "style": "link"
                    },
                    {
                        "id": "model-inventory-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udce6 模型清单",
                        "subTarget": "model_inventory",
                        "style": "link"
                    },
                    {
                        "id": "data-governance-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udd12 数据治理",
                        "subTarget": "data_governance",
                        "style": "link"
                    },
                    {
                        "id": "red-team-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83c\udfaf 红队测试",
                        "subTarget": "red_team",
                        "style": "link"
                    },
                    {
                        "id": "multimodal-ai-tab",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83c\udfa8 多模态AI威胁",
                        "subTarget": "multimodal_ai",
                        "style": "link"
                    }
                ]
            },
            "name": "navigation_tabs",
            "id": "313cfe3f-fb2f-464b-9768-b3273e0cb895"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background:linear-gradient(90deg,#8B0000,#B22222);padding:10px;border-radius:6px;color:white;\"><h2 style=margin:0;>\ud83c\udfaf AI红队测试与对抗验证</h2><p style=margin:4px 0 0 0;font-size:12px;opacity:.85;>集成 garak、PromptInject 与 OWASP LLM Top 10 攻击基线，结合实时告警评估模型暴露面。</p></div>"
                        },
                        "name": "red_team_header",
                        "id": "c3037bd5-857b-4938-90e3-31cce73dc2fe"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let attackIndicators = dynamic(['prompt injection','jailbreak','dan','gcg','encoding','glitch','adversarial','poison','backdoor','exfiltration','model steal','extraction','inversion','membership','hallucination','xss','ssrf','data leak','token reuse','api abuse']);\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where tostring(AlertName) has_any (attackIndicators) or tostring(Description) has_any (attackIndicators)\n| extend AttackVector = case(\n    AlertName has 'prompt' or AlertName has 'injection', ' Prompt Injection',\n    AlertName has 'jailbreak' or Description has 'jailbreak', ' Jailbreak',\n    AlertName has 'poison' or Description has 'poison', ' Model Poisoning',\n    AlertName has 'backdoor', ' Backdoor',\n    AlertName has 'exfiltration' or Description has 'exfiltration', ' Data Exfiltration',\n    AlertName has 'steal' or Description has 'model steal' or Description has 'extraction', ' Model Extraction',\n    AlertName has 'inversion' or Description has 'inversion', ' Model Inversion',\n    AlertName has 'membership' or Description has 'membership', ' Membership Inference',\n    AlertName has 'adversarial' or Description has 'evasion', ' Adversarial Evasion',\n    AlertName has 'hallucination', ' Hallucination',\n    AlertName has 'api' and AlertName has 'abuse', ' API Abuse',\n    ' Other'\n)\n| summarize Alerts=count(), High=countif(Alert严重级别=='High'), Medium=countif(Alert严重级别=='Medium'), Low=countif(Alert严重级别=='Low'), LastSeen=max(TimeGenerated) by AttackVector\n| extend RiskScore = High*5 + Medium*2 + Low\n| project ['攻击向量']=AttackVector,['告警数量']=Alerts,['高严重']=High,['中严重']=Medium,['低严重']=Low,['风险评分']=RiskScore,['最后发现']=format_datetime(LastSeen,'MM-dd HH:mm')\n| order by ['风险评分'] desc",
                            "size": 0,
                            "title": "\ud83c\udfaf AI攻击向量分析",
                            "visualization": "table",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "20",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "10",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "5",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "高严重",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "中严重",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "低严重",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "red_team_attack_surface",
                        "id": "c71aa084-29f8-4f96-9fb2-5d8206dcedc9"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 多阶段攻击链检测\nlet window=24h;\nSecurityAlert\n| where TimeGenerated > ago(30d)\n| extend AlertNameLower = tolower(AlertName), DescriptionLower = tolower(Description)\n| where AlertNameLower has_any ('prompt','inject','jailbreak','steal','extract','poison','exfiltration','ai','model','copilot') or\n        DescriptionLower has_any ('prompt','inject','jailbreak','steal','extract','poison','exfiltration','ai','model')\n| extend BaseEntity = coalesce(\n    CompromisedEntity, \n    tostring(parse_json(tostring(Entities))[0].Name),\n    tostring(parse_json(tostring(Entities))[0].HostName),\n    'Unknown'\n)\n| where BaseEntity != 'Unknown'\n| summarize \n    Stages = make_set(AlertName), \n    FirstSeen=min(TimeGenerated), \n    LastSeen=max(TimeGenerated), \n    AlertCount=count(),\n    严重级别List = make_set(Alert严重级别),\n    High严重级别Count = countif(Alert严重级别 == \"High\")\n  by BaseEntity\n| extend StageCount=array_length(Stages)\n| extend DurationHours = datetime_diff('hour', LastSeen, FirstSeen)\n| where StageCount >= 2 or AlertCount >= 3\n| extend AttackComplexity = case(\n    StageCount >= 4, \"\ud83d\udd25 Complex Multi-Stage Attack\",\n    StageCount >= 3, \"\ud83d\udd34 Advanced Attack Chain\",\n    StageCount >= 2, \"\ud83d\udfe0 Two-Stage Attack\",\n    \"\ud83d\udfe1 Single-Stage\"\n)\n| project \n    ['目标实体']=BaseEntity,\n    ['攻击复杂度']=AttackComplexity,\n    ['攻击阶段']=StageCount,\n    ['告警总数']=AlertCount,\n    ['高严重 Alerts']=High严重级别Count,\n    ['持续时间（小时）']=DurationHours,\n    ['阶段集合']=tostring(Stages),\n    ['首次发现']=format_datetime(FirstSeen,'MM-dd HH:mm'),\n    ['最后发现']=format_datetime(LastSeen,'MM-dd HH:mm')\n| order by ['攻击阶段'] desc, ['告警总数'] desc\n| take 50",
                            "size": 0,
                            "title": "\ud83c\udfaf 多阶段攻击链检测",
                            "visualization": "table",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces"
                        },
                        "name": "red_team_multistage",
                        "id": "f2d1e379-fa3c-4f39-adb8-1c7dfc79b36e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI安全测试与漏洞评估\n// Tracks AI-related security alerts that indicate testing and vulnerability findings\n// Uses SecurityAlert table for actual security test results and findings\nlet t0 = {TimeRange:start};\nSecurityAlert\n| where TimeGenerated > t0\n| where AlertName has_any (\"Test\", \"Vulnerability\", \"Jailbreak\", \"Prompt\", \"Injection\", \"Exploit\", \"Weakness\", \"Security\")\n       or Description has_any (\"test\", \"vulnerability\", \"security assessment\", \"penetration\", \"red team\")\n| extend\n    TestType = case(\n        AlertName has \"Jailbreak\" or Description has \"jailbreak\", \" Jailbreak Test\",\n        AlertName has \"Prompt\" and AlertName has \"Injection\", \" Prompt Injection Test\",\n        AlertName has \"Exploit\" or AlertName has \"Vulnerability\", \" Vulnerability Test\",\n        AlertName has \"Security\", \" Security Assessment\",\n        AlertName has \"Penetration\" or Description has \"pen test\", \" Penetration Test\",\n        \"? General Security Test\"\n    ),\n    TestResult = case(\n        Status == \"Resolved\", \"? 已缓解\",\n        Status == \"Dismissed\", \" Accepted Risk\",\n        Status == \"InProgress\", \" In Progress\",\n        Status == \"New\", \" New Finding\",\n        \"? Unknown\"\n    ),\n    VulnerabilityFound = Status in (\"New\", \"InProgress\"),\n    严重级别 = Alert严重级别,\n    Tester = coalesce(CompromisedEntity, \"Security Team\")\n| extend\n    TargetModel = coalesce(tostring(parse_json(tostring(Entities))[0]), \"AI System\")\n| summarize\n    TotalTests = count(),\n    已缓解Tests = countif(TestResult == \"? 已缓解\"),\n    ActiveFindings = countif(TestResult in (\" New Finding\", \" In Progress\")),\n    AcceptedRisks = countif(TestResult == \" Accepted Risk\"),\n    漏洞Found = countif(VulnerabilityFound == true),\n    High严重级别Count = countif(严重级别 == \"High\"),\n    Medium严重级别Count = countif(严重级别 == \"Medium\"),\n    Low严重级别Count = countif(严重级别 == \"Low\"),\n    FirstTest = min(TimeGenerated),\n    LastTest = max(TimeGenerated)\n  by TestType\n| extend\n    MitigationRate = round((todouble(已缓解Tests) / todouble(TotalTests)) * 100, 1),\n    VulnerabilityRate = round((todouble(ActiveFindings) / todouble(TotalTests)) * 100, 1),\n    RiskScore = (High严重级别Count * 5) + (Medium严重级别Count * 3) + (Low严重级别Count * 1)\n| extend SecurityPosture = case(\n    VulnerabilityRate >= 50 or High严重级别Count >= 5, \" Critical - Immediate Action Required\",\n    VulnerabilityRate >= 30 or High严重级别Count >= 3, \" High Risk - Remediation Needed\",\n    VulnerabilityRate >= 10 or High严重级别Count >= 1, \" Medium Risk - Review Required\",\n    MitigationRate >= 70, \" Good - Continue Monitoring\",\n    \"? Baseline - Needs More Testing\"\n)\n| project\n    ['测试类型'] = TestType,\n    ['安全态势'] = SecurityPosture,\n    ['测试总数'] = TotalTests,\n    ['缓解率 %'] = MitigationRate,\n    ['活跃发现 %'] = VulnerabilityRate,\n    ['风险评分'] = RiskScore,\n    ['已缓解'] = 已缓解Tests,\n    ['活跃问题'] = ActiveFindings,\n    ['已接受风险'] = AcceptedRisks,\n    ['漏洞'] = 漏洞Found,\n    ['高严重'] = High严重级别Count,\n    ['中严重'] = Medium严重级别Count,\n    ['低严重'] = Low严重级别Count,\n    ['首次测试'] = format_datetime(FirstTest, 'MM-dd HH:mm'),\n    ['最后测试'] = format_datetime(LastTest, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['活跃发现 %'] desc",
                            "size": 0,
                            "title": "\ud83c\udfaf AI安全测试与漏洞评估",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "安全态势",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High Risk",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium Risk",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Good",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Baseline",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Pass Rate %",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "Vulnerability Rate %",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "redGreen"
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "高严重",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "漏洞",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "filter": true,
                                "rowLimit": 50
                            }
                        },
                        "name": "ai_foundry_red_team"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI安全漏洞发现与修复优先级\n// Detailed breakdown of AI安全 漏洞 and their remediation status\n// Uses SecurityAlert table for actual vulnerability findings\nlet t0 = {TimeRange:start};\nSecurityAlert\n| where TimeGenerated > t0\n| where AlertName has_any (\"Vulnerability\", \"Jailbreak\", \"Prompt\", \"Injection\", \"Weakness\", \"Exploit\", \"Risk\")\n| extend\n    FindingType = case(\n        AlertName has \"Jailbreak\", \" Jailbreak Vulnerability\",\n        AlertName has \"Prompt\" and AlertName has \"Injection\", \" Prompt Injection Weakness\",\n        Description has \"Bias\" or AlertName has \"Bias\", \" Bias Detection\",\n        Description has \"Toxic\" or AlertName has \"Toxic\", \" Toxicity Issue\",\n        Description has \"Hallucination\" or AlertName has \"Hallucination\", \" Hallucination Risk\",\n        Description has \"Leak\" or AlertName has \"Leak\", \" Data Leakage\",\n        Description has \"Unauthorized\" or AlertName has \"Unauthorized\", \" Unauthorized Access\",\n        \" Other Vulnerability\"\n    ),\n    Vulnerability严重级别 = Alert严重级别,\n    Details = substring(Description, 0, 100)\n| extend\n    ModelName = coalesce(tostring(parse_json(tostring(Entities))[0]), \"AI System\")\n| summarize\n    FindingCount = count(),\n    CriticalCount = countif(Vulnerability严重级别 == \"High\"),\n    HighCount = countif(Vulnerability严重级别 == \"Medium\"),\n    MediumCount = countif(Vulnerability严重级别 == \"Low\"),\n    ResolvedCount = countif(Status == \"Resolved\"),\n    ActiveCount = countif(Status in (\"New\", \"InProgress\")),\n    AffectedSystems = make_set(ModelName, 5),\n    SampleDetails = make_set(Details, 2),\n    FirstFound = min(TimeGenerated),\n    LastFound = max(TimeGenerated)\n  by FindingType, Vulnerability严重级别\n| extend\n    UrgencyScore = (CriticalCount * 5) + (HighCount * 3) + (MediumCount * 2) + ActiveCount,\n    RemediationRate = round((todouble(ResolvedCount) / todouble(FindingCount)) * 100, 1)\n| extend Remediation优先级 = case(\n    UrgencyScore >= 20, \" P0 - Immediate\",\n    UrgencyScore >= 10, \" P1 - Urgent\",\n    UrgencyScore >= 5, \" P2 - High 优先级\",\n    \" P3 - Normal\"\n)\n| project\n    ['修复优先级'] = Remediation优先级,\n    ['发现类型'] = FindingType,\n    ['严重级别'] = Vulnerability严重级别,\n    ['紧急评分'] = UrgencyScore,\n    ['发现总数'] = FindingCount,\n    ['严重/高'] = CriticalCount,\n    ['Medium'] = HighCount,\n    ['Low'] = MediumCount,\n    ['活跃问题'] = ActiveCount,\n    ['Resolved'] = ResolvedCount,\n    ['修复率 %'] = RemediationRate,\n    ['受影响系统'] = tostring(AffectedSystems),\n    ['样例详情'] = tostring(SampleDetails),\n    ['首次发现'] = format_datetime(FirstFound, 'MM-dd HH:mm'),\n    ['最后发现'] = format_datetime(LastFound, 'MM-dd HH:mm')\n| order by ['紧急评分'] desc, ['发现总数'] desc",
                            "size": 0,
                            "title": "\ud83d\udd0d AI安全漏洞发现与修复优先级",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "修复优先级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "P0",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "P1",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "P2",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "P3",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "紧急评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Critical",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "High",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "red_team_findings"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI模型安全评估与告警覆盖\n// Evaluates AI模型 安全态势 based on security alerts\nSecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has_any (\"AI\", \"Model\", \"Prompt\", \"Jailbreak\", \"Injection\", \"GPT\", \"Copilot\", \"OpenAI\", \"Cognitive\", \"Chat\", \"LLM\")\n   or CompromisedEntity has_any (\"AI\", \"Model\", \"GPT\", \"Copilot\", \"OpenAI\", \"Cognitive\", \"Chat\")\n   or Description has_any (\"AI\", \"Model\", \"Prompt\", \"GPT\", \"Copilot\")\n| extend\n    ModelName = case(\n        CompromisedEntity has \"gpt\" or AlertName has \"gpt\", \"GPT Models\",\n        CompromisedEntity has \"copilot\" or AlertName has \"copilot\", \"Microsoft Copilot\",\n        CompromisedEntity has \"openai\" or AlertName has \"openai\", \"Azure OpenAI\",\n        CompromisedEntity has \"cognitive\" or AlertName has \"cognitive\", \"Azure Cognitive Services\",\n        AlertName has \"Chat\" or CompromisedEntity has \"chat\", \"Chat AI Services\",\n        AlertName has \"LLM\", \"LLM Services\",\n        \"Other AI模型\"\n    )\n| extend\n    Is已缓解 = Status in (\"Resolved\", \"Dismissed\"),\n    IsActive = Status in (\"New\", \"InProgress\", \"Active\")\n| summarize\n    TotalAlerts = count(),\n    已缓解 = countif(Is已缓解),\n    ActiveFindings = countif(IsActive),\n    CriticalCount = countif(Alert严重级别 == \"Critical\"),\n    HighCount = countif(Alert严重级别 == \"High\"),\n    MediumCount = countif(Alert严重级别 == \"Medium\"),\n    LastAlert = max(TimeGenerated)\n  by ModelName\n| extend\n    MitigationRate = round((todouble(已缓解) / todouble(TotalAlerts)) * 100, 1),\n    AlertAge = datetime_diff('day', now(), LastAlert)\n| extend\n    SafetyScore = case(\n        MitigationRate >= 95 and CriticalCount == 0, 95,\n        MitigationRate >= 90 and CriticalCount == 0, 85,\n        MitigationRate >= 80 and CriticalCount <= 1, 75,\n        MitigationRate >= 70 and CriticalCount <= 2, 60,\n        MitigationRate >= 50, 40,\n        20\n    ),\n    SafetyGrade = case(\n        MitigationRate >= 95 and CriticalCount == 0, \"\u2705 A - Excellent\",\n        MitigationRate >= 90 and CriticalCount == 0, \"\ud83d\udfe2 B - Good\",\n        MitigationRate >= 80 and CriticalCount <= 1, \"\ud83d\udfe1 C - Fair\",\n        MitigationRate >= 70 and CriticalCount <= 2, \"\ud83d\udfe0 D - Needs Improvement\",\n        \"\ud83d\udd34 F - Critical Issues\"\n    ),\n    TestingStatus = case(\n        AlertAge <= 7, \"\u2705 Recently Monitored\",\n        AlertAge <= 30, \"\u26a0\ufe0f Review Soon\",\n        AlertAge <= 90, \"\ud83d\udfe0 Needs Attention\",\n        \"\ud83d\udd34 Critical - No Recent Activity\"\n    )\n| project\n    ['模型名称'] = ModelName,\n    ['安全等级'] = SafetyGrade,\n    ['安全评分'] = SafetyScore,\n    ['测试状态'] = TestingStatus,\n    ['告警总数'] = TotalAlerts,\n    ['缓解率 %'] = MitigationRate,\n    ['已缓解'] = 已缓解,\n    ['Active'] = ActiveFindings,\n    ['Critical'] = CriticalCount,\n    ['High'] = HighCount,\n    ['距上次告警天数'] = AlertAge,\n    ['最后告警'] = format_datetime(LastAlert, 'MM-dd HH:mm')\n| order by ['安全评分'] asc, ['距上次告警天数'] desc",
                            "size": 0,
                            "title": "\ud83d\udee1\ufe0f AI模型安全评估与告警覆盖",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "安全等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "F -",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "A",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "B",
                                                    "representation": "lightBlue"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "C",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "D",
                                                    "representation": "orange"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "安全评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "测试状态",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Recently",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Soon",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Overdue",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Pass Rate %",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "Failed",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "model_safety_scores"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "red_team"
            },
            "name": "red_team_group",
            "id": "73854fc1-89bd-44d1-9ed5-13df4b7a0870"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #0078D4, #004E8C); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udcca AI安全 概览仪表板</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图提供企业AI安全态势的360度全景视角。通过关联安全事件、威胁趋势和关键指标，帮助安全团队理解整体AI风险暴露、定位紧急问题并优先响应。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0f6ff; padding: 10px; border-left: 4px solid #0078D4; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83d\udd0d 实时监控</h4>\n    <p style=\"font-size: 13px; color: #333;\">基于最近30天数据的AI安全威胁实时态势感知</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0f6ff; padding: 10px; border-left: 4px solid #0078D4; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #0078D4;\">\ud83d\udcc8 趋势分析</h4>\n    <p style=\"font-size: 13px; color: #333;\">通过时间序列洞察揭示威胁轨迹与异常模式</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "overview_header",
                        "id": "eb5c53dc-36f5-41eb-990d-51e764387400"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI安全 KPI summary - Simplified and Enhanced\nlet aiKeywords = dynamic([\n    \"Model\", \"Prompt\", \"AI\", \"Copilot\", \"Jailbreak\", \"Injection\", \"GPT\", \"Claude\",\n    \"LLM\", \"Prompt Injection\", \"Training Data Poisoning\", \"Model Denial\", \n    \"Adversarial\", \"Poisoning\", \"Backdoor\", \"Evasion\", \"Model Stealing\"\n]);\n\n// Core threat statistics\nlet threatStats = SecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has_any (aiKeywords)\n| summarize \n    TotalAlerts = count(),\n    CriticalAlerts = countif(Alert严重级别 == \"Critical\"),\n    HighAlerts = countif(Alert严重级别 == \"High\"),\n    MediumAlerts = countif(Alert严重级别 == \"Medium\"),\n    UniqueThreats = dcount(AlertName),\n    AffectedEntities = dcount(CompromisedEntity)\n| extend \n    RiskScore = CriticalAlerts * 10 + HighAlerts * 5 + MediumAlerts * 2;\n\n// 活跃事件\nlet incidentStats = SecurityIncident\n| where TimeGenerated > ago(30d)\n| where Title has_any (aiKeywords)\n| summarize \n    TotalIncidents = count(),\n    ActiveIncidents = countif(Status in (\"New\", \"Active\")),\n    Avg严重级别 = avg(case(严重级别 == \"High\", 3, 严重级别 == \"Medium\", 2, 1));\n\n// AI user activity\nlet userStats = SigninLogs\n| where TimeGenerated > ago(7d)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\", \"openai\")\n| summarize \n    ActiveAIUsers = dcount(UserPrincipalName),\n    FailedSignins = countif(ResultType != 0),\n    SuccessRate = round(todouble(countif(ResultType == 0)) / todouble(count()) * 100, 1);\n\n// Consolidated dashboard\nthreatStats\n| extend \n    TotalIncidents = toscalar(incidentStats | project TotalIncidents),\n    ActiveIncidents = toscalar(incidentStats | project ActiveIncidents),\n    ActiveAIUsers = toscalar(userStats | project ActiveAIUsers),\n    FailedSignins = toscalar(userStats | project FailedSignins),\n    SuccessRate = toscalar(userStats | project SuccessRate)\n| project \n    ['指标'] = \"\ud83d\udcca AI安全概览（近30天）\",\n    ['\ud83d\udea8 告警总数'] = TotalAlerts,\n    ['\ud83d\udd25 Critical'] = CriticalAlerts,\n    ['\ud83d\udd34 High'] = HighAlerts,\n    ['\ud83d\udccb 活跃事件'] = ActiveIncidents,\n    ['\ud83c\udfaf 唯一威胁数'] = UniqueThreats,\n    ['\ud83d\udc65 活跃AI用户（7天）'] = ActiveAIUsers,\n    ['\u26a0\ufe0f 失败登录'] = FailedSignins,\n    ['\ud83d\udcaf 成功率 %'] = SuccessRate,\n    ['\ufffd 风险评分'] = RiskScore",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "\ud83d\udea8 Total AI Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "\ud83d\udd25 High-严重级别 Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "\ud83d\udccb 活跃事件",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "\ud83d\udc65 AI Users",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "\ud83d\udcca 风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "kpi_指标s_fixed",
                        "id": "248e69ac-9d63-4180-a7e9-d8fad2294ee6"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "overview"
            },
            "name": "overview_group",
            "id": "dec3a24e-434c-44c1-ab6e-d4badac16fd6"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "## \ud83d\udcca AI安全趋势分析\n---"
                        },
                        "name": "trend_header",
                        "id": "de81170e-afeb-4fe7-bc05-974ad0d8758a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Top AI安全威胁 - Real-time Detection\nlet aiKeywords = dynamic([\"Model\", \"Prompt\", \"AI\", \"Copilot\", \"Jailbreak\", \"Injection\", \"LLM\"]);\n\nSecurityAlert\n| where TimeGenerated > ago(7d)\n| where AlertName has_any (aiKeywords)\n| extend \n    ThreatCategory = case(\n        AlertName has \"Prompt\" or AlertName has \"Injection\", \"\ud83c\udfaf Prompt Injection\",\n        AlertName has \"Jailbreak\" or AlertName has \"Bypass\", \"\ud83d\udd13 Jailbreak Attack\",\n        AlertName has \"Model\" and AlertName has \"Poison\", \"\u2620\ufe0f Model Poisoning\",\n        AlertName has \"Exfiltration\" or AlertName has \"Leak\", \"\ud83d\udce4 Data Exfiltration\",\n        AlertName has \"Copilot\", \"\ud83d\udcbc Copilot Misuse\",\n        AlertName has \"Unauthorized\", \"\ud83d\udeab Unauthorized Access\",\n        \"\u26a0\ufe0f Other AI Threats\"\n    ),\n    严重级别Level = case(\n        Alert严重级别 == \"Critical\", \"\ud83d\udd25 Critical\",\n        Alert严重级别 == \"High\", \"\ud83d\udd34 High\",\n        Alert严重级别 == \"Medium\", \"\ud83d\udfe0 Medium\",\n        \"\ud83d\udfe1 Low\"\n    )\n| summarize \n    ['告警数量'] = count(),\n    ['受影响实体'] = dcount(CompromisedEntity),\n    ['严重级别'] = max(严重级别Level),\n    ['最后检测'] = max(TimeGenerated)\n  by ['威胁类型'] = ThreatCategory\n| project \n    ['威胁类型'],\n    ['告警数量'],\n    ['严重级别'],\n    ['受影响实体'],\n    ['最后检测'] = format_datetime(['最后检测'], 'MM-dd HH:mm')\n| order by ['告警数量'] desc\n| take 10",
                            "size": 0,
                            "title": "\ud83c\udfaf AI安全威胁榜（近7天）",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "告警数量",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "受影响实体",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "threat_trend",
                        "id": "da865daf-23b6-4a12-a165-ea66f8e3b34f"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI Application Usage by 服务类型\nSigninLogs\n| where TimeGenerated > ago(7d)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\", \"openai\", \"claude\", \"azure\")\n| extend \n    ServiceType = case(\n        AppNameLower has \"copilot\", \"\ud83d\udcbc Microsoft Copilot\",\n        AppNameLower has \"chat\" or AppNameLower has \"gpt\", \"\ud83d\udcac Chat Services\",\n        AppNameLower has \"openai\", \"\ud83e\udd16 OpenAI Services\",\n        AppNameLower has \"azure\" and AppNameLower has \"ai\", \"\u2601\ufe0f Azure AI\",\n        AppNameLower has \"cognitive\", \"\ud83e\udde0 Cognitive Services\",\n        \"\ud83d\udd27 Other AI Services\"\n    )\n| summarize \n    UserCount = dcount(UserPrincipalName),\n    TotalSessions = count(),\n    SuccessRate = round(todouble(countif(ResultType == 0)) / todouble(count()) * 100, 1),\n    FailedAttempts = countif(ResultType != 0)\n  by ServiceType\n| extend \n    UsageLevel = case(\n        TotalSessions >= 1000, \"\ud83d\udd25 非常高\",\n        TotalSessions >= 500, \"\ud83d\udd34 High\",\n        TotalSessions >= 100, \"\ud83d\udfe0 Medium\",\n        \"\ud83d\udfe2 Low\"\n    )\n| project \n    ['服务类型'] = ServiceType,\n    ['使用等级'] = UsageLevel,\n    ['用户数'] = UserCount,\n    ['总会话数'] = TotalSessions,\n    ['成功率 %'] = SuccessRate,\n    ['失败尝试'] = FailedAttempts\n| order by ['总会话数'] desc",
                            "size": 0,
                            "title": "\ud83d\udcca AI应用使用分布（近7天）",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "使用等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "总会话数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "成功率 %",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "失败尝试",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "严重级别_distribution",
                        "id": "9d14291e-383e-401c-8447-542c6c991f8c"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "overview"
            },
            "name": "overview_trend_group",
            "id": "b81bd757-1da0-463e-8814-9180c7e340c0"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #dc3545, #b02a37); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udd25 AI 威胁监控</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图聚焦AI安全威胁的深度检查，实时跟踪AI专用告警、模型风险与攻击链，提供可执行的威胁情报，帮助安全团队快速响应AI事件。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #fdf2f2; padding: 10px; border-left: 4px solid #dc3545; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #dc3545;\">\ud83d\udd25 威胁检测</h4>\n    <p style=\"font-size: 13px;\">实时识别越狱、提示注入、模型投毒及新兴AI威胁</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #fdf2f2; padding: 10px; border-left: 4px solid #dc3545; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #dc3545;\">\ud83d\udd25 风险评估</h4>\n    <p style=\"font-size: 13px;\">使用 MITRE ATT&CK 框架分析攻击链与高风险AI模型</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "threat_header",
                        "id": "4e879f7c-9996-49e5-8025-81824a2dd6f1"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Latest AI安全 威胁事件 (field reference update)\nSecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has \"Model\" or AlertName has \"Prompt\" or AlertName has \"AI\" or AlertName has \"Copilot\" or AlertName has \"Jailbreak\" or AlertName has \"Injection\"\n| extend \n    严重级别Icon = case(\n        Alert严重级别 == \"High\", \"\ud83d\udd34\",\n        Alert严重级别 == \"Medium\", \"\ud83d\udfe0\",\n        Alert严重级别 == \"Low\", \"\ud83d\udfe1\",\n        \"\u26aa\"\n    ),\n    StatusIcon = case(\n        Status == \"New\", \"\ud83c\udd95\",\n        Status == \"InProgress\", \"\u23f3\",\n        Status == \"Resolved\", \"\u2705\",\n        Status == \"Dismissed\", \"\u274c\",\n        \"\u26aa\"\n    ),\n    ThreatType = case(\n        AlertName has \"Prompt\", \"\ud83d\udc89 Prompt Injection\",\n        AlertName has \"Jailbreak\", \"\ud83d\udea8 Jailbreak Attack\",\n        AlertName has \"Model\", \"\ud83e\udd16 Model Threat\",\n        AlertName has \"Copilot\", \"\ud83e\udd1d Copilot Misuse\",\n        AlertName has \"Injection\", \"\ud83d\udc89 Injection Attack\",\n        \"\u26a0\ufe0f Other Threats\"\n    )\n| extend\n    严重级别Display = strcat(严重级别Icon, \" \", Alert严重级别),\n    StatusDisplay = strcat(StatusIcon, \" \", Status),\n    SafeDescription = case(\n        isnotempty(Description) and strlen(Description) > 80, \n        strcat(substring(Description, 0, 77), \"...\"),\n        coalesce(Description, \"No description\")\n    ),\n    // Preserve original timestamp for ordering\n    OriginalTime = TimeGenerated\n| project \n    ['Time'] = format_datetime(TimeGenerated, 'MM-dd HH:mm'),\n    ['严重级别'] = 严重级别Display,\n    ['威胁类型'] = ThreatType,\n    ['告警名称'] = AlertName,\n    ['目标实体'] = coalesce(CompromisedEntity, \"Unknown\"),\n    ['Status'] = StatusDisplay,\n    ['Description'] = SafeDescription,\n    OriginalTime\n| order by OriginalTime desc\n| project-away OriginalTime\n| take 20",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Time",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "recent_threats",
                        "id": "72d05174-3d95-4ad9-b834-756121d437c9"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "##  高风险AI模型监控\n---"
                        },
                        "name": "model_header",
                        "id": "844532da-d2c4-46df-9775-6987bfc81eca"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 高风险AI模型分析 (updated)\nSecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has_any (\"Model\", \"AI\", \"Copilot\")\n| extend ModelName = coalesce(\n    tostring(parse_json(ExtendedProperties)[\"模型名称\"]),\n    tostring(parse_json(ExtendedProperties)[\"ModelName\"]),\n    extract(@\"Model:\\s*([^,\\]]+)\", 1, Description),\n    \"Unknown Model\"\n)\n| where ModelName != \"Unknown Model\"\n| summarize \n    AlertCount = count(),\n    HighAlerts = countif(Alert严重级别 == \"High\"),\n    MediumAlerts = countif(Alert严重级别 == \"Medium\"),\n    LowAlerts = countif(Alert严重级别 == \"Low\"),\n    LastAlert = max(TimeGenerated),\n    UniqueAlertTypes = dcount(AlertName),\n    ThreatTypes = make_set(AlertName, 3)\n  by ModelName\n| extend\n    // Directly compute 风险评分 to avoid type conversions\n    CalculatedRiskScore = HighAlerts * 3 + MediumAlerts * 2 + LowAlerts * 1,\n    RiskLevel = case(\n        HighAlerts >= 10, \"\ud83d\udd25 Critical\",\n        HighAlerts >= 5, \"\ud83d\udd34 High\",\n        HighAlerts > 0 or MediumAlerts >= 10, \"\ud83d\udfe0 Medium\",\n        \"\ud83d\udfe2 Low\"\n    )\n| project \n    ['AI模型'] = ModelName,\n    ['风险等级'] = RiskLevel,\n    ['风险评分'] = CalculatedRiskScore,\n    ['告警总数'] = AlertCount,\n    ['High-严重级别 Alerts'] = HighAlerts,\n    ['Medium-严重级别 Alerts'] = MediumAlerts,\n    ['威胁多样性'] = UniqueAlertTypes,\n    ['最近告警'] = format_datetime(LastAlert, 'MM-dd HH:mm'),\n    ['主要威胁'] = tostring(ThreatTypes)\n| order by ['风险评分'] desc\n| take 15",
                            "size": 0,
                            "title": "\ud83e\udd16 高风险AI模型分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "15",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "10",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "5",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": ">=",
                                                    "thresholdValue": "1",
                                                    "representation": "lightBlue"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "告警总数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "High-严重级别 Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "model_risk",
                        "id": "930f988b-d1f7-4649-8658-23b09579c951"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI威胁杀伤链分布 (updated)\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Model\", \"Prompt\", \"AI\", \"Copilot\", \"Jailbreak\")\n| extend \n    AttackStage = case(\n        AlertName has \"Reconnaissance\" or AlertName has \"Discovery\", \" Reconnaissance\",\n        AlertName has \"Initial\" or AlertName has \"Access\", \" Initial Access\",\n        AlertName has \"Execution\" or AlertName has \"Command\", \"? Execution\",\n        AlertName has \"Persistence\", \" Persistence\",\n        AlertName has \"Privilege\" or AlertName has \"Escalation\", \" Privilege Escalation\",\n        AlertName has \"Defense\" or AlertName has \"Evasion\", \" Defense Evasion\",\n        AlertName has \"Credential\" or AlertName has \"Access\", \" Credential Access\",\n        AlertName has \"Discovery\" or AlertName has \"Collection\", \" Discovery & Collection\",\n        AlertName has \"Lateral\" or AlertName has \"Movement\", \" Lateral Movement\",\n        AlertName has \"Exfiltration\" or AlertName has \"Impact\", \" Exfiltration / Impact\",\n        \" Direct Attack\"\n    )\n| summarize StageCount = count() by AttackStage\n| project AttackStage, StageCount\n| order by StageCount desc",
                            "size": 2,
                            "title": "\u2694\ufe0f AI威胁杀伤链分布",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "piechart",
                            "chartSettings": {
                                "showLegend": true
                            }
                        },
                        "name": "attack_chain",
                        "id": "c9e35a33-ab85-4fee-b895-3eefdd3bd451"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "threat"
            },
            "name": "threat_group",
            "id": "b382c9d5-05ce-4b8c-9a88-27b652eba177"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #28a745, #1e7e34); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udcc8 AI 使用分析</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图通过跟踪用户行为、部门采用与应用分布来分析企业AI采用模式，帮助安全团队理解AI在组织内的渗透情况，并发现潜在影子IT或合规风险。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f1f8f4; padding: 10px; border-left: 4px solid #28a745; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #28a745;\">\ud83d\udcc8 使用指标</h4>\n    <p style=\"font-size: 13px; color: #333;\">监控部门采用、用户参与度与使用频率趋势</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f1f8f4; padding: 10px; border-left: 4px solid #28a745; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #28a745;\">\ud83d\udc64 用户画像</h4>\n    <p style=\"font-size: 13px; color: #333;\">识别重度用户、异常模式与潜在风险行为</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "usage_header",
                        "id": "a08d56e0-d1a4-449a-b8c7-0b318fdea49e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI应用部门采用热力图 (updated)\nlet userInfo = IdentityInfo\n| project UPN = tostring(AccountUPN), Department;\n\nlet aiApps = dynamic([\n    \"ChatGPT\", \"Microsoft 365 Copilot\", \"GitHub Copilot\", \n    \"Bing Chat Enterprise\", \"Azure OpenAI\", \"Claude\",\n    \"Google Bard\", \"Amazon CodeWhisperer\", \"Notion AI\"\n]);\n\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\", \"claude\", \"bard\", \"notion\")\n| join kind=inner (userInfo) on $left.UserPrincipalName == $right.UPN\n| extend Department = iif(isempty(Department), \"Unknown\", Department)\n| summarize \n    UniqueUsers = dcount(UserPrincipalName),\n    TotalLogins = count(),\n    LastUsed = max(TimeGenerated)\n  by Department, AppDisplayName\n| extend \n    UsageFrequency = round(todouble(TotalLogins) / todouble(UniqueUsers), 1),\n    UsageLevel = case(\n        UniqueUsers >= 50, \" 高采用\",\n        UniqueUsers >= 20, \"? 中等采用\",\n        UniqueUsers >= 5, \" 低采用\",\n        \" 试点阶段\"\n    )\n| project \n    ['Department'] = Department,\n    ['AI Application'] = AppDisplayName,\n    ['Users'] = UniqueUsers,\n    ['总登录次数'] = TotalLogins,\n    ['使用频率'] = UsageFrequency,\n    ['采用等级'] = UsageLevel,\n    ['最后使用'] = format_datetime(LastUsed, 'MM-dd HH:mm')\n| order by ['Users'] desc",
                            "size": 0,
                            "title": "\ud83c\udfe2 AI应用部门采用热力图",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Users",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "使用频率",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    }
                                ],
                                "hierarchySettings": {
                                    "treeType": 1,
                                    "groupBy": [
                                        "Department"
                                    ],
                                    "expandTopLevel": false
                                }
                            }
                        },
                        "name": "dept_adoption",
                        "id": "a00935ef-5f0b-4e7f-98cc-c55ed0553dd9"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI应用使用趋势\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\")\n| extend AIAppCategory = case(\n    AppNameLower has \"copilot\", \" Microsoft Copilot\",\n    AppNameLower has \"chatgpt\" or AppNameLower has \"gpt\", \" ChatGPT Family\",\n    AppNameLower has \"claude\", \" Claude\",\n    AppNameLower has \"bard\", \" Google Bard\",\n    \" Other AI Tools\"\n)\n| summarize Count = count() by bin(TimeGenerated, 1d), AIAppCategory\n| render timechart",
                            "size": 0,
                            "title": "\ud83d\udcc8 AI应用使用趋势",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "areachart",
                            "chartSettings": {
                                "showLegend": true
                            }
                        },
                        "name": "usage_trend",
                        "id": "dd34d9ee-af95-43cf-8af4-25e16f0655c4"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI高活跃用户分析\nlet userInfo = IdentityInfo\n| project UPN = tostring(AccountUPN), Department, JobTitle;\n\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\")\n| join kind=leftouter (userInfo) on $left.UserPrincipalName == $right.UPN\n| summarize \n    LoginCount = count(),\n    UniqueApps = dcount(AppDisplayName),\n    LastLogin = max(TimeGenerated),\n    AppsUsed = make_set(AppDisplayName, 5)\n  by UserPrincipalName, Department, JobTitle\n| extend \n    UserType = case(\n        LoginCount >= 100, \" Heavy User\",\n        LoginCount >= 50, \" Active User\",\n        LoginCount >= 20, \" Regular User\",\n        \" New User\"\n    )\n| project \n    ['User'] = UserPrincipalName,\n    ['Department'] = iif(isempty(Department), \"Unknown\", Department),\n    ['Job Title'] = iif(isempty(JobTitle), \"Unknown\", JobTitle),\n    ['User Type'] = UserType,\n    ['Sign-ins'] = LoginCount,\n    ['Applications Used'] = UniqueApps,\n    ['Last Sign-in'] = format_datetime(LastLogin, 'MM-dd HH:mm'),\n    ['Applications (Top 5)'] = tostring(AppsUsed)\n| order by ['Sign-ins'] desc\n| take 20",
                            "size": 0,
                            "title": "\ud83d\udc64 AI高活跃用户分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sign-ins",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "top_users",
                        "id": "86a451e9-b35e-4eec-9233-38fe1fbb2acb"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "usage"
            },
            "name": "usage_group",
            "id": "716b7142-89c3-4b2c-b46e-33a36fe574a2"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #ffc107, #e0a800); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udccb AI使用合规监控</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图聚焦AI应用的合规监控，分析企业AI策略遵循情况、数据隐私风险与未批准应用使用，确保组织AI采用与内外部要求一致，降低合规暴露。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #fffbf0; padding: 10px; border-left: 4px solid #ffc107; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #e0a800;\">\u2705 合规评估</h4>\n    <p style=\"font-size: 13px; color: #333;\">评估部门AI使用合规性，发现未授权应用或高风险行为。</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #fffbf0; padding: 10px; border-left: 4px solid #ffc107; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #e0a800;\">\ud83d\udd12 隐私防护</h4>\n    <p style=\"font-size: 13px; color: #333;\">监控AI工具中的敏感数据使用并提示潜在泄露风险。</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "compliance_header",
                        "id": "27efa3cd-a566-4052-9d6b-0eaf089d2f7c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 企业AI使用合规评分 (revised with relaxed criteria)\nlet userDept = IdentityInfo\n| project UPN = tostring(AccountUPN), Department = tostring(Department);\n\nSigninLogs\n| where TimeGenerated > ago(30d)\n| where isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n//  Fix 1: Broaden AI application detection\n| where AppNameLower has_any (\"copilot\", \"ai\", \"chat\", \"gpt\", \"cognitive\", \"openai\", \"bard\", \"claude\", \"assistant\")\n| join kind=leftouter (userDept) on $left.UserPrincipalName == $right.UPN\n| extend \n    //  Fix 2: More inclusive definition of approved applications\n    IsApproved = case(\n        AppDisplayName has_any (\"Microsoft\", \"Azure\", \"Copilot\", \"Bing Chat\", \"Office\", \"365\") or\n        AppDisplayName has_any (\"Security Copilot\", \"AI Studio\", \"Cognitive\"), \n        1, 0\n    ),\n    //  Fix 3: Refined definition for restricted applications\n    IsRestricted = case(\n        AppDisplayName has_any (\"ChatGPT\", \"Claude\", \"Google Bard\", \"Notion AI\", \"Jasper\") and\n        not (AppDisplayName has_any (\"Enterprise\", \"Business\", \"Microsoft\")), \n        1, 0\n    ),\n    //  Fix 4: Default department name when missing\n    DepartmentName = coalesce(Department, \"Unknown\")\n| summarize \n    TotalLogins = count(),\n    ApprovedLogins = sum(IsApproved),\n    RestrictedLogins = sum(IsRestricted),\n    UniqueUsers = dcount(UserPrincipalName)\n  by DepartmentName\n| extend \n    ComplianceRate = case(\n        TotalLogins > 0, round(todouble(ApprovedLogins) / todouble(TotalLogins) * 100.0, 1),\n        0.0\n    ),\n    ViolationRate = case(\n        TotalLogins > 0, round(todouble(RestrictedLogins) / todouble(TotalLogins) * 100.0, 1),\n        0.0\n    )\n| extend \n    ComplianceLevel = case(\n        ComplianceRate >= 90, \"\ud83d\udfe2 Excellent\",\n        ComplianceRate >= 70, \"\ud83d\udfe1 Good\",\n        ComplianceRate >= 50, \"\ud83d\udfe0 Needs Improvement\",\n        \"\ud83d\udd34 High Risk\"\n    )\n| order by ['ComplianceRate'] desc\n| project \n    ['Department'] = DepartmentName,\n    ['合规等级'] = ComplianceLevel,\n    ['合规率'] = strcat(tostring(ComplianceRate), \"%\"),\n    ['违规率'] = strcat(tostring(ViolationRate), \"%\"),\n    ['用户总数'] = UniqueUsers,\n    ['总登录次数'] = TotalLogins,\n    ['合规登录'] = ApprovedLogins,\n    ['Non-合规登录'] = RestrictedLogins",
                            "size": 0,
                            "title": "\u2705 企业AI使用合规评分",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "合规等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "合规率",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed",
                                            "aggregation": "Max"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "compliance_score",
                        "id": "a0025136-e8b5-46f2-90e7-657fd4e9754d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 数据隐私风险监控 (revised)\nlet sensitiveKeywords = dynamic([\"password\", \"ssn\", \"credit card\", \"personal\", \"confidential\", \"secret\", \"pii\", \"financial\", \"health\"]);\nlet aiKeywords = dynamic([\"AI\", \"Copilot\", \"ChatGPT\", \"Model\", \"Prompt\", \"OpenAI\", \"Claude\", \"Bard\"]);\n\n//  Fix 1: Expand data source coverage\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Data\", \"Privacy\", \"Leak\", \"Exfiltration\", \"Sensitive\", \"DLP\", \"Information\") or\n        Description has_any (sensitiveKeywords)\n| extend \n    IsAIRelated = iif(Description has_any (aiKeywords) or AlertName has_any (aiKeywords), true, false),\n    HasSensitiveData = iif(Description has_any (sensitiveKeywords) or AlertName has_any (sensitiveKeywords), true, false)\n| extend RiskCategory = case(\n    HasSensitiveData and IsAIRelated, \" High Risk - AI Sensitive Data\",\n    IsAIRelated, \" Medium Risk - AI Related\",\n    HasSensitiveData, \" Sensitive Data Exposure\",\n    \" General Data Risk\"\n)\n//  Fix 2: Do not limit to AI-only results; display all data risks\n| summarize \n    IncidentCount = count(),\n    HighRiskCount = countif(RiskCategory == \" High Risk - AI Sensitive Data\"),\n    LastIncident = max(TimeGenerated)\n  by bin(TimeGenerated, 1d), RiskCategory\n| render columnchart",
                            "size": 0,
                            "title": "\ud83d\udd12 数据隐私风险监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "barchart",
                            "chartSettings": {
                                "showLegend": true
                            }
                        },
                        "name": "privacy_risk",
                        "id": "67a4e771-92aa-499a-98eb-5ef3d9542262"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 未批准AI应用检测 (revised)\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n//  Fix 1: Expand search coverage with additional AI keywords\n| where AppDisplayName has_any (\"chat\", \"ai\", \"gpt\", \"claude\", \"bard\", \"jasper\", \"notion\", \"openai\", \"anthropic\", \"perplexity\") or\n        AppDisplayName contains \"AI\" or AppDisplayName contains \"Chat\" or AppDisplayName contains \"Assistant\"\n//  Fix 2: Exclude Microsoft-owned AI services\n| where not (AppDisplayName has_any (\"Microsoft\", \"Azure\", \"Bing Chat Enterprise\", \"Office\", \"365\", \"Security Copilot\"))\n| extend \n    Hour = datetime_part(\"hour\", TimeGenerated),\n    IsAfterHours = iif(datetime_part(\"hour\", TimeGenerated) < 8 or datetime_part(\"hour\", TimeGenerated) > 18, true, false)\n| extend \n    RiskLevel = case(\n        IsAfterHours, \" Used Outside Business Hours\",\n        \" Used During Business Hours\"\n    ),\n    //  Fix 3: Improved application categorization\n    AppCategory = case(\n        AppDisplayName has_any (\"ChatGPT\", \"OpenAI\"), \" ChatGPT Family\",\n        AppDisplayName has \"Claude\", \" Claude AI\",\n        AppDisplayName has \"Bard\", \" Google Bard\",\n        AppDisplayName has \"Notion\", \" Notion AI\",\n        AppDisplayName has \"Jasper\", \" Jasper AI\",\n        AppDisplayName has \"Perplexity\", \" Perplexity\",\n        \" Other AI Tools\"\n    )\n| summarize \n    LoginCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    AfterHoursCount = countif(IsAfterHours),\n    LastActivity = max(TimeGenerated)\n  by AppDisplayName, AppCategory, RiskLevel\n| project \n    ['Application Name'] = AppDisplayName,\n    ['Application Category'] = AppCategory,\n    ['风险等级'] = RiskLevel,\n    ['Sign-ins'] = LoginCount,\n    ['Users Involved'] = UniqueUsers,\n    ['After-hours Sign-ins'] = AfterHoursCount,\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm')\n| order by ['Sign-ins'] desc",
                            "size": 0,
                            "title": "\ud83d\udeab 未批准AI应用检测",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sign-ins",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "unauthorized_usage",
                        "id": "5518fc48-fdaa-4363-8d9f-5d5d7512f987"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Purview DLP Policy Violations for AI Data\n// Monitors Data Loss Prevention incidents involving AI applications\nlet t0 = {TimeRange:start};\nCloudAppEvents\n| where TimeGenerated > t0\n| where ActionType has_any (\"DlpRuleMatch\", \"DLPViolation\", \"PolicyMatch\")\n| where Application has_any (\"AI\", \"Copilot\", \"ChatGPT\", \"OpenAI\", \"Azure AI\") or \n        ObjectName has_any (\"model\", \"training\", \"dataset\", \"ai\", \"ml\")\n| extend\n    AIApp = case(\n        Application has \"Copilot\" or ActivityObjects has \"Copilot\", \"Microsoft Copilot\",\n        Application has \"Azure AI\" or ActivityObjects has \"Azure AI\", \"Azure AI Services\",\n        Application has \"OpenAI\" or ActivityObjects has \"OpenAI\", \"OpenAI\",\n        Application has \"ChatGPT\", \"ChatGPT\",\n        \"Other AI App\"\n    ),\n    ViolationType = case(\n        RawEventData has \"ConfidentialData\" or ActivityObjects has \"Confidential\", \"Confidential Data Shared\",\n        RawEventData has \"PII\" or ActivityObjects has \"PersonalData\", \"PII Exposure\",\n        RawEventData has \"FinancialData\", \"Financial Data Leak\",\n        RawEventData has \"HealthData\" or ActivityObjects has \"PHI\", \"Health Data Violation\",\n        \"General DLP Violation\"\n    ),\n    PolicyName = tostring(parse_json(RawEventData).PolicyName),\n    UserPrincipal = AccountDisplayName,\n    DeviceType = tostring(DeviceType)\n| summarize\n    ViolationCount = count(),\n    UniqueUsers = dcount(UserPrincipal),\n    UniqueDevices = dcount(DeviceType),\n    Policies = make_set(PolicyName, 5),\n    Users = make_set(UserPrincipal, 3),\n    FirstViolation = min(TimeGenerated),\n    LastViolation = max(TimeGenerated)\n  by AIApp, ViolationType\n| extend\n    RiskScore = ViolationCount * 2,\n    ComplianceStatus = case(\n        ViolationCount >= 10, \" Critical - Immediate Review\",\n        ViolationCount >= 5, \" High Risk - Action Needed\",\n        ViolationCount >= 2, \" Medium Risk - Monitor\",\n        \" Low Risk\"\n    )\n| project\n    ['AI Application'] = AIApp,\n    ['Violation Type'] = ViolationType,\n    ['Compliance Status'] = ComplianceStatus,\n    ['Total Violations'] = ViolationCount,\n    ['风险评分'] = RiskScore,\n    ['Unique Users'] = UniqueUsers,\n    ['Unique Devices'] = UniqueDevices,\n    ['DLP Policies'] = tostring(Policies),\n    ['Users Involved'] = tostring(Users),\n    ['First Violation'] = format_datetime(FirstViolation, 'MM-dd HH:mm'),\n    ['Last Violation'] = format_datetime(LastViolation, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['Total Violations'] desc",
                            "size": 0,
                            "title": "\ud83d\udd12 Purview DLP策略违规 - AI数据保护",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Compliance Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High Risk",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium Risk",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Low Risk",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Violations",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "purview_dlp_violations"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Entra ID - AI Application Access & Device Compliance\n// Lists non-compliant and risky devices accessing AI applications\nlet t0 = {TimeRange:start};\nSigninLogs\n| where TimeGenerated > t0\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"ChatGPT\", \"OpenAI\", \"Azure AI\", \"Agent\")\n| extend\n    DeviceName = tostring(DeviceDetail.displayName),\n    DeviceOS = tostring(DeviceDetail.operatingSystem),\n    DeviceTrust = tostring(DeviceDetail.trustType),\n    IsCompliant = tostring(DeviceDetail.isCompliant),\n    IsManaged = tostring(DeviceDetail.isManaged),\n    UserPrincipal = UserPrincipalName,\n    AppName = AppDisplayName,\n    UserLocation = Location,\n    UserIPAddress = IPAddress\n| extend\n    ComplianceStatus = case(\n        IsCompliant == \"true\" and IsManaged == \"true\", \"\u2705 Compliant & Managed\",\n        IsCompliant == \"true\" and IsManaged == \"false\", \"\u26a0\ufe0f Compliant but Unmanaged\",\n        IsCompliant == \"false\" and IsManaged == \"true\", \"\u274c Non-Compliant but Managed\",\n        IsCompliant == \"false\" and IsManaged == \"false\", \"\u274c Non-Compliant & Unmanaged\",\n        isempty(IsCompliant), \"\u26a0\ufe0f Unknown\",\n        \"\u26a0\ufe0f Other\"\n    ),\n    DeviceRisk = case(\n        IsCompliant == \"false\" and IsManaged == \"false\", \"\ud83d\udd34 Critical Risk\",\n        IsCompliant == \"false\" or IsManaged == \"false\", \"\ud83d\udfe0 High Risk\",\n        isempty(IsCompliant) or isempty(IsManaged), \"\ud83d\udfe1 Medium Risk - Unknown Status\",\n        \"\ud83d\udfe2 Low Risk\"\n    )\n| summarize\n    AccessCount = count(),\n    LastAccess = max(TimeGenerated),\n    FirstAccess = min(TimeGenerated),\n    Applications = make_set(AppName, 10),\n    Locations = make_set(UserLocation, 5),\n    IPAddresses = make_set(UserIPAddress, 5)\n  by DeviceName, DeviceOS, UserPrincipal, ComplianceStatus, DeviceRisk, IsCompliant, IsManaged, DeviceTrust\n| extend\n    RiskScore = case(\n        DeviceRisk == \"\ud83d\udd34 Critical Risk\", 100,\n        DeviceRisk == \"\ud83d\udfe0 High Risk\", 75,\n        DeviceRisk == \"\ud83d\udfe1 Medium Risk - Unknown Status\", 50,\n        25\n    )\n| project\n    ['Device Risk'] = DeviceRisk,\n    ['风险评分'] = RiskScore,\n    ['Device Name'] = DeviceName,\n    ['User'] = UserPrincipal,\n    ['Operating System'] = DeviceOS,\n    ['Compliance Status'] = ComplianceStatus,\n    ['Is Compliant'] = case(IsCompliant == \"true\", \"Yes\", IsCompliant == \"false\", \"No\", \"Unknown\"),\n    ['Is Managed'] = case(IsManaged == \"true\", \"Yes\", IsManaged == \"false\", \"No\", \"Unknown\"),\n    ['Trust Type'] = DeviceTrust,\n    ['Access Count'] = AccessCount,\n    ['AI Applications'] = tostring(Applications),\n    ['Access Locations'] = tostring(Locations),\n    ['IP Addresses'] = tostring(IPAddresses),\n    ['First Access'] = format_datetime(FirstAccess, 'MM-dd HH:mm'),\n    ['Last Access'] = format_datetime(LastAccess, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['Access Count'] desc",
                            "size": 0,
                            "title": "\ud83d\udcf1 Intune设备合规 - AI应用访问",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Compliance Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Review",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Low",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Non-Compliant",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "合规率 %",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "intune_device_compliance"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "compliance"
            },
            "name": "compliance_group",
            "id": "fbdb0a98-0d55-460b-ab38-5b06a6a455ae"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #fd7e14, #d63384); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\u26a0\ufe0f AI风险评估与预测</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值主张**: 构建多维AI风险评估框架，利用历史数据与机器学习预测新兴AI安全风险与威胁趋势，为安全团队提供前瞻性防护策略、优化资源配置并提升事件响应准备度。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #fff5f0; padding: 10px; border-left: 4px solid #fd7e14; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #fd7e14;\">\ud83d\udcca 风险矩阵</h4>\n    <p style=\"font-size: 13px; color: #333;\">使用多因子风险模型量化AI安全暴露</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #fff5f0; padding: 10px; border-left: 4px solid #fd7e14; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #fd7e14;\">\ud83d\udd2e 预测分析</h4>\n    <p style=\"font-size: 13px; color: #333;\">基于历史趋势预测未来威胁走向</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "risk_header",
                        "id": "1f2c0b2b-3eb0-4c62-b124-e14af0c99f21"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 多维AI风险评估矩阵 (real-time)\n// Extract and quantify risk dimensions from live alerts\nlet t0 = {TimeRange:start};\nlet weightTable = datatable(Factor:string, Weight:real, RiskCategory:string)[\n  'Prompt Injection', 0.25, 'Technical Threat',\n  'Model Access Violation', 0.20, 'Access Control',\n  'Data Exfiltration', 0.25, 'Data Security',\n  'Unauthorized Usage', 0.15, 'Compliance Risk',\n  'Compliance Violation', 0.15, 'Policy Risk'\n];\nlet alerts = SecurityAlert\n| where TimeGenerated > t0\n| project TimeGenerated, AlertName, Description, Alert严重级别, CompromisedEntity\n| extend SevWeight = case(Alert严重级别=='Critical',4, Alert严重级别=='High',3, Alert严重级别=='Medium',2, Alert严重级别=='Low',1, 0)\n| extend Factor = case(\n    AlertName has 'prompt' or Description has 'prompt' or AlertName has 'injection' or Description has 'injection' or AlertName has 'jailbreak' or Description has 'jailbreak', 'Prompt Injection',\n    AlertName has_any ('access','permission','token','key','credential','privilege') or Description has_any ('access','permission','token','key','credential','privilege'), 'Model Access Violation',\n    AlertName has_any ('exfiltration','leak','dlp') or Description has_any ('exfiltration','leak','dlp'), 'Data Exfiltration',\n    AlertName has_any ('unauthorized','unapproved','shadow') or Description has_any ('unauthorized','unapproved','shadow'), 'Unauthorized Usage',\n    AlertName has_any ('compliance','policy','gdpr','pii') or Description has_any ('compliance','policy','gdpr','pii'), 'Compliance Violation',\n    'Other'\n);\nlet perFactor = alerts\n| where Factor != 'Other'\n| summarize IncidentCount = count(), SevScore = sum(SevWeight), UniqueEntities = dcount(CompromisedEntity) by Factor\n| join kind=rightouter weightTable on Factor\n| extend DescriptionText = case(\n  Factor=='Prompt Injection','Prompt injection attack risk',\n  Factor=='Model Access Violation','Model access violation',\n  Factor=='Data Exfiltration','Data exfiltration risk',\n  Factor=='Unauthorized Usage','Unauthorized usage exposure',\n  Factor=='Compliance Violation','Compliance violation',\n  'Other'\n)\n| extend BaseScore = toint(coalesce(SevScore, 0))\n| extend WeightedScore = toreal(BaseScore) * Weight\n| extend RiskLevel = case(\n    WeightedScore >= 40, \"\ud83d\udd25 Critical\",\n    WeightedScore >= 20, \"\ud83d\udd34 High\",\n    WeightedScore >= 10, \"\ud83d\udfe0 Moderate\",\n    \"\ud83d\udfe2 Low\"\n)\n| extend WeightDisplay = strcat(tostring(toint(Weight * 100)), '%')\n| project \n  ['Risk Factor'] = Factor,\n  ['Weight'] = WeightDisplay,\n  ['Description'] = DescriptionText,\n  ['Risk Category'] = RiskCategory,\n  ['Base Score'] = BaseScore,\n  ['Weighted Score'] = round(WeightedScore, 2),\n  ['风险等级'] = RiskLevel;\nperFactor\n| union (\n  // Overall assessment aggregated from all factors\n  perFactor\n  | summarize TotalBase = toint(sum(['Base Score'])), TotalWeighted = sum(['Weighted Score'])\n  | extend ['Risk Factor'] = '\ud83d\udcca Overall 风险评分', ['Weight'] = '100%', ['Description'] = 'Aggregated view across all risk factors', ['Risk Category'] = 'Overall Assessment', ['Base Score'] = TotalBase, ['Weighted Score'] = round(TotalWeighted, 2), ['风险等级'] = case(TotalWeighted >= 40, \"\ud83d\udd25 Critical\", TotalWeighted >= 20, \"\ud83d\udd34 High\", TotalWeighted >= 10, \"\ud83d\udfe0 Moderate\", \"\ud83d\udfe2 Low\")\n  | project ['Risk Factor'], ['Weight'], ['Description'], ['Risk Category'], ['Base Score'], ['Weighted Score'], ['风险等级']\n)\n| order by ['Weighted Score'] desc",
                            "size": 0,
                            "title": "\ud83d\udcca 多维AI风险评估矩阵",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Weighted Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Base Score",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "risk_matrix",
                        "id": "eda839c9-a38b-45b2-90bb-4dc5895733e9"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI risk trend forecast\nSecurityAlert\n| where TimeGenerated > ago(90d)\n| where AlertName has_any (\"AI\", \"Model\", \"Prompt\", \"Copilot\")\n| summarize \n    DailyAlerts = count(),\n    High严重级别Alerts = countif(Alert严重级别 == \"High\")\n  by Date = bin(TimeGenerated, 1d)\n| extend \n    RiskScore = DailyAlerts * 1.0 + High严重级别Alerts * 2.0,\n    DayOfWeek = dayofweek(Date),\n    WeekOfYear = week_of_year(Date)\n| order by Date asc\n| extend \n    MovingAvg = round(RiskScore, 1),\n    Trend = case(\n        RiskScore > prev(RiskScore, 1) * 1.2, \" Rapid Increase\",\n        RiskScore < prev(RiskScore, 1) * 0.8, \" Rapid Decrease\",\n        \" Stable Variation\"\n    )\n| project Date, RiskScore, MovingAvg, Trend\n| render timechart",
                            "size": 0,
                            "title": "\ud83d\udcc8 AI风险趋势预测（90天）",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "linechart",
                            "chartSettings": {
                                "showLegend": true,
                                "seriesLabelSettings": [
                                    {
                                        "seriesName": "Daily 风险评分",
                                        "color": "blue"
                                    },
                                    {
                                        "seriesName": "Moving Average",
                                        "color": "red"
                                    }
                                ]
                            }
                        },
                        "name": "risk_prediction",
                        "id": "3cdf20d8-151c-4944-8325-04049ebb0829"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Risk incident impact assessment\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Model\", \"Prompt\", \"AI\", \"Copilot\")\n| extend \n    ImpactLevel = case(\n        Alert严重级别 == \"High\" and CompromisedEntity has_any (\"admin\", \"service\"), \"\ud83d\udd25 Critical Impact\",\n        Alert严重级别 == \"High\", \"\ud83d\udd34 High Impact\",\n        Alert严重级别 == \"Medium\", \"\ud83d\udfe0 Moderate Impact\",\n        \"\ud83d\udfe2 Low Impact\"\n    ),\n    BusinessImpact = case(\n        AlertName has \"Exfiltration\" or AlertName has \"Leak\", \"\ud83d\udcbc Business Data Risk\",\n        AlertName has \"Access\" or AlertName has \"Privilege\", \"\ud83d\udd10 Access Control Risk\",\n        AlertName has \"Compliance\" or AlertName has \"Policy\", \"\u2696\ufe0f Compliance Risk\",\n        AlertName has \"Performance\" or AlertName has \"Availability\", \"\u26a1 Performance Impact\",\n        \"\ud83d\udd27 Technical Risk\"\n    )\n| summarize \n    IncidentCount = count(),\n    AffectedEntities = dcount(CompromisedEntity),\n    LatestIncident = max(TimeGenerated)\n  by ImpactLevel, BusinessImpact\n| project \n    ['Impact Level'] = ImpactLevel,\n    ['Business Impact Type'] = BusinessImpact,\n    ['Incident Count'] = IncidentCount,\n    ['受影响实体'] = AffectedEntities,\n    ['Latest Incident Time'] = format_datetime(LatestIncident, 'MM-dd HH:mm')\n| order by ['Incident Count'] desc",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Impact Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Incident Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "受影响实体",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "impact_assessment",
                        "id": "2ecd246c-308e-443d-b76d-267535baf663"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Insider Risk Management - AI Data Abuse Detection\n// Detects potential insider threats involving AI applications and sensitive data\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    // Purview Insider Risk signals\n    PurviewAuditLogs\n    | where TimeGenerated > t0\n    | where OperationName has_any (\"InsiderRisk\", \"RiskyUser\", \"DataExfiltration\", \"AnomalousAccess\")\n    | where ObjectId has_any (\"AI\", \"Model\", \"Dataset\", \"Training\") or \n            RawEventData has_any (\"AI\", \"Copilot\", \"OpenAI\")\n    | extend\n        Source = \"Purview Insider Risk\",\n        RiskType = case(\n            OperationName has \"Exfiltration\", \"AI Data Exfiltration\",\n            OperationName has \"AnomalousAccess\", \"Anomalous AI Access\",\n            OperationName has \"RiskyUser\", \"Risky User Activity\",\n            \"Other Insider Risk\"\n        ),\n        RiskLevel = case(\n            ResultStatus has \"High\" or OperationName has \"Exfiltration\", \"Critical\",\n            ResultStatus has \"Medium\", \"High\",\n            \"Medium\"\n        ),\n        UserPrincipal = UserId,\n        Details = tostring(RawEventData)\n    | project TimeGenerated, Source, RiskType, RiskLevel, UserPrincipal, Details\n    ),\n    (\n    // Anomalous sign-in patterns to AI services\n    SigninLogs\n    | where TimeGenerated > t0\n    | where AppDisplayName has_any (\"AI\", \"Copilot\", \"ChatGPT\", \"OpenAI\")\n    | where RiskLevelDuringSignIn == \"high\" or RiskLevelAggregated == \"high\" or \n            RiskState == \"atRisk\" or RiskState == \"confirmedCompromised\"\n    | extend\n        Source = \"Entra ID Risk Detection\",\n        RiskType = case(\n            RiskEventTypes has \"anonymizedIPAddress\", \"Anonymous IP Usage\",\n            RiskEventTypes has \"maliciousIPAddress\", \"Malicious IP Access\",\n            RiskEventTypes has \"unfamiliarFeatures\", \"Unfamiliar Location\",\n            RiskEventTypes has \"impossibleTravel\", \"Impossible Travel\",\n            RiskEventTypes has \"malwareInfectedIPAddress\", \"Malware-Infected Source\",\n            \"Unknown Risk Pattern\"\n        ),\n        RiskLevel = case(\n            RiskLevelDuringSignIn == \"high\", \"Critical\",\n            RiskLevelAggregated == \"high\", \"High\",\n            \"Medium\"\n        ),\n        UserPrincipal = UserPrincipalName,\n        Details = strcat(\"App: \", AppDisplayName, \", Location: \", Location, \", IP: \", IPAddress)\n    | project TimeGenerated, Source, RiskType, RiskLevel, UserPrincipal, Details\n    ),\n    (\n    // Defender XDR - Suspicious file downloads\n    DeviceFileEvents\n    | where TimeGenerated > t0\n    | where FileName has_any (\".h5\", \".pkl\", \".pt\", \".onnx\", \"model\", \"training\", \"dataset\")\n    | where ActionType has_any (\"FileCreated\", \"FileModified\", \"FileRenamed\")\n    | where FolderPath has_any (\"Downloads\", \"Temp\", \"USB\", \"OneDrive\", \"Removable\")\n    | extend\n        Source = \"Defender XDR\",\n        RiskType = case(\n            FolderPath has \"USB\" or FolderPath has \"Removable\", \"AI模型 to Removable Media\",\n            FolderPath has \"Temp\", \"AI模型 to Temp Folder\",\n            FolderPath has \"Downloads\", \"AI模型 Download\",\n            \"Suspicious File Activity\"\n        ),\n        RiskLevel = case(\n            FolderPath has_any (\"USB\", \"Removable\"), \"Critical\",\n            FileName has_any (\".h5\", \".pkl\", \".pt\"), \"High\",\n            \"Medium\"\n        ),\n        UserPrincipal = InitiatingProcessAccountName,\n        Details = strcat(\"File: \", FileName, \", Path: \", FolderPath, \", Device: \", DeviceName)\n    | project TimeGenerated, Source, RiskType, RiskLevel, UserPrincipal, Details\n    )\n| summarize\n    RiskEventCount = count(),\n    CriticalCount = countif(RiskLevel == \"Critical\"),\n    HighCount = countif(RiskLevel == \"High\"),\n    MediumCount = countif(RiskLevel == \"Medium\"),\n    UniqueUsers = dcount(UserPrincipal),\n    UserList = make_set(UserPrincipal, 5),\n    SampleDetails = make_set(Details, 2),\n    FirstEvent = min(TimeGenerated),\n    LastEvent = max(TimeGenerated)\n  by Source, RiskType, RiskLevel\n| extend\n    ThreatScore = (CriticalCount * 5) + (HighCount * 3) + (MediumCount * 2)\n| extend\n    InsiderThreatLevel = case(\n        ThreatScore >= 20, \" Critical Insider Threat\",\n        ThreatScore >= 10, \" High Insider Risk\",\n        ThreatScore >= 5, \" Medium Insider Risk\",\n        \" Low Risk\"\n    )\n| project\n    ['Insider Threat Level'] = InsiderThreatLevel,\n    ['Detection Source'] = Source,\n    ['Risk Type'] = RiskType,\n    ['严重级别'] = RiskLevel,\n    ['Threat Score'] = ThreatScore,\n    ['Total Events'] = RiskEventCount,\n    ['Critical Events'] = CriticalCount,\n    ['High-Risk Events'] = HighCount,\n    ['Medium-Risk Events'] = MediumCount,\n    ['Unique Users'] = UniqueUsers,\n    ['Users Involved'] = tostring(UserList),\n    ['Event Examples'] = tostring(SampleDetails),\n    ['First Detection'] = format_datetime(FirstEvent, 'MM-dd HH:mm'),\n    ['Last Detection'] = format_datetime(LastEvent, 'MM-dd HH:mm')\n| order by ['Threat Score'] desc, ['Total Events'] desc",
                            "size": 0,
                            "title": "\ud83d\udea8 内部风险管理 - AI数据滥用与外泄检测",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Insider Threat Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Low",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Threat Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Critical Events",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "High-Risk Events",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    }
                                ],
                                "filter": true,
                                "rowLimit": 50
                            }
                        },
                        "name": "insider_risk_detection"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "risk"
            },
            "name": "risk_group",
            "id": "c9cb9a45-6cf8-4486-9eb4-13289b412f78"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #6610f2, #491d8b); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83c\udf0d 全球AI安全地理分析</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值主张**: 可视化AI安全威胁的全球分布，识别热点区域、威胁来源与跨境攻击模式，帮助安全团队理解全球AI风险态势、识别地缘风险并构建位置感知防御。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f4f1ff; padding: 10px; border-left: 4px solid #6610f2; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #6610f2;\">\ud83d\uddfa\ufe0f 威胁地图</h4>\n    <p style=\"font-size: 13px; color: #333;\">可视化全球AI威胁分布以定位高风险地区与来源</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f4f1ff; padding: 10px; border-left: 4px solid #6610f2; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #6610f2;\">\ud83c\udf10 跨境分析</h4>\n    <p style=\"font-size: 13px; color: #333;\">分析跨国威胁关联与地缘风险</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "geo_header",
                        "id": "4e137914-b4f3-47ae-974d-c041a7ff654d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Global heatmap of AI threats\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Model\", \"Prompt\", \"AI\", \"Copilot\", \"Jailbreak\")\n| extend Entities = parse_json(Entities)\n| mv-expand Entity = Entities\n| extend \n    Country = tostring(Entity.Location.CountryName),\n    CountryCode = tostring(Entity.Location.CountryCode)\n| where isnotempty(Country) and Country != \"Unknown\"\n| summarize \n    ThreatCount = count(),\n    High严重级别Count = countif(Alert严重级别 == \"High\"),\n    UniqueAlertTypes = dcount(AlertName),\n    LastThreat = max(TimeGenerated)\n  by Country, CountryCode\n| extend \n    ThreatLevel = case(\n        High严重级别Count >= 20, \"\ud83d\udd25 Extreme Threat\",\n        High严重级别Count >= 10, \"\ud83d\udd34 High Threat\",\n        High严重级别Count >= 5, \"\ud83d\udfe0 Moderate Threat\",\n        \"\ud83d\udfe1 Low Threat\"\n    ),\n    CountryWithFlag = case(\n        Country has \"United States\" or CountryCode == \"US\", \"\ud83c\uddfa\ud83c\uddf8 United States\",\n        Country has \"China\" or CountryCode == \"CN\", \"\ud83c\udde8\ud83c\uddf3 China\",\n        Country has \"Russia\" or CountryCode == \"RU\", \"\ud83c\uddf7\ud83c\uddfa Russia\",\n        Country has \"Japan\" or CountryCode == \"JP\", \"\ud83c\uddef\ud83c\uddf5 Japan\",\n        Country has \"United Kingdom\" or CountryCode == \"GB\", \"\ud83c\uddec\ud83c\udde7 United Kingdom\",\n        Country has \"Germany\" or CountryCode == \"DE\", \"\ud83c\udde9\ud83c\uddea Germany\",\n        Country has \"France\" or CountryCode == \"FR\", \"\ud83c\uddeb\ud83c\uddf7 France\",\n        Country has \"India\" or CountryCode == \"IN\", \"\ud83c\uddee\ud83c\uddf3 India\",\n        Country has \"South Korea\" or CountryCode == \"KR\", \"\ud83c\uddf0\ud83c\uddf7 South Korea\",\n        Country has \"Australia\" or CountryCode == \"AU\", \"\ud83c\udde6\ud83c\uddfa Australia\",\n        Country has \"Canada\" or CountryCode == \"CA\", \"\ud83c\udde8\ud83c\udde6 Canada\",\n        Country has \"Brazil\" or CountryCode == \"BR\", \"\ud83c\udde7\ud83c\uddf7 Brazil\",\n        Country has \"Italy\" or CountryCode == \"IT\", \"\ud83c\uddee\ud83c\uddf9 Italy\",\n        Country has \"Spain\" or CountryCode == \"ES\", \"\ud83c\uddea\ud83c\uddf8 Spain\",\n        Country has \"Netherlands\" or CountryCode == \"NL\", \"\ud83c\uddf3\ud83c\uddf1 Netherlands\",\n        Country has \"Singapore\" or CountryCode == \"SG\", \"\ud83c\uddf8\ud83c\uddec Singapore\",\n        Country has \"Mexico\" or CountryCode == \"MX\", \"\ud83c\uddf2\ud83c\uddfd Mexico\",\n        Country has \"Israel\" or CountryCode == \"IL\", \"\ud83c\uddee\ud83c\uddf1 Israel\",\n        strcat(\"\ud83c\udf0d \", Country)\n    )\n| project \n    Country,\n    ['Threat Count'] = ThreatCount,\n    ['High-严重级别 Threats'] = High严重级别Count,\n    ['威胁类型 Count'] = UniqueAlertTypes,\n    ['Threat Level'] = ThreatLevel,\n    ['Latest Threat'] = format_datetime(LastThreat, 'MM-dd HH:mm')\n| order by ['Threat Count'] desc",
                            "size": 2,
                            "title": "\ud83d\uddfa\ufe0f 全球AI威胁热力图",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "map",
                            "mapSettings": {
                                "locInfo": "CountryRegion",
                                "locInfoColumn": "Country",
                                "sizeSettings": "Threat Count",
                                "sizeAggregation": "Sum",
                                "legend指标": "Threat Count",
                                "legendAggregation": "Sum",
                                "itemColorSettings": {
                                    "nodeColorField": "High-严重级别 Threats",
                                    "colorAggregation": "Sum",
                                    "type": "heatmap",
                                    "heatmapPalette": "greenRed"
                                }
                            }
                        },
                        "name": "threat_geo_map",
                        "id": "0a0b0cc1-13dc-4d5b-bc15-d360b0344a26"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Global distribution of AI application usage\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(AppDisplayName) and isnotempty(Location)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\")\n| extend \n    CountryCode = Location,\n    Country = case(\n        Location == \"US\", \"United States\",\n        Location == \"CN\", \"China\",\n        Location == \"JP\", \"Japan\",\n        Location == \"SG\", \"Singapore\",\n        Location == \"GB\", \"United Kingdom\",\n        Location == \"DE\", \"Germany\",\n        Location == \"FR\", \"France\",\n        Location == \"IN\", \"India\",\n        Location == \"KR\", \"South Korea\",\n        Location == \"AU\", \"Australia\",\n        Location == \"CA\", \"Canada\",\n        Location == \"BR\", \"Brazil\",\n        Location == \"RU\", \"Russia\",\n        Location == \"IT\", \"Italy\",\n        Location == \"ES\", \"Spain\",\n        Location == \"NL\", \"Netherlands\",\n        Location == \"SE\", \"Sweden\",\n        Location == \"NO\", \"Norway\",\n        Location == \"DK\", \"Denmark\",\n        Location == \"FI\", \"Finland\",\n        Location\n    )\n| summarize \n    UniqueUsers = dcount(UserPrincipalName),\n    TotalLogins = count(),\n    UniqueApps = dcount(AppDisplayName),\n    LastActivity = max(TimeGenerated)\n  by Country, CountryCode\n| extend \n    UsageLevel = case(\n        UniqueUsers >= 100, \"\ud83d\udd25 非常高\",\n        UniqueUsers >= 50, \"\ud83d\udd34 High\",\n        UniqueUsers >= 20, \"\ud83d\udfe0 Medium\",\n        \"\ud83d\udfe1 Low\"\n    ),\n    CountryWithFlag = case(\n        Country == \"United States\" or CountryCode == \"US\", \"\ud83c\uddfa\ud83c\uddf8 United States\",\n        Country == \"China\" or CountryCode == \"CN\", \"\ud83c\udde8\ud83c\uddf3 China\",\n        Country == \"Japan\" or CountryCode == \"JP\", \"\ud83c\uddef\ud83c\uddf5 Japan\",\n        Country == \"Singapore\" or CountryCode == \"SG\", \"\ud83c\uddf8\ud83c\uddec Singapore\",\n        Country == \"United Kingdom\" or CountryCode == \"GB\", \"\ud83c\uddec\ud83c\udde7 United Kingdom\",\n        Country == \"Germany\" or CountryCode == \"DE\", \"\ud83c\udde9\ud83c\uddea Germany\",\n        Country == \"France\" or CountryCode == \"FR\", \"\ud83c\uddeb\ud83c\uddf7 France\",\n        Country == \"India\" or CountryCode == \"IN\", \"\ud83c\uddee\ud83c\uddf3 India\",\n        Country == \"South Korea\" or CountryCode == \"KR\", \"\ud83c\uddf0\ud83c\uddf7 South Korea\",\n        Country == \"Australia\" or CountryCode == \"AU\", \"\ud83c\udde6\ud83c\uddfa Australia\",\n        Country == \"Canada\" or CountryCode == \"CA\", \"\ud83c\udde8\ud83c\udde6 Canada\",\n        Country == \"Brazil\" or CountryCode == \"BR\", \"\ud83c\udde7\ud83c\uddf7 Brazil\",\n        Country == \"Russia\" or CountryCode == \"RU\", \"\ud83c\uddf7\ud83c\uddfa Russia\",\n        Country == \"Italy\" or CountryCode == \"IT\", \"\ud83c\uddee\ud83c\uddf9 Italy\",\n        Country == \"Spain\" or CountryCode == \"ES\", \"\ud83c\uddea\ud83c\uddf8 Spain\",\n        Country == \"Netherlands\" or CountryCode == \"NL\", \"\ud83c\uddf3\ud83c\uddf1 Netherlands\",\n        Country == \"Sweden\" or CountryCode == \"SE\", \"\ud83c\uddf8\ud83c\uddea Sweden\",\n        Country == \"Norway\" or CountryCode == \"NO\", \"\ud83c\uddf3\ud83c\uddf4 Norway\",\n        Country == \"Denmark\" or CountryCode == \"DK\", \"\ud83c\udde9\ud83c\uddf0 Denmark\",\n        Country == \"Finland\" or CountryCode == \"FI\", \"\ud83c\uddeb\ud83c\uddee Finland\",\n        strcat(\"\ud83c\udf0d \", Country)\n    )\n| project \n    Country,\n    ['用户数'] = UniqueUsers,\n    ['登录次数'] = TotalLogins,\n    ['应用数量'] = UniqueApps,\n    ['使用等级'] = UsageLevel,\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm')\n| order by ['用户数'] desc",
                            "size": 2,
                            "title": "\ud83d\udccd 全球AI应用使用分布",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "map",
                            "mapSettings": {
                                "locInfo": "CountryRegion",
                                "locInfoColumn": "Country",
                                "sizeSettings": "用户数",
                                "sizeAggregation": "Sum",
                                "legend指标": "用户数",
                                "legendAggregation": "Sum",
                                "itemColorSettings": {
                                    "nodeColorField": "登录次数",
                                    "colorAggregation": "Sum",
                                    "type": "heatmap",
                                    "heatmapPalette": "blueDark"
                                }
                            }
                        },
                        "name": "usage_geo_map",
                        "id": "8c227fa9-8654-4c7e-b667-369395fbb43d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Threat versus usage comparison analysis\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Model\", \"Prompt\", \"AI\", \"Copilot\")\n| extend \n    // Extract country information from multiple fields\n    ExtractedCountry = coalesce(\n        tostring(parse_json(tostring(Entities))[0].Location.CountryName),\n        tostring(parse_json(tostring(Entities))[0].Location.Country),\n        extract(@\"Country[:\\s]*([A-Za-z\\s]+)\", 1, tostring(Entities)),\n        extract(@\"CountryName[:\\s]*([A-Za-z\\s]+)\", 1, tostring(Entities)),\n        \"Unknown\"\n    )\n| where ExtractedCountry != \"Unknown\" and isnotempty(ExtractedCountry)\n| extend Country = case(\n    ExtractedCountry has \"United States\" or ExtractedCountry == \"US\", \"United States\",\n    ExtractedCountry has \"China\" or ExtractedCountry == \"CN\", \"China\",\n    ExtractedCountry has \"Japan\" or ExtractedCountry == \"JP\", \"Japan\",\n    ExtractedCountry has \"Singapore\" or ExtractedCountry == \"SG\", \"Singapore\",\n    ExtractedCountry has \"United Kingdom\" or ExtractedCountry == \"GB\" or ExtractedCountry == \"UK\", \"United Kingdom\",\n    ExtractedCountry has \"Germany\" or ExtractedCountry == \"DE\", \"Germany\",\n    ExtractedCountry has \"France\" or ExtractedCountry == \"FR\", \"France\",\n    ExtractedCountry has \"India\" or ExtractedCountry == \"IN\", \"India\",\n    ExtractedCountry has \"Korea\" or ExtractedCountry == \"KR\", \"South Korea\",\n    ExtractedCountry has \"Australia\" or ExtractedCountry == \"AU\", \"Australia\",\n    ExtractedCountry has \"Canada\" or ExtractedCountry == \"CA\", \"Canada\",\n    ExtractedCountry has \"Brazil\" or ExtractedCountry == \"BR\", \"Brazil\",\n    ExtractedCountry has \"Russia\" or ExtractedCountry == \"RU\", \"Russia\",\n    ExtractedCountry has \"Italy\" or ExtractedCountry == \"IT\", \"Italy\",\n    ExtractedCountry has \"Spain\" or ExtractedCountry == \"ES\", \"Spain\",\n    ExtractedCountry has \"Netherlands\" or ExtractedCountry == \"NL\", \"Netherlands\",\n    ExtractedCountry has \"Sweden\" or ExtractedCountry == \"SE\", \"Sweden\",\n    ExtractedCountry has \"Norway\" or ExtractedCountry == \"NO\", \"Norway\",\n    ExtractedCountry has \"Denmark\" or ExtractedCountry == \"DK\", \"Denmark\",\n    ExtractedCountry has \"Finland\" or ExtractedCountry == \"FI\", \"Finland\",\n    ExtractedCountry\n)\n| summarize ThreatCount = count() by Country\n| join kind=fullouter (\n    SigninLogs\n    | where TimeGenerated > {TimeRange:start}\n    | where isnotempty(AppDisplayName) and isnotempty(Location)\n    | extend AppNameLower = tolower(AppDisplayName)\n    | where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\")\n    | extend Country = case(\n        Location == \"US\", \"United States\",\n        Location == \"CN\", \"China\",\n        Location == \"JP\", \"Japan\",\n        Location == \"SG\", \"Singapore\",\n        Location == \"GB\" or Location == \"UK\", \"United Kingdom\",\n        Location == \"DE\", \"Germany\",\n        Location == \"FR\", \"France\",\n        Location == \"IN\", \"India\",\n        Location == \"KR\", \"South Korea\",\n        Location == \"AU\", \"Australia\",\n        Location == \"CA\", \"Canada\",\n        Location == \"BR\", \"Brazil\",\n        Location == \"RU\", \"Russia\",\n        Location == \"IT\", \"Italy\",\n        Location == \"ES\", \"Spain\",\n        Location == \"NL\", \"Netherlands\",\n        Location == \"SE\", \"Sweden\",\n        Location == \"NO\", \"Norway\",\n        Location == \"DK\", \"Denmark\",\n        Location == \"FI\", \"Finland\",\n        Location\n    )\n    | where isnotempty(Country) and Country != \"\"\n    | summarize UsageCount = count() by Country\n) on Country\n| extend \n    FinalCountry = coalesce(Country, Country1),\n    FinalThreatCount = coalesce(ThreatCount, 0),\n    FinalUsageCount = coalesce(UsageCount, 0)\n| where isnotempty(FinalCountry) and FinalCountry != \"\"\n| extend \n    RiskRatio = round(todouble(FinalThreatCount) / todouble(FinalUsageCount + 1) * 100, 2),\n    RiskLevel = case(\n        FinalThreatCount > 0 and FinalUsageCount == 0, \"\ud83d\udd25 Threat-Only Origin\",\n        round(todouble(FinalThreatCount) / todouble(FinalUsageCount + 1) * 100, 2) >= 10, \"\ud83d\udd34 Extreme Risk\",\n        round(todouble(FinalThreatCount) / todouble(FinalUsageCount + 1) * 100, 2) >= 5, \"\ud83d\udfe0 High Risk\",\n        round(todouble(FinalThreatCount) / todouble(FinalUsageCount + 1) * 100, 2) >= 2, \"\ud83d\udfe1 Moderate Risk\",\n        FinalUsageCount > 0, \"\ud83d\udfe2 Low Risk\",\n        \"\u26aa No Data\"\n    )\n| order by FinalThreatCount desc, RiskRatio desc\n| project \n    ['Country'] = FinalCountry,\n    ['威胁事件'] = FinalThreatCount,\n    ['AI使用次数'] = FinalUsageCount,\n    ['风险比率'] = strcat(tostring(RiskRatio), \"%\"),\n    ['风险等级'] = RiskLevel\n| take 25",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "威胁事件",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "AI使用次数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "风险比率",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "threat_usage_comparison",
                        "id": "e7c97df3-5b64-4fc1-bcd8-1406ff59282e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 跨境AI威胁相关性分析\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Model\", \"Prompt\", \"AI\", \"Copilot\")\n| extend \n    // Extract source country information from multiple fields\n    ExtractedSourceCountry = coalesce(\n        tostring(parse_json(tostring(Entities))[0].Location.CountryName),\n        tostring(parse_json(tostring(Entities))[0].Location.Country),\n        tostring(parse_json(tostring(ExtendedProperties))[\"SourceCountry\"]),\n        tostring(parse_json(tostring(ExtendedProperties))[\"Country\"]),\n        extract(@\"Country[:\\s]*([A-Za-z\\s]+)\", 1, tostring(Description)),\n        extract(@\"from\\s+([A-Za-z\\s]+)\", 1, tostring(Description)),\n        \"Unknown\"\n    ),\n    // Normalize 目标实体 details\n    CleanTargetEntity = coalesce(\n        tostring(CompromisedEntity),\n        tostring(parse_json(tostring(Entities))[0].Name),\n        tostring(parse_json(tostring(ExtendedProperties))[\"TargetResource\"]),\n        \"Unknown Target\"\n    )\n| where ExtractedSourceCountry != \"Unknown\" and isnotempty(ExtractedSourceCountry)\n| where CleanTargetEntity != \"Unknown Target\" and isnotempty(CleanTargetEntity)\n| extend \n    SourceCountry = case(\n        ExtractedSourceCountry has \"United States\" or ExtractedSourceCountry == \"US\", \"\ud83c\uddfa\ud83c\uddf8 United States\",\n        ExtractedSourceCountry has \"China\" or ExtractedSourceCountry == \"CN\", \"\ud83c\udde8\ud83c\uddf3 China\",\n        ExtractedSourceCountry has \"Russia\" or ExtractedSourceCountry == \"RU\", \"\ud83c\uddf7\ud83c\uddfa Russia\",\n        ExtractedSourceCountry has \"Iran\" or ExtractedSourceCountry == \"IR\", \"\ud83c\uddee\ud83c\uddf7 Iran\",\n        ExtractedSourceCountry has \"North Korea\" or ExtractedSourceCountry == \"KP\", \"\ud83c\uddf0\ud83c\uddf5 North Korea\",\n        ExtractedSourceCountry has \"Germany\" or ExtractedSourceCountry == \"DE\", \"\ud83c\udde9\ud83c\uddea Germany\",\n        ExtractedSourceCountry has \"France\" or ExtractedSourceCountry == \"FR\", \"\ud83c\uddeb\ud83c\uddf7 France\",\n        ExtractedSourceCountry has \"United Kingdom\" or ExtractedSourceCountry == \"GB\", \"\ud83c\uddec\ud83c\udde7 United Kingdom\",\n        ExtractedSourceCountry has \"Japan\" or ExtractedSourceCountry == \"JP\", \"\ud83c\uddef\ud83c\uddf5 Japan\",\n        ExtractedSourceCountry has \"India\" or ExtractedSourceCountry == \"IN\", \"\ud83c\uddee\ud83c\uddf3 India\",\n        ExtractedSourceCountry has \"Brazil\" or ExtractedSourceCountry == \"BR\", \"\ud83c\udde7\ud83c\uddf7 Brazil\",\n        ExtractedSourceCountry has \"Australia\" or ExtractedSourceCountry == \"AU\", \"\ud83c\udde6\ud83c\uddfa Australia\",\n        ExtractedSourceCountry has \"Canada\" or ExtractedSourceCountry == \"CA\", \"\ud83c\udde8\ud83c\udde6 Canada\",\n        ExtractedSourceCountry has \"South Korea\" or ExtractedSourceCountry == \"KR\", \"\ud83c\uddf0\ud83c\uddf7 South Korea\",\n        ExtractedSourceCountry has \"Israel\" or ExtractedSourceCountry == \"IL\", \"\ud83c\uddee\ud83c\uddf1 Israel\",\n        ExtractedSourceCountry has \"Netherlands\" or ExtractedSourceCountry == \"NL\", \"\ud83c\uddf3\ud83c\uddf1 Netherlands\",\n        ExtractedSourceCountry has \"Spain\" or ExtractedSourceCountry == \"ES\", \"\ud83c\uddea\ud83c\uddf8 Spain\",\n        ExtractedSourceCountry has \"Italy\" or ExtractedSourceCountry == \"IT\", \"\ud83c\uddee\ud83c\uddf9 Italy\",\n        ExtractedSourceCountry has \"Mexico\" or ExtractedSourceCountry == \"MX\", \"\ud83c\uddf2\ud83c\uddfd Mexico\",\n        ExtractedSourceCountry has \"Singapore\" or ExtractedSourceCountry == \"SG\", \"\ud83c\uddf8\ud83c\uddec Singapore\",\n        strcat(\"\ud83c\udf0d \", ExtractedSourceCountry)\n    )\n| summarize \n    AttackCount = count(),\n    UniqueTargets = dcount(CleanTargetEntity),\n    High严重级别Attacks = countif(Alert严重级别 == \"High\"),\n    AttackMethods = make_set(AlertName, 5),\n    TargetTypes = make_set(CleanTargetEntity, 5),\n    FirstAttack = min(TimeGenerated),\n    LastAttack = max(TimeGenerated)\n  by SourceCountry\n| extend \n    AttackIntensity = round(todouble(AttackCount) / todouble(datetime_diff('day', LastAttack, FirstAttack) + 1), 2),\n    ThreatLevel = case(\n        High严重级别Attacks >= 20, \"\ud83d\udd25 Nation-State Critical Threat\",\n        High严重级别Attacks >= 10 or AttackCount >= 50, \"\ud83d\udd34 Advanced Persistent Threat\",\n        High严重级别Attacks >= 5 or AttackCount >= 20, \"\ud83d\udfe0 Elevated Threat\",\n        AttackCount >= 10, \"\ud83d\udfe1 Low-Level Threat\",\n        \"\ud83d\udfe2 Sporadic Activity\"\n    )\n| project \n    ['Source Country'] = SourceCountry,\n    ['Threat Level'] = ThreatLevel,\n    ['Total Attacks'] = AttackCount,\n    ['High-严重级别 Attacks'] = High严重级别Attacks,\n    ['Target Count'] = UniqueTargets,\n    ['Attack Intensity/Day'] = AttackIntensity,\n    ['First Attack'] = format_datetime(FirstAttack, 'MM-dd HH:mm'),\n    ['Latest Attack'] = format_datetime(LastAttack, 'MM-dd HH:mm'),\n    ['Attack Methods'] = tostring(AttackMethods),\n    ['Target Types'] = tostring(TargetTypes)\n| order by ['Total Attacks'] desc, ['High-严重级别 Attacks'] desc\n| take 20",
                            "size": 0,
                            "title": "\ud83c\udf10 跨境AI威胁相关性分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Threat Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Attacks",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "High-严重级别 Attacks",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "Target Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "Attack Intensity/Day",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "cross_country_threats",
                        "id": "e511360a-030e-481a-984c-ee247abef22b"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "geo"
            },
            "name": "geo_group",
            "id": "efd0dde0-5cb6-4874-8c3e-001a14ee2d5a"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #6f42c1, #4a2c7a); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udd10 AI API安全监控</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值主张**: 聚焦AI API安全监控与异常检测，通过分析调用模式、发现异常行为并跟踪威胁事件，帮助安全团队保护AI服务端点免受滥用、DDoS攻击与恶意调用。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f5f3ff; padding: 10px; border-left: 4px solid #6f42c1; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #6f42c1;\">\ud83d\udd0d 异常检测</h4>\n    <p style=\"font-size: 13px; color: #333;\">实时监控AI API异常以识别恶意流量与攻击模式</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f5f3ff; padding: 10px; border-left: 4px solid #6f42c1; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #6f42c1;\">\u26a1 性能监控</h4>\n    <p style=\"font-size: 13px; color: #333;\">跟踪API响应时间、错误率与可用性健康状态</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "ai_api_header",
                        "id": "ca568748-3318-4ef4-afd7-50d46b3db012"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI API 异常检测 analysis (SecurityAlert-based)\nlet aiApiKeywords = dynamic([\"openai\", \"chat\", \"copilot\", \"ai\", \"gpt\", \"completions\", \"embeddings\"]);\n\nSecurityAlert\n| where TimeGenerated > ago(24h)\n| where AlertName has_any (aiApiKeywords) or Description has_any (aiApiKeywords)\n| extend \n    Hour = bin(TimeGenerated, 1h),\n    IsHigh严重级别 = iff(Alert严重级别 == \"High\", 1, 0),\n    IsMedium严重级别 = iff(Alert严重级别 == \"Medium\", 1, 0),\n    IsAPIThreat = iff(AlertName has_any (\"API\", \"Endpoint\", \"Request\", \"Response\"), 1, 0)\n| summarize \n    HourlyAlertCount = count(),\n    High严重级别Count = sum(IsHigh严重级别),\n    Medium严重级别Count = sum(IsMedium严重级别),\n    APIThreatCount = sum(IsAPIThreat),\n    UniqueAlertTypes = dcount(AlertName),\n    AffectedEntities = dcount(CompromisedEntity)\n  by Hour\n| extend \n    严重级别Rate = round(todouble(High严重级别Count) / todouble(HourlyAlertCount) * 100, 2),\n    BaselineAlerts = 5.0,\n    Baseline严重级别Rate = 20.0\n| extend \n    VolumeAnomaly = case(\n        HourlyAlertCount > BaselineAlerts * 3, \"\ud83d\udd34 Alert Spike\",\n        HourlyAlertCount < BaselineAlerts * 0.3 and HourlyAlertCount > 0, \"\ud83d\udfe1 Alert Drop\",\n        HourlyAlertCount > 0, \"\ud83d\udfe2 Normal\",\n        \"\u26aa No Alerts\"\n    ),\n    严重级别Anomaly = case(\n        严重级别Rate > Baseline严重级别Rate * 2, \"\ud83d\udd34 High-严重级别 Anomaly\",\n        严重级别Rate > 0, \"\ud83d\udfe2 Normal\",\n        \"\u26aa No High-严重级别 Alerts\"\n    ),\n    ThreatActivity = case(\n        APIThreatCount > 0, \"\ud83d\udd34 Active API Threat\",\n        \"\ud83d\udfe2 Normal\"\n    )\n| extend \n    OverallRisk = case(\n        VolumeAnomaly has \"Spike\" or 严重级别Anomaly has \"Anomaly\" or ThreatActivity has \"Threat\", \"\ud83d\udd34 High Risk\",\n        VolumeAnomaly has \"Drop\", \"\ud83d\udfe1 Needs Attention\",\n        HourlyAlertCount > 0, \"\ud83d\udfe2 Normal Monitoring\",\n        \"\u26aa Quiet Period\"\n    )\n| project \n    ['Time Window'] = format_datetime(Hour, 'MM-dd HH:mm'),\n    ['风险等级'] = OverallRisk,\n    ['告警数量'] = HourlyAlertCount,\n    ['Alert Status'] = VolumeAnomaly,\n    ['High-严重级别 Rate'] = strcat(tostring(严重级别Rate), \"%\"),\n    ['严重级别 Status'] = 严重级别Anomaly,\n    ['API Threat Activity'] = ThreatActivity,\n    ['Alert Type Count'] = UniqueAlertTypes,\n    ['Impacted Entities'] = AffectedEntities\n| order by ['Time Window'] desc\n| take 24",
                            "size": 0,
                            "title": "\ud83d\udd0d AI API异常检测 - 24小时概览",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Alert Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "API Threat Activity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "告警数量",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "ai_api_anomaly_detection",
                        "id": "dfd51d86-1b6f-4546-b7a2-8396227f965a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI API威胁情报 and attack pattern analysis\nSecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has_any (\"API\", \"Injection\", \"Abuse\", \"Anomaly\", \"DDoS\", \"Brute Force\")\n| where Description has_any (\"AI\", \"OpenAI\", \"Cognitive\", \"API\", \"model\", \"completions\", \"embeddings\")\n| extend \n    ThreatCategory = case(\n        AlertName has \"Injection\" or Description has \"injection\", \"\ud83d\udc89 API Injection Attack\",\n        AlertName has \"Brute Force\" or AlertName has \"brute\", \"\ud83d\udd28 Brute Force\",\n        AlertName has \"DDoS\" or AlertName has \"flood\", \"\ud83d\udca5 DDoS Attack\",\n        AlertName has \"Anomaly\" or AlertName has \"unusual\", \"\ud83d\udd0d Anomalous Behavior\",\n        AlertName has \"Abuse\" or AlertName has \"misuse\", \"\ud83d\udd0c API Abuse\",\n        \"\u26a0\ufe0f Other Threats\"\n    ),\n    严重级别Level = case(\n        Alert严重级别 == \"High\", \"\ud83d\udd34 High\",\n        Alert严重级别 == \"Medium\", \"\ud83d\udfe0 Medium\",\n        Alert严重级别 == \"Low\", \"\ud83d\udfe1 Low\",\n        \"\u2139\ufe0f Informational\"\n    ),\n    TargetAPI = case(\n        CompromisedEntity has \"completions\" or Description has \"completions\", \"Text Completion API\",\n        CompromisedEntity has \"chat\" or Description has \"chat\", \"Chat Completion API\",\n        CompromisedEntity has \"embeddings\" or Description has \"embeddings\", \"Embedding API\",\n        CompromisedEntity has \"openai\" or Description has \"openai\", \"OpenAI API\",\n        CompromisedEntity has \"cognitive\" or Description has \"cognitive\", \"Cognitive Services\",\n        coalesce(CompromisedEntity, \"Unknown Target\")\n    ),\n    AttackSource = case(\n        Description has \"China\" or Description has \"CN\", \"\ud83c\udde8\ud83c\uddf3 China\",\n        Description has \"Russia\" or Description has \"RU\", \"\ud83c\uddf7\ud83c\uddfa Russia\",\n        Description has \"Iran\" or Description has \"IR\", \"\ud83c\uddee\ud83c\uddf7 Iran\",\n        Description has \"North Korea\" or Description has \"KP\", \"\ud83c\uddf0\ud83c\uddf5 North Korea\",\n        Description has \"United States\" or Description has \"US\", \"\ud83c\uddfa\ud83c\uddf8 United States\",\n        \"\ud83c\udf10 Other/Unknown\"\n    )\n| extend \n    CalculatedRiskScore = case(\n        Alert严重级别 == \"High\" and ThreatCategory has \"Injection\", 95,\n        Alert严重级别 == \"High\" and ThreatCategory has \"DDoS\", 90,\n        Alert严重级别 == \"High\", 80,\n        Alert严重级别 == \"Medium\" and ThreatCategory has \"Brute Force\", 70,\n        Alert严重级别 == \"Medium\", 60,\n        Alert严重级别 == \"Low\", 40,\n        20\n    )\n| extend\n    ImpactLevel = case(\n        CalculatedRiskScore >= 90, \"\ud83d\udd25 Severe Impact\",\n        CalculatedRiskScore >= 70, \"\ud83d\udd34 High Impact\",\n        CalculatedRiskScore >= 50, \"\ud83d\udfe0 Moderate Impact\",\n        \"\ud83d\udfe2 Minor Impact\"\n    )\n| project \n    ['Detected Time'] = format_datetime(TimeGenerated, 'MM-dd HH:mm:ss'),\n    ['Threat Category'] = ThreatCategory,\n    ['严重级别'] = 严重级别Level,\n    ['Impact Assessment'] = ImpactLevel,\n    ['风险评分'] = CalculatedRiskScore,\n    ['Target API'] = TargetAPI,\n    ['Attack Source'] = AttackSource,\n    ['告警名称'] = AlertName,\n    ['Impacted Entity'] = CompromisedEntity,\n    ['Alert Status'] = Status,\n    ['Response Recommendation'] = case(\n        ThreatCategory has \"Injection\", \"Immediately review input validation and parameter filtering\",\n        ThreatCategory has \"Brute Force\", \"Enable IP throttling and account lockout policies\",\n        ThreatCategory has \"DDoS\", \"Activate DDoS protection and traffic throttling\",\n        ThreatCategory has \"Anomalous Behavior\", \"Investigate user behavior and invocation patterns\",\n        ThreatCategory has \"API Abuse\", \"Review API usage policies and quota settings\",\n        \"Follow the standard 事件响应 process\"\n    )\n| order by ['风险评分'] desc, ['Detected Time'] desc\n| take 20",
                            "size": 0,
                            "title": "\ud83d\udee1\ufe0f AI API威胁情报",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u2139\ufe0f",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redGreen"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "api_threat_intelligence_fixed",
                        "id": "bd35282e-9b15-4edd-9cba-e21920c79445"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI服务配置变更监控\nAuditLogs\n| extend TargetResourcesText = tostring(TargetResources), AdditionalDetailsText = tostring(AdditionalDetails)\n| where TimeGenerated > ago(30d)\n| where OperationName has_any ('Add', 'Update', 'Delete', 'Modify', 'Create', 'Remove', 'Grant', 'Revoke')\n| where TargetResourcesText has_any ('cognitive', 'openai', 'machinelearning', 'bot', 'ai') or\n        AdditionalDetailsText has_any ('CognitiveServices', 'OpenAI', 'MachineLearning', 'BotService') or\n        Category == 'ApplicationManagement'\n| extend\n    ResourceName = coalesce(\n        tostring(TargetResources[0].displayName),\n        tostring(TargetResources[0].userPrincipalName),\n        tostring(TargetResources[0].id),\n        'Unknown Resource'\n    ),\n    Actor = coalesce(\n        tostring(InitiatedBy.user.userPrincipalName),\n        tostring(InitiatedBy.app.displayName),\n        tostring(InitiatedBy.app.servicePrincipalName),\n        'System Operation'\n    ),\n    SourceIP = coalesce(\n        tostring(InitiatedBy.user.ipAddress),\n        tostring(InitiatedBy.app.ipAddress),\n        'IP Not Recorded'\n    ),\n    AIServiceType = case(\n        TargetResourcesText has 'cognitive' or AdditionalDetailsText has 'CognitiveServices', '\ud83e\udde0 Cognitive Services',\n        TargetResourcesText has 'openai' or AdditionalDetailsText has 'OpenAI', '\ud83e\udd16 Azure OpenAI',\n        TargetResourcesText has 'machinelearning' or AdditionalDetailsText has 'MachineLearning', '\ud83d\udcca Machine Learning',\n        TargetResourcesText has 'bot' or AdditionalDetailsText has 'BotService', '\ud83e\udd16 Bot Service',\n        TargetResourcesText has 'copilot' or AdditionalDetailsText has 'Copilot', '\ud83d\udcbc Microsoft Copilot',\n        Category == 'ApplicationManagement', '\ud83d\udcf1 Application Management',\n        '\u2699\ufe0f Other Services'\n    ),\n    RiskLevel = case(\n        OperationName has_any ('Delete', 'Remove', 'Revoke'), '\ud83d\udd34 High-Risk Operation',\n        OperationName has_any ('Grant', 'Add') and TargetResourcesText has_any ('admin', 'owner', 'contributor'), '\ud83d\udd34 Privilege Escalation',\n        OperationName has_any ('Update', 'Modify') and TargetResourcesText has_any ('key', 'secret', 'credential'), '\ud83d\udfe0 Sensitive Change',\n        OperationName has_any ('Create', 'Add'), '\ud83d\udfe1 Resource Creation',\n        '\ud83d\udfe2 Routine Operation'\n    ),\n    ChangeDetails = case(\n        OperationName has 'Add', strcat('Added: ', tostring(TargetResources[0].type)),\n        OperationName has 'Delete', strcat('Deleted: ', tostring(TargetResources[0].type)),\n        OperationName has 'Grant', strcat('Permission Action: ', OperationName),\n        strcat('Operation: ', OperationName)\n    ),\n    OriginalTime = TimeGenerated\n| project\n    ['Timestamp'] = format_datetime(TimeGenerated, 'MM-dd HH:mm:ss'),\n    ['AI 服务类型'] = AIServiceType,\n    ['Resource Name'] = ResourceName,\n    ['Operation Type'] = OperationName,\n    ['风险等级'] = RiskLevel,\n    ['Actor'] = Actor,\n    ['Source IP Address'] = SourceIP,\n    ['Change Details'] = ChangeDetails,\n    ['Operation Result'] = Result,\n    OriginalTime\n| order by OriginalTime desc\n| project-away OriginalTime\n| take 30",
                            "size": 0,
                            "title": "\u2699\ufe0f AI服务配置变更监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Operation Result",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Success",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Failure",
                                                    "representation": "redBright"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "enhanced_config_monitoring_fixed",
                        "id": "be1eb1dd-0cc7-4c38-8351-75a2d9875b4d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI API安全监控 (revised)\nlet aiApiEndpoints = dynamic([\n    \"openai.azure.com\", \"api.openai.com\", \"cognitive.microsoft.com\",\n    \"/chat/completions\", \"/completions\", \"/embeddings\", \"/models\",\n    \"copilot\", \"ai-studio\", \"machinelearning\", \"cognitiveservices\"\n]);\n\nAppServiceHTTPLogs\n| where TimeGenerated > ago(7d)\n| where CsHost has_any (aiApiEndpoints) or CsUriStem has_any (aiApiEndpoints)\n| extend \n    APIEndpoint = case(\n        CsUriStem has \"/chat/completions\", \"\ud83d\udcac Chat Completions\",\n        CsUriStem has \"/completions\", \"\ud83d\udcdd Text Completions\", \n        CsUriStem has \"/embeddings\", \"\ud83d\udd22 Embeddings\",\n        CsUriStem has \"/models\", \"\ud83e\udd16 Models\",\n        CsHost has \"openai.azure.com\", \"\u2601\ufe0f Azure OpenAI\",\n        CsHost has \"api.openai.com\", \"\ud83c\udf10 OpenAI API\",\n        CsHost has \"cognitive.microsoft.com\", \"\ud83e\udde0 Cognitive Services\",\n        \"\ud83d\udd27 Other AI APIs\"\n    ),\n    ResponseStatus = case(\n        ScStatus < 300, \"\u2705 Success\",\n        ScStatus == 401, \"\ud83d\udd12 Authentication Failed\",\n        ScStatus == 403, \"\ud83d\udeab Authorization Failed\",\n        ScStatus == 429, \"\u23f1\ufe0f Rate Limit Triggered\",\n        ScStatus < 500, \"\u274c Client Error\",\n        \"\u26a0\ufe0f Server Error\"\n    ),\n    SecurityRisk = case(\n        ScStatus == 401 or ScStatus == 403, \"\ud83d\udd34 High Risk\",\n        ScStatus == 429, \"\ud83d\udfe1 Medium Risk\",\n        ScStatus < 300, \"\ud83d\udfe2 Normal\",\n        \"\ud83d\udfe0 Needs Attention\"\n    )\n| summarize \n    CallCount = count(),\n    SuccessRate = round(todouble(countif(ScStatus < 300)) / todouble(count()) * 100, 1),\n    AuthFailures = countif(ScStatus == 401),\n    AuthzFailures = countif(ScStatus == 403),\n    RateLimited = countif(ScStatus == 429),\n    UniqueClients = dcount(CIp),\n    AvgResponseTime = round(avg(TimeTaken), 2),\n    LastActivity = max(TimeGenerated)\n  by APIEndpoint, SecurityRisk\n| project \n    ['API Endpoint'] = APIEndpoint,\n    ['Security Status'] = SecurityRisk,\n    ['Calls'] = CallCount,\n    ['成功率 %'] = SuccessRate,\n    ['Authentication Failures'] = AuthFailures,\n    ['Authorization Failures'] = AuthzFailures,\n    ['Rate Limit Hits'] = RateLimited,\n    ['Unique Clients'] = UniqueClients,\n    ['Average Response Time'] = AvgResponseTime,\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm')\n| order by ['Calls'] desc",
                            "size": 0,
                            "title": "\ud83d\udd10 AI API安全监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Security Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "成功率 %",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "api_security_monitoring_fixed",
                        "id": "d1f9a6ff-351a-4122-b701-dcf95d0cd80a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI API性能与可靠性监控 (final version)\nlet aiApiEndpoints = dynamic([\n    \"openai.azure.com\", \"api.openai.com\", \"cognitive.microsoft.com\",\n    \"/chat/completions\", \"/completions\", \"/embeddings\", \"/models\",\n    \"copilot\", \"ai-studio\", \"machinelearning\", \"cognitiveservices\"\n]);\n\n// 性能监控 based on AppServiceHTTPLogs\nAppServiceHTTPLogs\n| where TimeGenerated > ago(24h)\n| where CsHost has_any (aiApiEndpoints) or CsUriStem has_any (aiApiEndpoints)\n| extend \n    APIEndpoint = case(\n        CsUriStem has \"/chat/completions\", \"\ud83d\udcac Chat Completions\",\n        CsUriStem has \"/completions\", \"\ud83d\udcdd Text Completions\", \n        CsUriStem has \"/embeddings\", \"\ud83d\udd22 Embeddings\",\n        CsUriStem has \"/models\", \"\ud83e\udd16 Models\",\n        CsHost has \"openai.azure.com\", \"\u2601\ufe0f Azure OpenAI\",\n        CsHost has \"api.openai.com\", \"\ud83c\udf10 OpenAI API\",\n        CsHost has \"cognitive.microsoft.com\", \"\ud83e\udde0 Cognitive Services\",\n        \"\u2699\ufe0f Other AI APIs\"\n    ),\n    ResponseCategory = case(\n        ScStatus < 300, \"\u2705 Successful Response\",\n        ScStatus == 401, \"\ud83d\udd12 Authentication Failed\",\n        ScStatus == 403, \"\ud83d\udeab Authorization Failed\",\n        ScStatus == 429, \"\u23f1\ufe0f Rate Limit Triggered\",\n        ScStatus == 500, \"\u274c Server Error\",\n        ScStatus == 502, \"\ud83d\udea7 Gateway Error\",\n        ScStatus == 503, \"\u26a0\ufe0f Service Unavailable\",\n        ScStatus == 504, \"\u23f0 Gateway Timeout\",\n        ScStatus < 500, \"\u26a0\ufe0f Client Error\",\n        \"\u274c Server Error\"\n    ),\n    PerformanceCategory = case(\n        TimeTaken <= 1000, \"\ud83d\udfe2 Excellent (<1s)\",\n        TimeTaken <= 3000, \"\ud83d\udfe1 Good (1-3s)\",\n        TimeTaken <= 10000, \"\ud83d\udfe0 Fair (3-10s)\",\n        TimeTaken <= 30000, \"\ud83d\udd34 Slow (10-30s)\",\n        \"\ud83d\udd25 Very Slow (>30s)\"\n    ),\n    HourlyBucket = bin(TimeGenerated, 1h)\n| summarize \n    RequestCount = count(),\n    SuccessCount = countif(ScStatus < 300),\n    ClientErrorCount = countif(ScStatus >= 400 and ScStatus < 500),\n    ServerErrorCount = countif(ScStatus >= 500),\n    AuthErrorCount = countif(ScStatus == 401 or ScStatus == 403),\n    RateLimitCount = countif(ScStatus == 429),\n    AvgResponseTime = round(avg(TimeTaken), 0),\n    P50ResponseTime = round(percentile(TimeTaken, 50), 0),\n    P95ResponseTime = round(percentile(TimeTaken, 95), 0),\n    P99ResponseTime = round(percentile(TimeTaken, 99), 0),\n    MaxResponseTime = round(max(TimeTaken), 0),\n    UniqueClients = dcount(CIp),\n    TotalBandwidth = round(sum(CsBytes) / 1024.0 / 1024.0, 2)\n  by APIEndpoint, HourlyBucket\n| extend \n    SuccessRate = round(todouble(SuccessCount) / todouble(RequestCount) * 100, 2),\n    ErrorRate = round(todouble(ClientErrorCount + ServerErrorCount) / todouble(RequestCount) * 100, 2),\n    PerformanceScore = case(\n        AvgResponseTime <= 1000 and SuccessRate >= 99, 95,\n        AvgResponseTime <= 3000 and SuccessRate >= 95, 85,\n        AvgResponseTime <= 10000 and SuccessRate >= 90, 75,\n        AvgResponseTime <= 30000 and SuccessRate >= 80, 65,\n        50\n    )\n| extend\n    HealthStatus = case(\n        PerformanceScore >= 90, \"\ud83d\udfe2 Healthy\",\n        PerformanceScore >= 75, \"\ud83d\udfe1 Needs Attention\",\n        PerformanceScore >= 60, \"\ud83d\udfe0 Warning\",\n        \"\ud83d\udd34 Critical\"\n    ),\n    Availability = case(\n        SuccessRate >= 99.9, \"\ud83d\udfe2 Excellent (99.9%+)\",\n        SuccessRate >= 99.5, \"\ud83d\udfe1 Good (99.5%+)\",\n        SuccessRate >= 99.0, \"\ud83d\udfe0 Fair (99.0%+)\",\n        \"\ud83d\udd34 Poor (<99%)\"\n    )\n| project \n    ['API Endpoint'] = APIEndpoint,\n    ['Time Window'] = format_datetime(HourlyBucket, 'MM-dd HH:mm'),\n    ['Health Status'] = HealthStatus,\n    ['Availability'] = Availability,\n    ['Performance Score'] = PerformanceScore,\n    ['Total Requests'] = RequestCount,\n    ['成功率 %'] = SuccessRate,\n    ['Error Rate %'] = ErrorRate,\n    ['Authentication Errors'] = AuthErrorCount,\n    ['Rate Limit Hits'] = RateLimitCount,\n    ['Average Response Time'] = AvgResponseTime,\n    ['P95 Response Time'] = P95ResponseTime,\n    ['P99 Response Time'] = P99ResponseTime,\n    ['Max Response Time'] = MaxResponseTime,\n    ['Unique Clients'] = UniqueClients,\n    ['Bandwidth (MB)'] = TotalBandwidth\n| order by ['Time Window'] desc, ['Total Requests'] desc\n| take 50",
                            "size": 0,
                            "title": "\ud83d\udcca AI API性能与可靠性监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Health Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "成功率 %",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "Performance Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "api_performance_monitoring",
                        "id": "1d7111b6-d329-41fb-8f35-01dc994db81f"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "ai_api"
            },
            "name": "ai_api_group",
            "id": "1f5e156b-29fe-466b-b3b0-ebc7894d68e1"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #20c997, #198754); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83c\udfaf 深度用户行为分析</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图分析AI应用使用中的用户行为模式，机器学习高亮异常会话、标记高风险用户并可视化访问趋势，帮助安全团队建立行为基线、检测内部威胁并强化账户防护。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0fdf4; padding: 10px; border-left: 4px solid #20c997; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #20c997;\">\ud83d\udca1 行为洞察</h4>\n    <p style=\"font-size: 13px; color: #333;\">刻画AI应用中的典型用户旅程以建立行为基线。</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0fdf4; padding: 10px; border-left: 4px solid #20c997; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #20c997;\">\ud83d\udd0d 异常检测</h4>\n    <p style=\"font-size: 13px; color: #333;\">使用机器学习发现异常访问模式与可疑用户行为。</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "behavior_header",
                        "id": "654ff484-3833-4387-8065-d04dd82b4ffe"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 用户AI应用访问行为分析 (revised)\nlet allAIApps = dynamic([\n    \"chat\", \"copilot\", \"ai\", \"gpt\", \"claude\", \"bard\", \"gemini\", \n    \"chatgpt\", \"openai\", \"anthropic\", \"perplexity\", \"character.ai\",\n    \"replika\", \"jasper\", \"writesonic\", \"copy.ai\", \"notion ai\",\n    \"grammarly\", \"bing chat\", \"you.com\", \"poe\", \"huggingface\",\n    \"microsoft copilot\", \"github copilot\", \"azure openai\", \"bing chat enterprise\",\n    \"google bard\", \"amazon codewhisperer\", \"tabnine\", \"codeium\",\n    \"chatbot\", \"conversational ai\", \"llm\", \"language model\"\n]);\n\nlet userEntraData = IdentityInfo\n| project \n    UPN = tostring(AccountUPN),\n    Department = tostring(Department),\n    JobTitle = tostring(JobTitle),\n    Manager = tostring(Manager)\n| where isnotempty(UPN);\n\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (allAIApps)\n| extend \n    SessionHour = datetime_part(\"hour\", TimeGenerated),\n    SessionDayOfWeek = dayofweek(TimeGenerated)\n| extend\n    IsWeekend = (SessionDayOfWeek == 0 or SessionDayOfWeek == 6),\n    IsAfterHours = (SessionHour < 8 or SessionHour > 18)\n| extend\n    DeviceOS = tostring(parse_json(tostring(DeviceDetail)).operatingSystem),\n    Browser = tostring(parse_json(tostring(DeviceDetail)).browser)\n| extend\n    // Unified device categorization\n    DeviceCategory = case(\n        // Unified Windows category (all versions) - comprehensive matching to catch Windows 10, Windows 11, etc.\n        DeviceOS has \"Windows\" or DeviceOS has \"windows\" or DeviceOS has \"WINDOWS\" or\n        DeviceOS has \"Win32\" or DeviceOS has \"win32\" or DeviceOS has \"Win64\" or DeviceOS has \"win64\" or\n        DeviceOS has \"Win10\" or DeviceOS has \"Win 10\" or DeviceOS has \"Win11\" or DeviceOS has \"Win 11\" or\n        DeviceOS has \"Win7\" or DeviceOS has \"Win 7\" or DeviceOS has \"Win8\" or DeviceOS has \"Win 8\" or\n        DeviceOS has \"NT\" or DeviceOS has \"Microsoft Windows\" or\n        DeviceOS startswith \"Win\" or DeviceOS startswith \"win\", \"Windows\",\n        DeviceOS has \"macOS\" or DeviceOS has \"Mac OS\" or DeviceOS has \"OSX\" or DeviceOS has \"OS X\" or DeviceOS has \"Darwin\", \"macOS\",\n        DeviceOS has \"iOS\" or DeviceOS has \"iPhone\" or DeviceOS has \"iPad\", \"iOS\",\n        DeviceOS has \"Android\", \"Android\",\n        DeviceOS has \"Linux\" or DeviceOS has \"Ubuntu\" or DeviceOS has \"CentOS\" or DeviceOS has \"RedHat\" or DeviceOS has \"Debian\" or DeviceOS has \"SUSE\", \"Linux\",\n        DeviceOS has \"Chrome OS\" or DeviceOS has \"ChromeOS\", \"Chrome OS\",\n        isnotempty(DeviceOS), DeviceOS,\n        \"Unknown\"\n    ),\n    ExtractedDept = extract(@\"@([^.]+)\\.\", 1, UserPrincipalName)\n| join kind=leftouter (userEntraData) on $left.UserPrincipalName == $right.UPN\n| summarize \n    TotalSessions = count(),\n    UniqueApps = dcount(AppDisplayName),\n    WeekendSessions = countif(IsWeekend),\n    AfterHoursSessions = countif(IsAfterHours),\n    UniqueDevices = dcount(DeviceCategory),\n    UniqueLocations = dcount(Location),\n    FirstAccess = min(TimeGenerated),\n    LastAccess = max(TimeGenerated),\n    TopApps = make_set(AppDisplayName, 3)\n  by UserPrincipalName, Department, JobTitle, Manager, ExtractedDept\n| extend \n    FinalDepartment = coalesce(Department, ExtractedDept, \"Unknown\"),\n    BehaviorScore = case(\n        AfterHoursSessions > TotalSessions * 0.5, 3,\n        WeekendSessions > TotalSessions * 0.3, 2,\n        UniqueLocations > 5, 2,\n        1\n    )\n| extend\n    RiskProfile = case(\n        BehaviorScore >= 3, \"\ud83d\udd34 High-Risk User\",\n        BehaviorScore >= 2, \"\ud83d\udfe0 Moderate Risk\",\n        \"\ud83d\udfe2 Typical User\"\n    ),\n    UsagePattern = case(\n        TotalSessions >= 100, \"\ud83d\udd25 Heavy User\",\n        TotalSessions >= 50, \"\ud83d\udd34 Active User\",\n        TotalSessions >= 20, \"\ud83d\udfe1 Regular User\",\n        \"\ud83d\udfe2 Light User\"\n    )\n| project \n    ['User'] = UserPrincipalName,\n    ['Department'] = FinalDepartment,\n    ['Job Title'] = coalesce(JobTitle, \"Unknown\"),\n    ['Usage Pattern'] = UsagePattern,\n    ['风险等级'] = RiskProfile,\n    ['总会话数'] = TotalSessions,\n    ['应用数量'] = UniqueApps,\n    ['Weekend Sessions'] = WeekendSessions,\n    ['After-hours Sessions'] = AfterHoursSessions,\n    ['Device Count'] = UniqueDevices,\n    ['Location Count'] = UniqueLocations,\n    ['First Access'] = format_datetime(FirstAccess, 'MM-dd HH:mm'),\n    ['Last Access'] = format_datetime(LastAccess, 'MM-dd HH:mm'),\n    ['Top Applications'] = tostring(TopApps)\n| order by ['总会话数'] desc\n| take 50",
                            "size": 0,
                            "title": "\ud83d\udc64 用户AI应用访问行为分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "总会话数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    }
                                ],
                                "hierarchySettings": {
                                    "treeType": 1,
                                    "groupBy": [
                                        "Department"
                                    ],
                                    "expandTopLevel": false
                                }
                            }
                        },
                        "name": "user_behavior_analysis",
                        "id": "59f7bfd1-0eb7-4d10-9a11-3b5b3bd7110b"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI使用时间模式分析\nlet allAIApps = dynamic([\"chat\", \"copilot\", \"ai\", \"gpt\", \"claude\", \"bard\"]);\n\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (allAIApps)\n| extend \n    Hour = datetime_part(\"hour\", TimeGenerated),\n    DayOfWeek = dayofweek(TimeGenerated)\n| extend\n    DayName = case(\n        DayOfWeek == 0, \"\ud83d\udcc5 Sunday\",\n        DayOfWeek == 1, \"\ud83d\udcc5 Monday\",\n        DayOfWeek == 2, \"\ud83d\udcc5 Tuesday\",\n        DayOfWeek == 3, \"\ud83d\udcc5 Wednesday\",\n        DayOfWeek == 4, \"\ud83d\udcc5 Thursday\",\n        DayOfWeek == 5, \"\ud83d\udcc5 Friday\",\n        \"\ud83d\udcc5 Saturday\"\n    ),\n    TimeSlot = case(\n        Hour >= 0 and Hour < 6, \"\ud83c\udf19 Late Night (0-6)\",\n        Hour >= 6 and Hour < 9, \"\ud83c\udf05 Early Morning (6-9)\",\n        Hour >= 9 and Hour < 12, \"\u2600\ufe0f Morning (9-12)\",\n        Hour >= 12 and Hour < 14, \"\ud83c\udf7d\ufe0f Lunch (12-14)\",\n        Hour >= 14 and Hour < 18, \"\ud83c\udf24\ufe0f Afternoon (14-18)\",\n        Hour >= 18 and Hour < 22, \"\ud83c\udf06 Evening (18-22)\",\n        \"\ud83c\udf03 Late Evening (22-24)\"\n    )\n| summarize \n    SessionCount = count(),\n    UniqueUsers = dcount(UserPrincipalName)\n  by DayName, TimeSlot\n| project \n    ['Day'] = DayName,\n    ['Time Slot'] = TimeSlot,\n    ['Sessions'] = SessionCount,\n    ['Users'] = UniqueUsers,\n    ['Avg Sessions per User'] = round(todouble(SessionCount) / todouble(UniqueUsers), 1)\n| order by ['Sessions'] desc",
                            "size": 0,
                            "title": "\u23f0 AI使用时间模式分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sessions",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Users",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "green"
                                        }
                                    },
                                    {
                                        "columnMatch": "Avg Sessions per User",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "hierarchySettings": {
                                    "treeType": 1,
                                    "groupBy": [
                                        "Day"
                                    ],
                                    "expandTopLevel": true
                                }
                            }
                        },
                        "name": "time_pattern_analysis",
                        "id": "115ef1bc-e408-4d28-9b6e-66d5914619da"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI application browser and operating system distribution analysis (revised)\nlet allAIApps = dynamic([\"chat\", \"copilot\", \"ai\", \"gpt\", \"claude\", \"bard\"]);\n\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (allAIApps)\n| extend \n    DeviceOS = tostring(parse_json(tostring(DeviceDetail)).operatingSystem),\n    Browser = tostring(parse_json(tostring(DeviceDetail)).browser)\n| extend\n    // Unified device categorization - Windows as one category\n    DeviceCategory = case(\n        // Unified Windows category (all versions) - comprehensive matching to catch Windows 10, Windows 11, etc.\n        DeviceOS has \"Windows\" or DeviceOS has \"windows\" or DeviceOS has \"WINDOWS\" or\n        DeviceOS has \"Win32\" or DeviceOS has \"win32\" or DeviceOS has \"Win64\" or DeviceOS has \"win64\" or\n        DeviceOS has \"Win10\" or DeviceOS has \"Win 10\" or DeviceOS has \"Win11\" or DeviceOS has \"Win 11\" or\n        DeviceOS has \"Win7\" or DeviceOS has \"Win 7\" or DeviceOS has \"Win8\" or DeviceOS has \"Win 8\" or\n        DeviceOS has \"NT\" or DeviceOS has \"Microsoft Windows\" or\n        DeviceOS startswith \"Win\" or DeviceOS startswith \"win\", \"\ud83d\udcbb Windows\",\n        // macOS categorization\n        DeviceOS has \"macOS\" or DeviceOS has \"Mac OS\" or DeviceOS has \"OSX\" or DeviceOS has \"OS X\" or DeviceOS has \"Darwin\", \"\ud83c\udf4e macOS\",\n        // Mobile devices\n        DeviceOS has \"iOS\" or DeviceOS has \"iPhone\" or DeviceOS has \"iPad\", \"\ud83d\udcf1 iOS\",\n        DeviceOS has \"Android\", \"\ud83e\udd16 Android\",\n        // Linux variants\n        DeviceOS has \"Linux\" or DeviceOS has \"Ubuntu\" or DeviceOS has \"CentOS\" or DeviceOS has \"RedHat\" or DeviceOS has \"Debian\" or DeviceOS has \"SUSE\", \"\ud83d\udc27 Linux\",\n        DeviceOS has \"Chrome OS\" or DeviceOS has \"ChromeOS\", \"\ud83c\udf10 Chrome OS\",\n        isnotempty(DeviceOS), strcat(\"\u2753 \", DeviceOS),\n        \"\u2753 Unknown Device\"\n    ),\n    // Optimized browser categorization\n    BrowserCategory = case(\n        Browser has \"Chrome\" and not (Browser has \"Edge\"), \"\ud83c\udf10 Chrome\",\n        Browser has \"Firefox\", \"\ud83e\udd8a Firefox\",\n        Browser has \"Safari\" and not (Browser has \"Chrome\"), \"\ud83e\udded Safari\",\n        Browser has \"Edge\" or Browser has \"Microsoft Edge\", \"\ud83c\udf0a Edge\",\n        Browser has \"Opera\", \"\ud83c\udfad Opera\",\n        Browser has \"Internet Explorer\" or Browser has \"IE\", \"\u26a0\ufe0f IE\",\n        isnotempty(Browser), strcat(\"\u2753 \", Browser),\n        \"\u2753 Unknown Browser\"\n    ),\n    // Enhanced browser version assessment\n    BrowserVersion = case(\n        Browser has \"Chrome\", extract(@\"Chrome\\s?([0-9.]+)\", 1, Browser),\n        Browser has \"Firefox\", extract(@\"Firefox\\s?([0-9.]+)\", 1, Browser),\n        Browser has \"Safari\", extract(@\"Safari\\s?([0-9.]+)\", 1, Browser),\n        Browser has \"Edge\" or Browser has \"Microsoft Edge\", extract(@\"(?:Edge|Microsoft Edge)\\s?([0-9.]+)\", 1, Browser),\n        Browser has \"Opera\", extract(@\"Opera\\s?([0-9.]+)\", 1, Browser),\n        \"Unknown Version\"\n    )\n| summarize \n    UniqueUsers = dcount(UserPrincipalName),\n    TotalSessions = count(),\n    LastActivity = max(TimeGenerated),\n    TopApps = make_set(AppDisplayName, 3)\n  by DeviceCategory, BrowserCategory, BrowserVersion\n| extend \n    UsageLevel = case(\n        TotalSessions >= 100, \"\ud83d\udd25 High Usage\",\n        TotalSessions >= 50, \"\ud83d\udfe0 Moderate Usage\",\n        TotalSessions >= 10, \"\ud83d\udfe1 Low Usage\",\n        \"\ud83d\udfe2 Occasional Usage\"\n    )\n| extend\n    SecurityRisk = case(\n        BrowserVersion == \"Unknown Version\", \"\u26aa Version Unknown\",\n        // Browser version 风险评估\n        BrowserCategory == \"\ud83c\udf10 Chrome\" and toint(split(BrowserVersion, \".\")[0]) < 100, \"\ud83d\udd34 Chrome Version Outdated\",\n        BrowserCategory == \"\ud83e\udd8a Firefox\" and toint(split(BrowserVersion, \".\")[0]) < 90, \"\ud83d\udd34 Firefox Version Outdated\",\n        BrowserCategory == \"\ud83e\udded Safari\" and toint(split(BrowserVersion, \".\")[0]) < 15, \"\ud83d\udd34 Safari Version Outdated\",\n        BrowserCategory == \"\ud83c\udf0a Edge\" and toint(split(BrowserVersion, \".\")[0]) < 100, \"\ud83d\udd34 Edge Version Outdated\",\n        BrowserCategory == \"\u26a0\ufe0f IE\", \"\ud83d\udd25 Internet Explorer High Risk\",\n        \"\ud83d\udfe2 Versions Relatively Secure\"\n    )\n| project \n    ['Device Type'] = DeviceCategory,\n    ['Browser Type'] = BrowserCategory,\n    ['Browser Version'] = BrowserVersion,\n    ['Users'] = UniqueUsers,\n    ['Sessions'] = TotalSessions,\n    ['使用频率'] = UsageLevel,\n    ['Security Risk'] = SecurityRisk,\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm'),\n    ['Top Applications'] = tostring(TopApps)\n| order by ['Sessions'] desc\n| take 50",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sessions",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Security Risk",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Users",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    }
                                ],
                                "hierarchySettings": {
                                    "treeType": 1,
                                    "groupBy": [
                                        "Device Type"
                                    ],
                                    "expandTopLevel": true
                                }
                            }
                        },
                        "name": "browser_system_analysis",
                        "id": "0813ca49-0a0c-47c3-9de4-911dc97f864f"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Anomalous behavior detection analysis (final revision)\nlet allAIApps = dynamic([\"chat\", \"copilot\", \"ai\", \"gpt\", \"claude\", \"bard\"]);\n\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (allAIApps)\n| extend \n    Hour = datetime_part(\"hour\", TimeGenerated),\n    DayOfWeek = dayofweek(TimeGenerated)\n| extend\n    IsWeekend = (DayOfWeek == 0 or DayOfWeek == 6),\n    IsNightTime = (Hour >= 22 or Hour <= 5),\n    IsEarlyMorning = (Hour >= 6 and Hour <= 8),\n    IsBusinessHours = (Hour >= 9 and Hour <= 17 and not(DayOfWeek == 0 or DayOfWeek == 6))\n| summarize \n    TotalLogins = count(),\n    WeekendLogins = countif(IsWeekend),\n    NightLogins = countif(IsNightTime),\n    EarlyMorningLogins = countif(IsEarlyMorning),\n    BusinessHoursLogins = countif(IsBusinessHours),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueLocations = dcount(Location),\n    FirstLogin = min(TimeGenerated),\n    LastLogin = max(TimeGenerated),\n    LoginDays = dcount(bin(TimeGenerated, 1d))\n  by UserPrincipalName\n| project \n    UserPrincipalName,\n    TotalLogins,\n    WeekendLogins,\n    NightLogins,\n    EarlyMorningLogins,\n    BusinessHoursLogins,\n    UniqueApps,\n    UniqueLocations,\n    FirstLogin,\n    LastLogin,\n    LoginDays,\n    WeekendRatio = round(todouble(WeekendLogins) / todouble(TotalLogins) * 100, 1),\n    NightRatio = round(todouble(NightLogins) / todouble(TotalLogins) * 100, 1),\n    BusinessHoursRatio = round(todouble(BusinessHoursLogins) / todouble(TotalLogins) * 100, 1)\n| extend\n    AnomalyScore = case(\n        WeekendRatio > 50, 3,\n        NightRatio > 30, 3,\n        UniqueLocations > 10, 2,\n        WeekendRatio > 30 or NightRatio > 20, 2,\n        UniqueLocations > 5, 1,\n        0\n    )\n| extend\n    BehaviorType = case(\n        AnomalyScore >= 3, \"\ud83d\udd34 Severe Anomaly\",\n        AnomalyScore >= 2, \"\ud83d\udfe0 Moderate Anomaly\",\n        AnomalyScore >= 1, \"\ud83d\udfe1 Minor Anomaly\",\n        \"\ud83d\udfe2 Normal Behavior\"\n    )\n| where AnomalyScore > 0  // Display only users with anomalies\n| project \n    ['User'] = UserPrincipalName,\n    ['Behavior Type'] = BehaviorType,\n    ['Anomaly Score'] = AnomalyScore,\n    ['总登录次数'] = TotalLogins,\n    ['Weekend Sign-in Ratio'] = strcat(tostring(WeekendRatio), \"%\"),\n    ['Night Sign-in Ratio'] = strcat(tostring(NightRatio), \"%\"),\n    ['Business Hours Ratio'] = strcat(tostring(BusinessHoursRatio), \"%\"),\n    ['Location Count'] = UniqueLocations,\n    ['Applications Used'] = UniqueApps,\n    ['Active Days'] = LoginDays,\n    ['First Sign-in'] = format_datetime(FirstLogin, 'MM-dd HH:mm'),\n    ['Last Sign-in'] = format_datetime(LastLogin, 'MM-dd HH:mm')\n| order by ['Anomaly Score'] desc, ['总登录次数'] desc\n| take 30",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Behavior Type",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Anomaly Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redGreen"
                                        }
                                    },
                                    {
                                        "columnMatch": "总登录次数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Location Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "anomaly_detection",
                        "id": "846e2f8e-caea-487d-ac9e-ec00bd8d03b9"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// 地理访问模式分析 (revised)\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where isnotempty(UserPrincipalName) and isnotempty(AppDisplayName) and isnotempty(Location)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"chat\", \"copilot\", \"ai\", \"gpt\", \"claude\", \"bard\")\n| extend \n    Country = case(\n        Location == \"US\", \"\ud83c\uddfa\ud83c\uddf8 United States\",\n        Location == \"CN\", \"\ud83c\udde8\ud83c\uddf3 China\",\n        Location == \"JP\", \"\ud83c\uddef\ud83c\uddf5 Japan\",\n        Location == \"SG\", \"\ud83c\uddf8\ud83c\uddec Singapore\",\n        Location == \"GB\", \"\ud83c\uddec\ud83c\udde7 United Kingdom\",\n        Location == \"DE\", \"\ud83c\udde9\ud83c\uddea Germany\",\n        Location == \"FR\", \"\ud83c\uddeb\ud83c\uddf7 France\",\n        Location == \"IN\", \"\ud83c\uddee\ud83c\uddf3 India\",\n        Location == \"KR\", \"\ud83c\uddf0\ud83c\uddf7 South Korea\",\n        Location == \"AU\", \"\ud83c\udde6\ud83c\uddfa Australia\",\n        Location == \"CA\", \"\ud83c\udde8\ud83c\udde6 Canada\",\n        Location == \"BR\", \"\ud83c\udde7\ud83c\uddf7 Brazil\",\n        Location == \"RU\", \"\ud83c\uddf7\ud83c\uddfa Russia\",\n        Location == \"IT\", \"\ud83c\uddee\ud83c\uddf9 Italy\",\n        Location == \"ES\", \"\ud83c\uddea\ud83c\uddf8 Spain\",\n        Location == \"NL\", \"\ud83c\uddf3\ud83c\uddf1 Netherlands\",\n        Location == \"SE\", \"\ud83c\uddf8\ud83c\uddea Sweden\",\n        Location == \"NO\", \"\ud83c\uddf3\ud83c\uddf4 Norway\",\n        Location == \"DK\", \"\ud83c\udde9\ud83c\uddf0 Denmark\",\n        Location == \"FI\", \"\ud83c\uddeb\ud83c\uddee Finland\",\n        Location\n    )\n| summarize \n    UniqueUsers = dcount(UserPrincipalName),\n    TotalLogins = count(),\n    UniqueApps = dcount(AppDisplayName),\n    LastActivity = max(TimeGenerated)\n  by Country, Location\n| extend \n    UsageIntensity = case(\n        TotalLogins >= 1000, \"\ud83d\udd25 Extremely High Usage\",\n        TotalLogins >= 500, \"\ud83d\udfe0 High Usage\",\n        TotalLogins >= 100, \"\ud83d\udfe1 Moderate Usage\",\n        TotalLogins >= 10, \"\ud83d\udfe2 Low Usage\",\n        \"\u26aa Occasional Usage\"\n    ),\n    SecurityConcern = case(\n        Location in (\"CN\", \"RU\", \"IR\", \"KP\"), \"\ud83d\udd34 High Security Concern\",\n        Location in (\"US\", \"GB\", \"CA\", \"AU\", \"DE\", \"FR\", \"JP\", \"SG\"), \"\ud83d\udfe2 Low Security Concern\",\n        \"\ud83d\udfe1 Medium Security Concern\"\n    )\n| project \n    ['Country/Region'] = Country,\n    ['Location Code'] = Location,\n    ['用户数'] = UniqueUsers,\n    ['总会话数'] = TotalLogins,\n    ['Usage Intensity'] = UsageIntensity,\n    ['Security Level'] = SecurityConcern,\n    ['应用数量'] = UniqueApps,\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm')\n| order by ['总会话数'] desc\n| take 25",
                            "size": 0,
                            "title": "\ud83c\udf0d 地理访问模式分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "总会话数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Security Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "用户数",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "geographic_access_patterns",
                        "id": "1edaf02c-e47b-4f00-94f5-b7a1d751ed99"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Advanced Anomalous Behavior Detection - Insider Risk & XDR\n// Multi-source behavioral 异常检测 for AI applications\nlet t0 = {TimeRange:start};\nlet baselineWindow = 30d;\n// Calculate baseline behavior\nlet userBaseline = SigninLogs\n| where TimeGenerated between ((t0 - baselineWindow) .. t0)\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"ai\", \"copilot\", \"chat\", \"gpt\", \"openai\", \"azure\", \"microsoft\")\n| summarize\n    AvgDailySignins = todouble(count()) / 30.0,\n    UniqueLocations = todouble(dcount(Location)),\n    UniqueIPs = todouble(dcount(IPAddress)),\n    UniqueApps = todouble(dcount(AppDisplayName))\n  by UserPrincipalName;\n// Detect anomalies in current period\nlet currentBehavior = SigninLogs\n| where TimeGenerated > t0\n| extend AppNameLower = tolower(AppDisplayName)\n| where AppNameLower has_any (\"ai\", \"copilot\", \"chat\", \"gpt\", \"openai\", \"azure\", \"microsoft\")\n| summarize\n    CurrentSignins = todouble(count()),\n    CurrentLocations = todouble(dcount(Location)),\n    CurrentIPs = todouble(dcount(IPAddress)),\n    CurrentApps = todouble(dcount(AppDisplayName)),\n    LocationList = make_set(Location, 3),\n    IPList = make_set(IPAddress, 3),\n    LastActivity = max(TimeGenerated)\n  by UserPrincipalName;\n// Join and analyze\ncurrentBehavior\n| join kind=leftouter (userBaseline) on UserPrincipalName\n| extend\n    BaselineSignins = coalesce(AvgDailySignins, 1.0),\n    BaselineLocations = coalesce(UniqueLocations, 1.0),\n    BaselineIPs = coalesce(UniqueIPs, 1.0)\n| extend\n    SigninAnomaly = (CurrentSignins > (BaselineSignins * 2.0)),\n    LocationAnomaly = (CurrentLocations > (BaselineLocations + 1.0)),\n    IPAnomaly = (CurrentIPs > (BaselineIPs + 1.0)),\n    NewUser = isempty(AvgDailySignins)\n| extend\n    AnomalyScore = \n        toint(SigninAnomaly) * 3 +\n        toint(LocationAnomaly) * 2 +\n        toint(IPAnomaly) * 2 +\n        toint(NewUser) * 1\n| extend\n    AnomalyType = case(\n        SigninAnomaly and LocationAnomaly, \"\ud83d\udd34 Excessive Access + Location Anomaly\",\n        SigninAnomaly, \"\ud83d\udfe0 Excessive AI Access\",\n        LocationAnomaly, \"\ud83d\udfe1 Unusual Location Access\",\n        IPAnomaly, \"\ud83d\udfe0 IP Address Anomaly\",\n        NewUser, \"\ud83d\udfe2 New AI User\",\n        \"\u26aa Normal Behavior\"\n    ),\n    ThreatLevel = case(\n        AnomalyScore >= 5, \"\ud83d\udd25 Critical Anomaly\",\n        AnomalyScore >= 3, \"\ud83d\udd34 High Anomaly\",\n        AnomalyScore >= 2, \"\ud83d\udfe0 Medium Anomaly\",\n        \"\ud83d\udfe1 Low Anomaly\"\n    )\n| project\n    ['User'] = UserPrincipalName,\n    ['Threat Level'] = ThreatLevel,\n    ['Anomaly Type'] = AnomalyType,\n    ['Anomaly Score'] = AnomalyScore,\n    ['Current Activity Count'] = toint(CurrentSignins),\n    ['Baseline Daily Avg'] = round(BaselineSignins, 1),\n    ['Locations/Devices'] = strcat_array(LocationList, \", \"),\n    ['IP Addresses'] = strcat_array(IPList, \", \"),\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm')\n| order by ['Anomaly Score'] desc, ['Current Activity Count'] desc\n| take 50",
                            "size": 0,
                            "title": "\ud83d\udd0d 高级异常行为检测 - 内部风险与XDR集成",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Threat Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Anomaly Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Current Activity Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "anomalous_behavior_detection"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "behavior"
            },
            "name": "behavior_group",
            "id": "5cd90e57-74a5-43a3-89ad-bcce1c505424"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #343a40, #212529); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\u23f1\ufe0f AI安全时间相关性分析</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图探索AI使用与安全事件的时间关联。通过关联工作负载与告警，安全团队可定位攻击窗口、预测威胁爆发并理解行为触发因素，从而优化监控计划。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f8f4ff; padding: 10px; border-left: 4px solid #343a40; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #343a40;\">\ud83d\udd17 时间关联</h4>\n    <p style=\"font-size: 13px; color: #333;\">分析AI活动与安全事件的时间相关性。</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f8f4ff; padding: 10px; border-left: 4px solid #343a40; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #343a40;\">\ud83d\udcc8 趋势预测</h4>\n    <p style=\"font-size: 13px; color: #333;\">利用历史模式与机器学习预测即将发生的威胁活动。</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "timeline_header",
                        "id": "a8c1f2e2-a1e2-4b96-aeeb-10a9d307194c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI usage and security event time correlation analysis (revised)\nlet timeWindow = 1h; // Time window: analyze correlations within one hour\n\n// Retrieve AI usage activity\nlet aiUsage = SigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n| extend UsageHour = bin(TimeGenerated, 1h)\n| summarize \n    UsageCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    UsageUsers = make_set(UserPrincipalName, 10)\n  by UsageHour\n| extend EventType = \"\ud83d\udcbc AI Usage Activity\";\n\n// Retrieve security alerts\nlet securityEvents = SecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Jailbreak\", \"Prompt\", \"AI\", \"Model\")\n| extend ThreatHour = bin(TimeGenerated, 1h)\n| summarize \n    ThreatCount = count(),\n    High严重级别Count = countif(Alert严重级别 == \"High\"),\n    ThreatResources = make_set(CompromisedEntity, 5)\n  by ThreatHour\n| extend EventType = \"\ud83d\udea8 Security Threat\";\n\n// Merge analysis\naiUsage\n| join kind=fullouter (securityEvents) on $left.UsageHour == $right.ThreatHour\n| extend \n    TimeHour = coalesce(UsageHour, ThreatHour),\n    UsageCount = coalesce(UsageCount, 0),\n    ThreatCount = coalesce(ThreatCount, 0),\n    UniqueUsers = coalesce(UniqueUsers, 0),\n    High严重级别Count = coalesce(High严重级别Count, 0)\n| extend \n    CorrelationRisk = case(\n        ThreatCount > 0 and UsageCount > 0, \"\ud83d\udd34 High-Risk Window\",\n        ThreatCount > 0, \"\ud83d\udfe0 Threat Active\",\n        UsageCount > 0, \"\ud83d\udfe2 Normal Usage\",\n        \"\u26aa No Activity\"\n    )\n| project \n    ['Time Window'] = format_datetime(TimeHour, 'MM-dd HH:mm'),\n    ['Correlation Risk'] = CorrelationRisk,\n    ['AI使用次数'] = UsageCount,\n    ['Security Threat Count'] = ThreatCount,\n    ['High-严重级别 Threats'] = High严重级别Count,\n    ['Active Users'] = UniqueUsers\n| order by ['Time Window'] desc\n| take 50",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Correlation Risk",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Security Threat Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "AI使用次数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "time_correlation_analysis",
                        "id": "38e7577d-9886-44f9-879f-4f6b2b26cd3a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI usage and security events timeline visualization\nlet aiUsage = SigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n| summarize AIUsage = count() by bin(TimeGenerated, 1h)\n| extend EventType = \"AI Usage\";\n\nlet threats = SecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Jailbreak\", \"Prompt\", \"AI\", \"Model\")\n| summarize ThreatCount = count() by bin(TimeGenerated, 1h)\n| extend EventType = \"Security Threat\";\n\n// Combine data for the shared timeline view\naiUsage\n| project TimeGenerated, Count = AIUsage, EventType\n| union (\n    threats\n    | project TimeGenerated, Count = ThreatCount, EventType\n)\n| render timechart",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "timechart",
                            "chartSettings": {
                                "showLegend": true,
                                "seriesLabelSettings": [
                                    {
                                        "seriesName": "AI Usage",
                                        "color": "blue"
                                    },
                                    {
                                        "seriesName": "Security Threat",
                                        "color": "red"
                                    }
                                ]
                            }
                        },
                        "name": "timeline_visualization",
                        "id": "066c2b0b-3544-4083-90cf-6dcfeeefd2cf"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "###  高级关联分析\n---"
                        },
                        "name": "advanced_correlation_header",
                        "id": "18bf242a-1be9-4dc5-a1e1-fec726511a86"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// User behavior and threat correlation analysis (revised)\n// Analyze AI usage patterns for users alongside concurrent security incidents\nlet suspiciousUsers = SigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n| extend Hour = datetime_part(\"hour\", TimeGenerated)\n| extend IsAfterHours = (Hour < 8 or Hour > 18)\n| summarize \n    TotalLogins = count(),\n    AfterHoursLogins = countif(IsAfterHours),\n    UniqueApps = dcount(AppDisplayName),\n    LoginDays = dcount(bin(TimeGenerated, 1d))\n  by UserPrincipalName\n| extend \n    AfterHoursRatio = round(todouble(AfterHoursLogins) / todouble(TotalLogins) * 100, 1),\n    SuspicionScore = case(\n        AfterHoursLogins > TotalLogins * 0.5, 3,\n        AfterHoursLogins > TotalLogins * 0.3, 2,\n        1\n    )\n| where SuspicionScore >= 2;\n\n// Retrieve threat incidents covering the same days\nlet threatPeriods = SecurityIncident\n| where TimeGenerated > {TimeRange:start}\n| where Title has_any (\"Jailbreak\", \"Prompt\", \"AI\", \"Model\")\n| extend ThreatDay = bin(TimeGenerated, 1d)\n| summarize \n    DailyThreats = count(),\n    ThreatDetails = make_set(Title, 3)\n  by ThreatDay;\n\n// Correlate usage with threat activity\nsuspiciousUsers\n| join kind=leftouter (\n    SigninLogs\n    | where TimeGenerated > {TimeRange:start}\n    | where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n    | extend LoginDay = bin(TimeGenerated, 1d)\n    | summarize by UserPrincipalName, LoginDay\n) on UserPrincipalName\n| join kind=leftouter (threatPeriods) on $left.LoginDay == $right.ThreatDay\n| summarize \n    UserLogins = max(TotalLogins),\n    UserAfterHoursRatio = max(AfterHoursRatio),\n    UserSuspicionScore = max(SuspicionScore),\n    ThreatDays = countif(isnotempty(DailyThreats)),\n    TotalThreats = sum(DailyThreats)\n  by UserPrincipalName\n| extend \n    RiskLevel = case(\n        TotalThreats > 0 and UserSuspicionScore >= 3, \"\ud83d\udd25 Severe Risk\",\n        TotalThreats > 0 and UserSuspicionScore >= 2, \"\ud83d\udd34 High Risk\",\n        UserSuspicionScore >= 3, \"\ud83d\udfe0 Behavioral Anomaly\",\n        \"\ud83d\udfe2 Normal User\"\n    )\n| project \n    ['User'] = UserPrincipalName,\n    ['风险等级'] = RiskLevel,\n    ['Suspicion Score'] = UserSuspicionScore,\n    ['总登录次数'] = UserLogins,\n    ['After-hours Ratio'] = strcat(UserAfterHoursRatio, \"%\"),\n    ['Threat-Linked Days'] = ThreatDays,\n    ['Linked Threat Count'] = coalesce(TotalThreats, 0)\n| order by ['Suspicion Score'] desc, ['Linked Threat Count'] desc\n| take 20",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Suspicion Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redGreen"
                                        }
                                    },
                                    {
                                        "columnMatch": "Linked Threat Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "总登录次数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "user_threat_correlation",
                        "id": "ebe933cb-8fc5-4e5b-b03c-764061656243"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Detailed timeline of 威胁事件\nSecurityAlert\n| where TimeGenerated > {TimeRange:start}\n| where AlertName has_any (\"Jailbreak\", \"Prompt\", \"AI\", \"Model\")\n| extend \n    ThreatType = case(\n        AlertName has \"Jailbreak\", \"\ud83d\udea8 Jailbreak Attack\",\n        AlertName has \"Prompt\", \"\ud83d\udc89 Prompt Injection\",\n        AlertName has \"Model\", \"\ud83e\udd16 Model Threat\",\n        \"\u26a0\ufe0f Other Threats\"\n    ),\n    ResourceName = CompromisedEntity,\n    Hour = datetime_part(\"hour\", TimeGenerated)\n| project \n    ['Time'] = format_datetime(TimeGenerated, 'MM-dd HH:mm:ss'),\n    ['威胁类型'] = ThreatType,\n    ['严重级别'] = Alert严重级别,\n    ['Target Resource'] = ResourceName,\n    ['Time Period'] = case(\n        Hour >= 0 and Hour < 6, \"\ud83c\udf19 Late Night (0-6)\",\n        Hour >= 6 and Hour < 12, \"\ud83c\udf05 Morning (6-12)\",\n        Hour >= 12 and Hour < 18, \"\ud83c\udf24\ufe0f Afternoon (12-18)\",\n        Hour >= 18 and Hour < 24, \"\ud83c\udf06 Evening (18-24)\",\n        \"\u26aa Unknown Period\"\n    ),\n    ['告警名称'] = AlertName\n| order by ['Time'] desc\n| take 30",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "threat_timeline_details",
                        "id": "147c06e4-d3a0-471a-9222-284bb8b732d9"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI application usage heatmap: hour versus application family\nSigninLogs\n| where TimeGenerated > {TimeRange:start}\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n| extend \n    Hour = datetime_part(\"hour\", TimeGenerated),\n    AppCategory = case(\n        AppDisplayName has \"Security Copilot\", \"Security_Copilot\",\n        AppDisplayName has \"AI Studio\", \"AI_Studio\", \n        AppDisplayName has \"GitHub Copilot\", \"GitHub_Copilot\",\n        AppDisplayName has \"365 Copilot\" or AppDisplayName has \"M365 Copilot\", \"M365_Copilot\",\n        \"Other_AI_Apps\"\n    )\n| summarize UsageCount = count() by Hour = toint(Hour), AppCategory\n| summarize \n    Security_Copilot = sumif(UsageCount, AppCategory == \"Security_Copilot\"),\n    AI_Studio = sumif(UsageCount, AppCategory == \"AI_Studio\"),\n    GitHub_Copilot = sumif(UsageCount, AppCategory == \"GitHub_Copilot\"),\n    M365_Copilot = sumif(UsageCount, AppCategory == \"M365_Copilot\"),\n    Other_AI_Apps = sumif(UsageCount, AppCategory == \"Other_AI_Apps\")\n  by Hour\n| project \n    Hour,\n    [' Security Copilot'] = Security_Copilot,\n    [' AI Studio'] = AI_Studio,\n    [' GitHub Copilot'] = GitHub_Copilot,\n    [' M365 Copilot'] = M365_Copilot,\n    [' Other AI Apps'] = Other_AI_Apps\n| order by Hour asc",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Hour",
                                        "formatter": 0,
                                        "formatOptions": {
                                            "customColumnWidthSetting": "10%"
                                        }
                                    },
                                    {
                                        "columnMatch": " Security Copilot",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": " AI Studio",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "green"
                                        }
                                    },
                                    {
                                        "columnMatch": " GitHub Copilot",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "purple"
                                        }
                                    },
                                    {
                                        "columnMatch": " M365 Copilot",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": " Other AI Apps",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellow"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "usage_heatmap",
                        "id": "af930e8d-bb90-457f-b098-a701effc6e6b"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Correlation 风险评估 summary - Real-time 指标s from actual data\nlet totalThreats = toscalar(\n    SecurityAlert\n    | where TimeGenerated > {TimeRange:start}\n    | where AlertName has_any (\"Jailbreak\", \"Prompt\", \"AI\", \"Model\")\n    | summarize count()\n);\n\nlet totalUsage = toscalar(\n    SigninLogs\n    | where TimeGenerated > {TimeRange:start}\n    | where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n    | summarize count()\n);\n\nlet uniqueUsers = toscalar(\n    SigninLogs\n    | where TimeGenerated > {TimeRange:start}\n    | where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n    | summarize dcount(UserPrincipalName)\n);\n\nlet correlatedEvents = toscalar(\n    SigninLogs\n    | where TimeGenerated > {TimeRange:start}\n    | where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n    | extend UsageHour = bin(TimeGenerated, 1h)\n    | join kind=inner (\n        SecurityAlert\n        | where TimeGenerated > {TimeRange:start}\n        | where AlertName has_any (\"Jailbreak\", \"Prompt\", \"AI\", \"Model\")\n        | extend ThreatHour = bin(TimeGenerated, 1h)\n    ) on $left.UsageHour == $right.ThreatHour\n    | summarize dcount(UsageHour)\n);\n\nlet riskRatio = case(totalUsage > 0, round(todouble(totalThreats) / todouble(totalUsage) * 100, 2), 0.0);\n\nlet riskLevel = case(\n    riskRatio > 5, \"\ud83d\udd25 High Risk\",\n    riskRatio > 2, \"\ud83d\udfe0 Moderate Risk\",\n    \"\ud83d\udfe2 Low Risk\"\n);\n\n// Create table using union of print statements\nprint 指标 = \"\ud83d\udcca Total AI Usage\", Value = tostring(totalUsage), Description = \"Number of AI application sign-ins during the selected window\"\n| union (print 指标 = \"\u26a0\ufe0f Total Security Threats\", Value = tostring(totalThreats), Description = \"AI-related security alerts detected in the same window\")\n| union (print 指标 = \"\ud83d\udc65 Active Users\", Value = tostring(uniqueUsers), Description = \"Distinct users interacting with AI applications\")\n| union (print 指标 = \"\ud83d\udd17 Correlated Time Windows\", Value = tostring(correlatedEvents), Description = \"Hourly periods where usage and threats overlapped\")\n| union (print 指标 = \"\ud83d\udcc8 风险比率\", Value = strcat(tostring(riskRatio), \"%\"), Description = \"Percentage of threats compared to total AI usage\")\n| union (print 指标 = \"\ud83c\udfaf Overall 风险等级\", Value = riskLevel, Description = \"Risk posture derived from correlated statistics\")",
                            "size": 0,
                            "title": "\ud83d\udcca AI安全风险相关性摘要",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Value",
                                        "formatter": 1,
                                        "formatOptions": {
                                            "customColumnWidthSetting": "20%"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "correlation_summary",
                        "id": "1d9ff96d-0590-4dfe-b636-c30301694a0a"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "timeline"
            },
            "name": "timeline_group",
            "id": "28b29e0e-ba8d-4b6a-b01c-1bb388b6b1e2"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #e83e8c, #a02142); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udee1\ufe0f MITRE ATT&CK AI威胁映射</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图将AI相关安全威胁映射到 MITRE ATT&CK 框架，通过标准化威胁分类与技术映射，帮助安全团队理解AI攻击链、发现防御缺口并设计行业对齐的检测与响应策略。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #fef7f9; padding: 10px; border-left: 4px solid #e83e8c; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #e83e8c;\">\ud83c\udfaf 战术映射</h4>\n    <p style=\"font-size: 13px; color: #333;\">将AI威胁与MITRE ATT&CK战术和技术对齐以统一报告</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #fef7f9; padding: 10px; border-left: 4px solid #e83e8c; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #e83e8c;\">\ud83d\udd0d 差距分析</h4>\n    <p style=\"font-size: 13px; color: #333;\">识别AI防御面上的覆盖缺口与薄弱控制</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "mitre_header",
                        "id": "69db64f0-9c40-4e5c-b7c3-74a0f278e327"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// MITRE ATT&CK AI威胁映射 (balanced color version)\nlet aiKeywords = dynamic([\"AI\", \"Model\", \"Prompt\", \"Copilot\", \"LLM\", \"GPT\", \"Jailbreak\", \"Injection\"]);\n\n// 1. Try to use native Sentinel MITRE data first\nlet nativeMitreAlerts = SecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has_any (aiKeywords)\n| where isnotempty(Tactics) or isnotempty(Techniques)\n| extend \n    NativeTactics = tostring(Tactics),\n    NativeTechniques = tostring(Techniques),\n    DataSource = \"Sentinel Native\"\n| project TimeGenerated, AlertName, Alert严重级别, \n          MITRETactic = NativeTactics, MITRETechnique = NativeTechniques, DataSource;\n\n// 2. AI-enhanced mapping\nlet enhancedMitreAlerts = SecurityAlert\n| where TimeGenerated > ago(30d)\n| where AlertName has_any (aiKeywords)\n| where isempty(Tactics) and isempty(Techniques)\n| extend \n    MITRETactic = case(\n        AlertName has_any (\"Prompt Injection\", \"Social Engineering\", \"Supply Chain\"), \"TA0001-Initial Access\",\n        AlertName has_any (\"Code Injection\", \"Jailbreak\", \"Model Hijacking\"), \"TA0002-Execution\",\n        AlertName has_any (\"Backdoor\", \"Model Poisoning\", \"Training Data Manipulation\"), \"TA0003-Persistence\",\n        AlertName has_any (\"Privilege Escalation\", \"Authorization Bypass\"), \"TA0004-Privilege Escalation\",\n        AlertName has_any (\"Defense Evasion\", \"Model Evasion\", \"Adversarial Attack\"), \"TA0005-Defense Evasion\",\n        AlertName has_any (\"Credential\", \"Token\", \"API Key\"), \"TA0006-Credential Access\",\n        AlertName has_any (\"Discovery\", \"Reconnaissance\", \"Model Architecture\"), \"TA0007-Discovery\",\n        AlertName has_any (\"Lateral Movement\", \"Model Chaining\"), \"TA0008-Lateral Movement\",\n        AlertName has_any (\"Data Collection\", \"Model Extraction\", \"Training Data Theft\"), \"TA0009-Collection\",\n        AlertName has_any (\"Exfiltration\", \"Data Theft\", \"Model Theft\"), \"TA0010-Exfiltration\",\n        AlertName has_any (\"Impact\", \"Model Corruption\", \"Service Disruption\"), \"TA0011-Impact\",\n        \"Unknown\"\n    ),\n    MITRETechnique = case(\n        AlertName has_any (\"Prompt Injection\", \"Social Engineering\"), \"T1566-Phishing\",\n        AlertName has_any (\"Code Injection\", \"Jailbreak\"), \"T1059-Command and Scripting Interpreter\",\n        AlertName has_any (\"Model Poisoning\", \"Backdoor\"), \"T1546-Event Triggered Execution\",\n        AlertName has_any (\"Defense Evasion\", \"Model Evasion\"), \"T1562-Impair Defenses\",\n        AlertName has_any (\"Privilege Escalation\"), \"T1078-Valid Accounts\",\n        AlertName has_any (\"Credential\", \"Token\"), \"T1555-Credentials from Password Stores\",\n        AlertName has_any (\"Discovery\", \"Reconnaissance\"), \"T1083-File and Directory Discovery\",\n        AlertName has_any (\"Lateral Movement\"), \"T1021-Remote Services\",\n        AlertName has_any (\"Data Collection\", \"Model Extraction\"), \"T1005-Data from Local System\",\n        AlertName has_any (\"Exfiltration\", \"Data Theft\"), \"T1041-Exfiltration Over C2 Channel\",\n        AlertName has_any (\"Model Corruption\", \"Impact\"), \"T1485-Data Destruction\",\n        AlertName has_any (\"Adversarial Attack\"), \"T1XXX-Adversarial ML Attack\",\n        \"Unknown\"\n    ),\n    DataSource = \"AI Enhanced Mapping\"\n| project TimeGenerated, AlertName, Alert严重级别, MITRETactic, MITRETechnique, DataSource;\n\n// 3. Combine and classify\nlet allMitreData = nativeMitreAlerts\n| union enhancedMitreAlerts\n| extend \n    AIThreatCategory = case(\n        AlertName has_any (\"Prompt Injection\", \"Jailbreak\"), \"\ud83d\udc89 AI Prompt Attacks\",\n        AlertName has_any (\"Model Poisoning\", \"Backdoor\"), \"\u2620\ufe0f AI模型 Poisoning\",\n        AlertName has_any (\"Adversarial\", \"Evasion\"), \"\u2694\ufe0f Adversarial Attacks\",\n        AlertName has_any (\"Exfiltration\", \"Data Theft\"), \"\ud83d\udce4 AI Data Exfiltration\",\n        AlertName has_any (\"Privilege\", \"Authorization\"), \"\ud83d\udc51 AI Privilege Abuse\",\n        AlertName has_any (\"Discovery\", \"Reconnaissance\"), \"\ud83d\udd0d AI Reconnaissance\",\n        AlertName has_any (\"Lateral\", \"Chaining\"), \"\ud83d\udd17 AI Lateral Movement\",\n        AlertName has_any (\"Credential\", \"Token\"), \"\ud83d\udd11 AI Credential Theft\",\n        AlertName has_any (\"Impact\", \"Corruption\"), \"\ud83d\udca5 AI Destructive Attacks\",\n        \"\u26a0\ufe0f Other AI Threats\"\n    );\n\n// 4. Produce the final 指标s\nallMitreData\n| where MITRETactic != \"Unknown\"\n| summarize \n    AlertCount = count(),\n    High严重级别Count = countif(Alert严重级别 == \"High\"),\n    Medium严重级别Count = countif(Alert严重级别 == \"Medium\"),\n    Low严重级别Count = countif(Alert严重级别 == \"Low\"),\n    LastAlert = max(TimeGenerated),\n    DataSources = make_set(DataSource),\n    SampleAlerts = make_set(AlertName, 3)\n  by MITRETactic, MITRETechnique, AIThreatCategory\n| extend \n    // Calculate 风险评分\n    CalculatedRiskScore = High严重级别Count * 5 + Medium严重级别Count * 2 + Low严重级别Count * 1\n| extend\n    // 风险等级: higher score = hotter color\n    RiskLevel = case(\n        CalculatedRiskScore >= 50, \"\ud83d\udd25 Extreme Risk\",\n        CalculatedRiskScore >= 20, \"\ud83d\udd34 High Risk\",\n        CalculatedRiskScore >= 10, \"\ud83d\udfe0 Moderate Risk\",\n        CalculatedRiskScore >= 1, \"\ud83d\udfe1 Low Risk\",\n        \"\u26aa No Risk\"\n    ),\n    ThreatDensity = round(todouble(AlertCount) / 30.0, 2)\n| project \n    ['MITRE Tactic'] = MITRETactic,\n    ['MITRE Technique'] = MITRETechnique,\n    ['AI Threat Category'] = AIThreatCategory,\n    ['风险等级'] = RiskLevel,\n    ['风险评分'] = CalculatedRiskScore,\n    ['告警总数'] = AlertCount,\n    ['High-严重级别 Alerts'] = High严重级别Count,\n    ['Medium-严重级别 Alerts'] = Medium严重级别Count,\n    ['Low-严重级别 Alerts'] = Low严重级别Count,\n    ['Threat Density/Day'] = ThreatDensity,\n    ['Data Source'] = tostring(DataSources),\n    ['Sample Alerts'] = tostring(SampleAlerts),\n    ['Latest Alert'] = format_datetime(LastAlert, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['High-严重级别 Alerts'] desc, ['告警总数'] desc\n| take 25",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "High-严重级别 Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "告警总数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ],
                                "rowLimit": 50,
                                "filter": true
                            }
                        },
                        "name": "mitre_mapping",
                        "id": "07dbdda5-11af-4589-aae5-dbe1ce572824"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Advanced Prompt Injection & Jailbreak Detection\n// Maps AI-specific attacks to MITRE ATT&CK and OWASP Top 10 for LLM\n// Uses Azure AI Content Safety, Prompt Shield, and Defender for AI detections\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    // Azure Prompt Shield & Content Safety detections\n    AuditLogs\n    | where TimeGenerated > t0\n    | where OperationName has_any (\"PromptShield\", \"ContentSafety\")\n    | extend\n        DetectionSource = \"Azure Prompt Shield\",\n        AttackVector = case(\n            TargetResources[0].modifiedProperties[0].newValue has \"DirectAttack\", \"Direct Prompt Injection\",\n            TargetResources[0].modifiedProperties[0].newValue has \"IndirectAttack\", \"Indirect Prompt Injection\",\n            OperationName has \"PromptShield\", \"Prompt Shield Detection\",\n            \"Content Safety Violation\"\n        ),\n        MITRETechnique = \"LLM01 - Prompt Injection\",\n        MITRETactic = \"TA0001 - Initial Access\",\n        严重级别 = case(\n            TargetResources[0].modifiedProperties[0].newValue has \"High\", \"Critical\",\n            TargetResources[0].modifiedProperties[0].newValue has \"Medium\", \"High\",\n            \"Medium\"\n        ),\n        UserPrincipal = tostring(InitiatedBy.user.userPrincipalName),\n        UserIP = tostring(InitiatedBy.user.ipAddress),\n        Details = tostring(TargetResources[0].modifiedProperties[0].newValue)\n    | project TimeGenerated, DetectionSource, AttackVector, MITRETechnique, MITRETactic, 严重级别, UserPrincipal, UserIP, Details\n    ),\n    (\n    // Defender for AI安全 alerts - Jailbreak and Prompt Injection\n    SecurityAlert\n    | where TimeGenerated > t0\n    | where AlertName has_any (\"Prompt Injection\", \"Jailbreak\", \"AI\", \"Model\")\n    | extend\n        DetectionSource = \"Defender for AI\",\n        AttackVector = case(\n            AlertName has \"Prompt Injection\", \"Prompt Injection Attack\",\n            AlertName has \"Jailbreak\", \"Jailbreak Attack (DAN)\",\n            AlertName has \"Model Abuse\", \"Model Abuse Attack\",\n            AlertName has \"Data Poisoning\", \"Data Poisoning Attack\",\n            \"AI安全 Alert\"\n        ),\n        MITRETechnique = case(\n            AlertName has \"Prompt Injection\", \"LLM01 - Prompt Injection\",\n            AlertName has \"Jailbreak\", \"LLM01 - Prompt Injection (Jailbreak)\",\n            AlertName has \"Model\", \"LLM02 - Insecure Output Handling\",\n            AlertName has \"Data\", \"LLM03 - Training Data Poisoning\",\n            \"LLM01 - Prompt Injection\"\n        ),\n        MITRETactic = case(\n            AlertName has_any (\"Jailbreak\", \"Bypass\"), \"TA0005 - Defense Evasion\",\n            AlertName has \"Data\", \"TA0003 - Persistence\",\n            \"TA0001 - Initial Access\"\n        ),\n        严重级别 = case(\n            Alert严重级别 == \"High\", \"Critical\",\n            Alert严重级别 == \"Medium\", \"High\",\n            \"Medium\"\n        ),\n        UserPrincipal = tostring(parse_json(ExtendedProperties).UserPrincipalName),\n        UserIP = tostring(parse_json(ExtendedProperties).ClientIP),\n        Details = AlertName\n    | project TimeGenerated, DetectionSource, AttackVector, MITRETechnique, MITRETactic, 严重级别, UserPrincipal, UserIP, Details\n    )\n| summarize\n    AttackCount = count(),\n    CriticalCount = countif(严重级别 == \"Critical\"),\n    HighCount = countif(严重级别 == \"High\"),\n    MediumCount = countif(严重级别 == \"Medium\"),\n    UniqueAttackers = dcount(UserPrincipal),\n    UniqueIPs = dcount(UserIP),\n    AttackerList = make_set(UserPrincipal, 5),\n    IPList = make_set(UserIP, 5),\n    SampleDetails = make_set(Details, 2),\n    FirstDetected = min(TimeGenerated),\n    LastDetected = max(TimeGenerated)\n  by DetectionSource, AttackVector, MITRETechnique, MITRETactic\n| extend\n    RiskScore = (CriticalCount * 5) + (HighCount * 3) + (MediumCount * 2),\n    AttackFrequency = round(todouble(AttackCount) / todouble(datetime_diff('hour', LastDetected, FirstDetected) + 1), 1)\n| extend ThreatLevel = case(\n    RiskScore >= 50, \" Critical Threat\",\n    RiskScore >= 20, \" High Threat\",\n    RiskScore >= 10, \" Medium Threat\",\n    RiskScore >= 1, \" Low Threat\",\n    \"? Minimal\"\n)\n| project\n    ['Threat Level'] = ThreatLevel,\n    ['攻击向量'] = AttackVector,\n    ['MITRE Technique'] = MITRETechnique,\n    ['MITRE Tactic'] = MITRETactic,\n    ['Detection Source'] = DetectionSource,\n    ['风险评分'] = RiskScore,\n    ['Total Attacks'] = AttackCount,\n    ['Critical'] = CriticalCount,\n    ['High'] = HighCount,\n    ['Medium'] = MediumCount,\n    ['Attacks/Hour'] = AttackFrequency,\n    ['Unique Attackers'] = UniqueAttackers,\n    ['唯一IP数'] = UniqueIPs,\n    ['Attacker Samples'] = tostring(AttackerList),\n    ['IP Samples'] = tostring(IPList),\n    ['Attack Examples'] = tostring(SampleDetails),\n    ['First Detected'] = format_datetime(FirstDetected, 'MM-dd HH:mm'),\n    ['最后检测'] = format_datetime(LastDetected, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['Total Attacks'] desc",
                            "size": 0,
                            "title": "\u2694\ufe0f 提示注入与越狱检测（MITRE映射）",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Threat Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Attacks",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "Attacks/Hour",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "filter": true,
                                "rowLimit": 50
                            }
                        },
                        "name": "prompt_injection_mitre"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI Attack Timeline - Hourly Trend\n// Tracks attack patterns over time with MITRE ATT&CK 映射\n// Uses Azure AI Content Safety and Defender for AI detections\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    // Azure AI Content Safety & Prompt Shield detections\n    AuditLogs\n    | where TimeGenerated > t0\n    | where OperationName has_any (\"PromptShield\", \"ContentSafety\")\n    | extend\n        AttackType = case(\n            TargetResources[0].modifiedProperties[0].newValue has \"DirectAttack\", \"Direct Prompt Injection (LLM01)\",\n            TargetResources[0].modifiedProperties[0].newValue has \"IndirectAttack\", \"Indirect Prompt Injection (LLM01)\",\n            OperationName has \"PromptShield\", \"Prompt Shield Detection (LLM01)\",\n            \"Content Safety Violation\"\n        ),\n        HourBucket = bin(TimeGenerated, 1h),\n        SourceIP = tostring(InitiatedBy.user.ipAddress)\n    | project HourBucket, AttackType, SourceIP\n    ),\n    (\n    // Defender for AI detections\n    SecurityAlert\n    | where TimeGenerated > t0\n    | where AlertName has_any (\"AI\", \"Prompt\", \"Jailbreak\", \"Injection\", \"Model\")\n    | extend\n        AttackType = case(\n            AlertName has \"Prompt Injection\", \"Prompt Injection Attack (LLM01)\",\n            AlertName has \"Jailbreak\", \"Jailbreak Attack (LLM01)\",\n            AlertName has \"Model\", \"Model Abuse (LLM02)\",\n            AlertName has \"Data\", \"Data Poisoning (LLM03)\",\n            \"AI安全 Alert\"\n        ),\n        HourBucket = bin(TimeGenerated, 1h),\n        SourceIP = tostring(parse_json(ExtendedProperties).ClientIP)\n    | project HourBucket, AttackType, SourceIP\n    )\n| summarize\n    AttackCount = count(),\n    UniqueAttackers = dcount(SourceIP)\n  by HourBucket, AttackType\n| project\n    Time = HourBucket,\n    ['攻击类型'] = AttackType,\n    ['攻击次数'] = AttackCount,\n    ['唯一IP数'] = UniqueAttackers\n| order by Time desc",
                            "size": 0,
                            "title": "\ud83d\udcc5 AI攻击向量时间线（MITRE技术）",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "timechart",
                            "chartSettings": {
                                "xAxis": "Time",
                                "yAxis": [
                                    "攻击次数"
                                ],
                                "group": "攻击类型",
                                "createOtherGroup": 0,
                                "showLegend": true
                            }
                        },
                        "name": "ai_attack_timeline"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "mitre"
            },
            "name": "mitre_group",
            "id": "953bb272-bff6-4261-9c4b-c2003f6b4815"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #17a2b8, #0c5460); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udea8 AI威胁响应与缓解</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图跟踪AI相关安全事件的响应效率并汇总标准化剧本，用于评估团队准备度、缩短遏制周期并确保一致的缓解措施。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0f9fa; padding: 10px; border-left: 4px solid #17a2b8; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #17a2b8;\">\u26a1 事件响应</h4>\n    <p style=\"font-size: 13px;\">梳理可复用的AI事件流程与推荐遏制步骤</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0f9fa; padding: 10px; border-left: 4px solid #17a2b8; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #17a2b8;\">\ud83d\udcca 效率分析</h4>\n    <p style=\"font-size: 13px;\">监控平均修复时间、结案率与响应人员负载趋势</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "response_header",
                        "id": "f52a184a-1e05-46e4-82bb-cd33e9335247"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI事件响应效率 KPIs\nSecurityIncident\n| where TimeGenerated > ago(30d)\n| where Title has_any (\"AI\", \"Model\", \"Prompt\", \"Copilot\", \"Jailbreak\")\n| extend \n    IsResolved = (Status == \"Closed\" or Status == \"Resolved\"),\n    ResponseTimeMinutes = datetime_diff('minute', ClosedTime, CreatedTime)\n| summarize \n    TotalIncidents = count(),\n    ResolvedIncidents = countif(IsResolved),\n    AvgResponseTime = round(avg(ResponseTimeMinutes), 0),\n    MedianResponseTime = round(percentile(ResponseTimeMinutes, 50), 0),\n    MaxResponseTime = round(max(ResponseTimeMinutes), 0)\n| extend \n    ResolutionRate = round(todouble(ResolvedIncidents) / todouble(TotalIncidents) * 100, 1)\n| project \n    data = pack_array(\n        pack(\"指标\", \"\ud83d\udd22 Total Incidents\", \"Value\", tostring(TotalIncidents), \"Description\", \"Total AI-related security incidents in the last 30 days\"),\n        pack(\"指标\", \"\u2705 Resolved Incidents\", \"Value\", tostring(ResolvedIncidents), \"Description\", \"Number of AI安全 incidents successfully closed\"),\n        pack(\"指标\", \"\ud83d\udcca Resolution Rate\", \"Value\", strcat(tostring(ResolutionRate), \"%\"), \"Description\", \"Percentage of incidents resolved\"),\n        pack(\"指标\", \"\u23f1\ufe0f Mean Response Time\", \"Value\", strcat(tostring(AvgResponseTime), \" minutes\"), \"Description\", \"Average duration from discovery to resolution\"),\n        pack(\"指标\", \"\u23f1\ufe0f Median Response Time\", \"Value\", strcat(tostring(MedianResponseTime), \" minutes\"), \"Description\", \"Median response time across incidents\"),\n        pack(\"指标\", \"\u23f1\ufe0f Longest Response Time\", \"Value\", strcat(tostring(MaxResponseTime), \" minutes\"), \"Description\", \"Maximum time required to close a single incident\")\n    )\n| mv-expand data\n| evaluate bag_unpack(data)",
                            "size": 1,
                            "title": "\ud83d\udcca AI事件响应效率",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "tiles",
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "指标",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "Value",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "auto"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal",
                                            "maximumFractionDigits": 1
                                        }
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "Description",
                                    "formatter": 1
                                },
                                "showBorder": true,
                                "sortCriteriaField": "指标 Name",
                                "sortOrderField": 1,
                                "size": "auto"
                            }
                        },
                        "name": "incident_response_指标s",
                        "styleSettings": {
                            "margin": "10px",
                            "padding": "10px",
                            "showBorder": true
                        },
                        "id": "eaea3f97-4b28-4071-8e11-0aba5e16a63d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI安全 response recommendations (color-aligned version)\ndatatable(\n    ThreatType:string,\n    严重级别:string,\n    ResponseAction:string,\n    优先级:string,\n    EstimatedTime:string,\n    ResponsibleTeam:string\n)[\n    \"AI Jailbreak Attempt\", \"High\", \"Immediately revise AI safety policies, tighten input validation, and harden output filtering\", \"Critical\", \"2 hours\", \"AI安全 Team\",\n    \"Prompt Injection\", \"High\", \"Deploy prompt filtering, refresh detection rules, and expand content moderation coverage\", \"Critical\", \"4 hours\", \"Security Operations Center\",\n    \"Model Poisoning\", \"High\", \"Isolate the affected model, roll back to a trusted version, and retrain with clean data\", \"Critical\", \"8 hours\", \"AI Development Team\",\n    \"Data Exfiltration\", \"High\", \"Immediately isolate impacted systems, scope exposed data, and notify stakeholders\", \"Critical\", \"1 hour\", \"事件响应 Team\",\n    \"Model Theft\", \"Medium\", \"Strengthen access controls, apply model encryption, and enable watermarking\", \"High\", \"12 hours\", \"AI安全 Team\",\n    \"Privilege Abuse\", \"Medium\", \"Reset affected account privileges, audit access logs, and enforce strong authentication\", \"Medium\", \"6 hours\", \"Identity Management Team\",\n    \"Adversarial Attack\", \"Medium\", \"Deploy adversarial detection models and improve model robustness\", \"Medium\", \"24 hours\", \"AI Research Team\",\n    \"Anomalous Access\", \"Low\", \"Enhance monitoring, update geo-velocity controls, and analyze access patterns\", \"Low\", \"12 hours\", \"Network Security Team\",\n    \"API Abuse\", \"Low\", \"Enforce API rate limiting and monitor for anomalous invocation patterns\", \"Low\", \"8 hours\", \"API Management Team\",\n    \"Misconfiguration\", \"Low\", \"Correct security settings and run baseline configuration checks\", \"Low\", \"4 hours\", \"Systems Administration Team\"\n]\n| extend \n    严重级别Icon = case(\n        严重级别 == \"High\", \"\ud83d\udd34\",\n        严重级别 == \"Medium\", \"\ud83d\udfe0\",\n        严重级别 == \"Low\", \"\ud83d\udfe1\",\n        \"\u26aa\"\n    ),\n    优先级Icon = case(\n        优先级 == \"Critical\", \"\ud83d\udd25\",\n        优先级 == \"High\", \"\ud83d\udd34\",\n        优先级 == \"Medium\", \"\ud83d\udfe0\",\n        优先级 == \"Low\", \"\ud83d\udfe2\",\n        \"\u26aa\"\n    ),\n    优先级Order = case(\n        优先级 == \"Critical\", 1,\n        优先级 == \"High\", 2,\n        优先级 == \"Medium\", 3,\n        优先级 == \"Low\", 4,\n        5\n    ),\n    ThreatIcon = case(\n        ThreatType == \"AI Jailbreak Attempt\", \"\ud83d\udea8\",\n        ThreatType == \"Prompt Injection\", \"\ud83d\udc89\",\n        ThreatType == \"Model Poisoning\", \"\u2620\ufe0f\",\n        ThreatType == \"Data Exfiltration\", \"\ud83d\udce4\",\n        ThreatType == \"Model Theft\", \"\ud83d\udd13\",\n        ThreatType == \"Privilege Abuse\", \"\ud83d\udc51\",\n        ThreatType == \"Adversarial Attack\", \"\u2694\ufe0f\",\n        ThreatType == \"Anomalous Access\", \"\ud83d\udd0d\",\n        ThreatType == \"API Abuse\", \"\ud83d\udd0c\",\n        ThreatType == \"Misconfiguration\", \"\u2699\ufe0f\",\n        \"\u26a0\ufe0f\"\n    )\n| project \n    ['威胁类型'] = strcat(ThreatIcon, \" \", ThreatType),\n    ['严重级别'] = strcat(严重级别Icon, \" \", 严重级别),\n    ['优先级'] = strcat(优先级Icon, \" \", 优先级),\n    ['响应措施'] = ResponseAction,\n    ['预计时间'] = EstimatedTime,\n    ['负责团队'] = ResponsibleTeam,\n    优先级Order\n| order by 优先级Order asc\n| project-away 优先级Order",
                            "size": 0,
                            "title": "\ud83d\udccb 标准响应剧本",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "优先级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    }
                                ],
                                "rowLimit": 15,
                                "sortBy": [
                                    {
                                        "itemKey": "负责团队",
                                        "sortOrder": 1
                                    }
                                ],
                                "labelSettings": [
                                    {
                                        "columnId": "威胁类型",
                                        "label": "威胁类型"
                                    },
                                    {
                                        "columnId": "严重级别",
                                        "label": "严重级别"
                                    },
                                    {
                                        "columnId": "优先级",
                                        "label": "优先级"
                                    },
                                    {
                                        "columnId": "响应措施",
                                        "label": "响应措施"
                                    },
                                    {
                                        "columnId": "预计时间",
                                        "label": "预计时间"
                                    },
                                    {
                                        "columnId": "负责团队",
                                        "label": "负责团队"
                                    }
                                ]
                            },
                            "sortBy": [
                                {
                                    "itemKey": "负责团队",
                                    "sortOrder": 1
                                }
                            ]
                        },
                        "name": "response_recommendations",
                        "styleSettings": {
                            "margin": "10px",
                            "padding": "10px",
                            "showBorder": true
                        },
                        "id": "6b39d6a5-c770-40f8-b1f5-67a478fc1b94"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI事件响应成功趋势 (repaired version)\nSecurityIncident\n| where CreatedTime > ago(90d)\n| where Title has_any (\"AI\", \"Model\", \"Prompt\", \"Copilot\", \"Jailbreak\")\n| extend \n    IsResolved = (Status == \"Closed\" or Status == \"Resolved\"),\n    WeekStart = startofweek(CreatedTime)\n| summarize \n    TotalIncidents = count(),\n    ResolvedIncidents = countif(IsResolved),\n    AvgResolutionTimeHours = round(avg(datetime_diff('hour', ClosedTime, CreatedTime)), 1)\n  by WeekStart\n| extend \n    SuccessRate = round(todouble(ResolvedIncidents) / todouble(TotalIncidents) * 100, 1)\n| order by WeekStart asc\n| project \n    WeekStart,\n    ['解决率 %'] = SuccessRate,\n    ['Total Incidents'] = TotalIncidents,\n    ['Resolved Incidents'] = ResolvedIncidents,\n    ['Average Resolution Time (Hours)'] = AvgResolutionTimeHours\n| render timechart",
                            "size": 0,
                            "title": "\ud83d\udcc8 AI事件响应成功趋势",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "timechart",
                            "graphSettings": {
                                "type": 0
                            },
                            "chartSettings": {
                                "showLegend": true,
                                "seriesLabelSettings": [
                                    {
                                        "seriesName": "解决率 %",
                                        "color": "green"
                                    },
                                    {
                                        "seriesName": "Total Incidents",
                                        "color": "blue"
                                    },
                                    {
                                        "seriesName": "Average Resolution Time (Hours)",
                                        "color": "orange"
                                    }
                                ],
                                "ySettings": {
                                    "numberFormatSettings": {
                                        "unit": 1,
                                        "options": {
                                            "style": "decimal",
                                            "useGrouping": true
                                        }
                                    }
                                }
                            }
                        },
                        "name": "response_trend_chart",
                        "styleSettings": {
                            "margin": "10px",
                            "padding": "10px",
                            "showBorder": true
                        },
                        "id": "34b92457-51a0-4fe3-92bd-5b352900352d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Defender for AI Automated Response & Security Incident Tracking\n// Tracks AI安全 incidents and 响应措施 from Defender for AI and Sentinel\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    // Security Alerts from Defender for AI\n    SecurityAlert\n    | where TimeGenerated > t0\n    | where AlertName has_any (\"AI\", \"Prompt\", \"Jailbreak\", \"Model\", \"Injection\", \"Data Poisoning\")\n    | extend\n        ResponseAction = case(\n            Status == \"Resolved\", \"\u2705 Alert Resolved\",\n            Status == \"InProgress\", \"\ud83d\udd04 Investigation In Progress\",\n            Status == \"New\", \"\ud83c\udd95 New Alert\",\n            \"\u26aa Other Status\"\n        ),\n        ThreatType = case(\n            AlertName has \"Prompt Injection\", \"Prompt Injection Attack\",\n            AlertName has \"Jailbreak\", \"Jailbreak Attack\",\n            AlertName has \"Model\", \"Model Abuse\",\n            AlertName has \"Data Poisoning\", \"Data Poisoning\",\n            \"AI安全 Threat\"\n        ),\n        严重级别 = case(\n            Alert严重级别 == \"High\", \"Critical\",\n            Alert严重级别 == \"Medium\", \"High\",\n            Alert严重级别 == \"Low\", \"Medium\",\n            \"Low\"\n        ),\n        AffectedEntity = tostring(parse_json(tostring(Entities))[0])\n    | extend ExtendedProps = todynamic(ExtendedProperties)\n    | extend\n        UserAccount = tostring(ExtendedProps.UserPrincipalName),\n        SourceIP = tostring(ExtendedProps.ClientIP)\n    | project TimeGenerated, ResponseAction, ThreatType, 严重级别, AlertName, AffectedEntity, UserAccount, SourceIP, Status\n    ),\n    (\n    // Security Incidents from Sentinel\n    SecurityIncident\n    | where TimeGenerated > t0\n    | where Title has_any (\"AI\", \"Prompt\", \"Jailbreak\", \"Model\", \"Copilot\")\n    | extend\n        ResponseAction = case(\n            Status == \"Closed\", \"\u2705 Incident Closed\",\n            Status == \"Active\", \"\ud83d\udd04 Active Investigation\",\n            Status == \"New\", \"\ud83c\udd95 New Incident\",\n            \"\u26aa Other Status\"\n        ),\n        ThreatType = case(\n            Title has \"Prompt\", \"Prompt-based Attack\",\n            Title has \"Jailbreak\", \"Jailbreak Attempt\",\n            Title has \"Model\", \"AI模型 Threat\",\n            Title has \"Data\", \"Data Security Threat\",\n            \"AI安全 Incident\"\n        ),\n        严重级别 = case(\n            严重级别 == \"High\", \"Critical\",\n            严重级别 == \"Medium\", \"High\",\n            \"Medium\"\n        ),\n        AffectedEntity = tostring(RelatedEntities),\n        UserAccount = Owner.assignedTo,\n        SourceIP = \"\"\n    | project TimeGenerated, ResponseAction, ThreatType, 严重级别, AlertName = Title, AffectedEntity, UserAccount, SourceIP, Status\n    )\n| summarize\n    ActionCount = count(),\n    CriticalActions = countif(严重级别 == \"Critical\"),\n    HighActions = countif(严重级别 == \"High\"),\n    ResolvedCount = countif(ResponseAction has_any (\"Resolved\", \"Closed\")),\n    InProgressCount = countif(ResponseAction has_any (\"Progress\", \"Active\")),\n    NewCount = countif(ResponseAction has_any (\"New\")),\n    UniqueUsers = dcount(UserAccount),\n    UniqueIPs = dcount(SourceIP),\n    SampleAlerts = make_set(AlertName, 3),\n    FirstAction = min(TimeGenerated),\n    LastAction = max(TimeGenerated)\n  by ResponseAction, ThreatType, 严重级别\n| extend\n    EffectivenessScore = case(\n        ResolvedCount >= 10, 5,\n        ResolvedCount >= 5, 4,\n        InProgressCount >= 5, 3,\n        ActionCount >= 10, 2,\n        1\n    ),\n    ResolutionRate = case(\n        ActionCount > 0, round(todouble(ResolvedCount) / todouble(ActionCount) * 100, 1),\n        0.0\n    )\n| extend\n    ResponseStatus = case(\n        EffectivenessScore >= 4, \"\ud83d\udfe2 Highly Effective\",\n        EffectivenessScore >= 3, \"\ud83d\udfe1 Effective\",\n        EffectivenessScore >= 2, \"\ud83d\udfe0 Moderate\",\n        \"\ud83d\udd34 Limited\"\n    )\n| project\n    ['响应动作'] = ResponseAction,\n    ['威胁类型'] = ThreatType,\n    ['响应状态'] = ResponseStatus,\n    ['严重级别'] = 严重级别,\n    ['有效性评分'] = EffectivenessScore,\n    ['解决率 %'] = ResolutionRate,\n    ['动作总数'] = ActionCount,\n    ['严重动作'] = CriticalActions,\n    ['高影响动作'] = HighActions,\n    ['Resolved'] = ResolvedCount,\n    ['In Progress'] = InProgressCount,\n    ['New'] = NewCount,\n    ['受影响用户'] = UniqueUsers,\n    ['唯一IP数'] = UniqueIPs,\n    ['告警样本'] = tostring(SampleAlerts),\n    ['首次动作'] = format_datetime(FirstAction, 'MM-dd HH:mm'),\n    ['最后动作'] = format_datetime(LastAction, 'MM-dd HH:mm')\n| order by ['有效性评分'] desc, ['动作总数'] desc",
                            "size": 0,
                            "title": "\ud83d\udee1\ufe0f Defender for AI安全响应与事件跟踪",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "响应状态",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Highly",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Effective",
                                                    "representation": "lightBlue"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Moderate",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Limited",
                                                    "representation": "orange"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "有效性评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "green"
                                        }
                                    },
                                    {
                                        "columnMatch": "严重动作",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "xdr_automated_response"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  来自不合规与高风险设备的AI访问\n// Monitors AI application access from non-compliant or high-risk devices that should be isolated\n// Uses Entra ID SigninLogs for real device compliance data\nlet t0 = {TimeRange:start};\nSigninLogs\n| where TimeGenerated > t0\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\", \"Claude\", \"Bard\")\n| extend\n    IsCompliant = tostring(DeviceDetail.isCompliant),\n    IsManaged = tostring(DeviceDetail.isManaged),\n    TrustType = tostring(DeviceDetail.trustType),\n    DeviceId = tostring(DeviceDetail.deviceId),\n    DisplayName = tostring(DeviceDetail.displayName),\n    OS = tostring(DeviceDetail.operatingSystem)\n| where IsCompliant == \"false\" or IsManaged == \"false\" or RiskLevelDuringSignIn != \"none\"\n| extend\n    RemediationAction = case(\n        RiskLevelDuringSignIn == \"high\" and IsCompliant == \"false\", \"\ud83d\udd25 Requires Isolation (High Risk + Non-Compliant)\",\n        RiskLevelDuringSignIn == \"high\", \"\ud83d\udd34 High Risk - Monitor Closely\",\n        IsCompliant == \"false\" and IsManaged == \"false\", \"\ud83d\udeab Block Unmanaged Non-Compliant Device\",\n        IsCompliant == \"false\", \"\u26a0\ufe0f Enforce Compliance Policy\",\n        IsManaged == \"false\", \"\ud83d\udcf1 Require Device Enrollment\",\n        RiskLevelDuringSignIn == \"medium\", \"\ud83d\udfe1 Moderate Risk - Review\",\n        \"\u2139\ufe0f Review Device Status\"\n    ),\n    Platform = case(\n        OS has \"Windows\", \"Windows\",\n        OS has \"iOS\", \"iOS\",\n        OS has \"Android\", \"Android\",\n        OS has \"Mac\", \"macOS\",\n        OS has \"Linux\", \"Linux\",\n        \"Other\"\n    ),\n    Action严重级别 = case(\n        RiskLevelDuringSignIn == \"high\" and IsCompliant == \"false\", \"Critical\",\n        RiskLevelDuringSignIn == \"high\" or (IsCompliant == \"false\" and IsManaged == \"false\"), \"High\",\n        IsCompliant == \"false\" or RiskLevelDuringSignIn == \"medium\", \"Medium\",\n        \"Low\"\n    ),\n    RiskLevel = case(\n        RiskLevelDuringSignIn == \"high\", \"High Risk\",\n        RiskLevelDuringSignIn == \"medium\", \"Medium Risk\",\n        RiskLevelDuringSignIn == \"low\", \"Low Risk\",\n        \"No Risk Data\"\n    )\n| summarize\n    ActionCount = count(),\n    CriticalDevices = dcountif(DeviceId, Action严重级别 == \"Critical\"),\n    HighRiskDevices = dcountif(DeviceId, Action严重级别 == \"High\"),\n    NonCompliantDevices = dcountif(DeviceId, IsCompliant == \"false\"),\n    UnmanagedDevices = dcountif(DeviceId, IsManaged == \"false\"),\n    UniqueDevices = dcount(DeviceId),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    DeviceList = make_set(DisplayName, 5),\n    UserList = make_set(UserPrincipalName, 5),\n    AppList = make_set(AppDisplayName, 3),\n    FirstAccess = min(TimeGenerated),\n    LastAccess = max(TimeGenerated)\n  by RemediationAction, Action严重级别, Platform, RiskLevel\n| extend\n    ImpactScore = (CriticalDevices * 5) + (HighRiskDevices * 3) + (NonCompliantDevices * 2) + (UnmanagedDevices * 1),\n    AccessFrequency = round(todouble(ActionCount) / todouble(datetime_diff('day', LastAccess, FirstAccess) + 1), 1)\n| extend ResponseEffectiveness = case(\n    ImpactScore >= 50, \" Urgent Action Required\",\n    ImpactScore >= 20, \" High 优先级\",\n    ImpactScore >= 10, \" Medium 优先级\",\n    ImpactScore >= 1, \" Low 优先级\",\n    \" Informational\"\n)\n| project\n    ['Remediation Action'] = RemediationAction,\n    ['Platform'] = Platform,\n    ['优先级 Level'] = ResponseEffectiveness,\n    ['严重级别'] = Action严重级别,\n    ['风险等级'] = RiskLevel,\n    ['Impact Score'] = ImpactScore,\n    ['Total AI Access'] = ActionCount,\n    ['Access/Day'] = AccessFrequency,\n    ['Critical Devices'] = CriticalDevices,\n    ['High Risk Devices'] = HighRiskDevices,\n    ['Non-Compliant'] = NonCompliantDevices,\n    ['Unmanaged'] = UnmanagedDevices,\n    ['Unique Devices'] = UniqueDevices,\n    ['受影响用户'] = UniqueUsers,\n    ['AI Apps Accessed'] = UniqueApps,\n    ['Device Samples'] = tostring(DeviceList),\n    ['User Samples'] = tostring(UserList),\n    ['App Samples'] = tostring(AppList),\n    ['First Access'] = format_datetime(FirstAccess, 'MM-dd HH:mm'),\n    ['Last Access'] = format_datetime(LastAccess, 'MM-dd HH:mm')\n| order by ['Impact Score'] desc, ['Total AI Access'] desc",
                            "size": 0,
                            "title": "\u26a0\ufe0f 来自不合规与高风险设备的AI访问",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "优先级 Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Urgent",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High 优先级",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium 优先级",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Low 优先级",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Impact Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Critical Devices",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "High Risk Devices",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "Non-Compliant",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "intune_device_isolation"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "response"
            },
            "name": "response_group",
            "id": "21914c76-2976-4df4-b5a9-fe95cc884623"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #343a40, #212529); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udce6 AI模型清单与漏洞管理</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图结合 Microsoft Defender for Cloud 遥测与 Azure 资源发现，呈现AI服务的动态清单。跟踪基线覆盖、监控未解决漏洞，并提供可执行情报以确保AI部署符合企业安全标准。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f8f9fa; padding: 10px; border-left: 4px solid #343a40; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #343a40;\">\ud83d\udccb 资产清单</h4>\n    <p style=\"font-size: 13px;\">持续跟踪部署在Azure中的AI服务及关键安全指标</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f8f9fa; padding: 10px; border-left: 4px solid #343a40; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #343a40;\">\ud83d\udd27 漏洞治理</h4>\n    <p style=\"font-size: 13px;\">依据 Defender for Cloud 实时发现并映射到AI工作负载进行修复优先级排序</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "model_inventory_header",
                        "id": "ff23198a-c084-4a21-b556-3c5b874026b3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI模型 资产清单 - Based on Available Data Sources (Fixed)\n// Approach 1: Get AI service information from Azure Activity Logs\nlet aiServiceEvents = AzureActivity\n| where TimeGenerated > ago(90d)\n| where ResourceProvider in (\n    \"Microsoft.CognitiveServices\",\n    \"Microsoft.MachineLearningServices\", \n    \"Microsoft.OpenAI\",\n    \"Microsoft.BotService\"\n)\n| where OperationNameValue in (\n    \"Microsoft.CognitiveServices/accounts/write\",\n    \"Microsoft.MachineLearningServices/workspaces/write\",\n    \"Microsoft.OpenAI/accounts/write\",\n    \"Microsoft.BotService/botServices/write\"\n)\n| extend \n    AIServiceType = case(\n        ResourceProvider == \"Microsoft.CognitiveServices\", \"\ud83e\udde0 Cognitive Services\",\n        ResourceProvider == \"Microsoft.MachineLearningServices\", \"\ud83d\udcca Machine Learning Services\",\n        ResourceProvider == \"Microsoft.OpenAI\", \"\ud83e\udd16 Azure OpenAI\",\n        ResourceProvider == \"Microsoft.BotService\", \"\ud83e\udd1d Bot Services\",\n        \"\u2699\ufe0f Other AI Services\"\n    ),\n    ServiceName = coalesce(Resource, ResourceId)\n| summarize \n    LastActivity = max(TimeGenerated),\n    ActivityCount = count(),\n    UniqueOperations = dcount(OperationNameValue)\n  by ServiceName, AIServiceType, ResourceGroup, ResourceProvider;\n\n// Approach 2: Identify AI-related resources from security alerts\nlet aiSecurityAlerts = SecurityAlert\n| where TimeGenerated > ago(30d)\n| where CompromisedEntity has_any (\"cognitive\", \"openai\", \"ml\", \"bot\", \"ai\")\n| extend \n    AIResourceName = CompromisedEntity,\n    AIServiceType = case(\n        CompromisedEntity has \"cognitive\", \"\ud83e\udde0 Cognitive Services\",\n        CompromisedEntity has \"openai\", \"\ud83e\udd16 Azure OpenAI\", \n        CompromisedEntity has \"ml\", \"\ud83d\udcca Machine Learning Services\",\n        CompromisedEntity has \"bot\", \"\ud83e\udd1d Bot Services\",\n        \"\u2699\ufe0f Other AI Services\"\n    )\n| summarize \n    TotalAlerts = count(),\n    High严重级别Alerts = countif(Alert严重级别 == \"High\"),\n    LastAlert = max(TimeGenerated)\n  by AIResourceName, AIServiceType;\n\n// Merge data sources\naiServiceEvents\n| join kind=fullouter (aiSecurityAlerts) on $left.ServiceName == $right.AIResourceName\n| extend \n    FinalServiceName = coalesce(ServiceName, AIResourceName),\n    FinalServiceType = coalesce(AIServiceType, AIServiceType1),\n    TotalAlerts = coalesce(TotalAlerts, 0),\n    High严重级别Alerts = coalesce(High严重级别Alerts, 0)\n| extend \n    RiskScore = case(\n        High严重级别Alerts >= 5, 90,\n        High严重级别Alerts >= 3, 75,\n        High严重级别Alerts >= 1, 60,\n        TotalAlerts >= 5, 45,\n        TotalAlerts >= 1, 30,\n        15\n    ),\n    RiskLevel = case(\n        High严重级别Alerts >= 5, \"\ud83d\udd25 Critical Risk\",\n        High严重级别Alerts >= 3, \"\ud83d\udd34 High Risk\",\n        High严重级别Alerts >= 1 or TotalAlerts >= 5, \"\ud83d\udfe0 Medium Risk\",\n        TotalAlerts >= 1, \"\ud83d\udfe1 Low Risk\",\n        \"\ud83d\udfe2 No Risk\"\n    ),\n    SecurityStatus = case(\n        High严重级别Alerts > 0, strcat(\"\ud83d\udea8 \", tostring(High严重级别Alerts), \" Critical Alerts\"),\n        TotalAlerts > 0, strcat(\"\u26a0\ufe0f \", tostring(TotalAlerts), \" General Alerts\"),\n        \"\u2705 No Security Alerts\"\n    )\n| project \n    ['AI Service Name'] = FinalServiceName,\n    ['服务类型'] = FinalServiceType,\n    ['Resource Group'] = coalesce(ResourceGroup, \"Unknown\"),\n    ['风险等级'] = RiskLevel,\n    ['风险评分'] = RiskScore,\n    ['Security Status'] = SecurityStatus,\n    ['Critical Alerts'] = High严重级别Alerts,\n    ['告警总数'] = TotalAlerts,\n    ['最后活动'] = coalesce(LastActivity, LastAlert),\n    ['Activity Count'] = coalesce(ActivityCount, 0)\n| order by ['风险评分'] desc, ['告警总数'] desc\n| take 25",
                            "size": 0,
                            "title": "\ud83d\udce6 AI服务资产清单与风险评估",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "Critical Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "告警总数",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ],
                                "rowLimit": 50,
                                "filter": true
                            }
                        },
                        "name": "model_inventory_list_fixed",
                        "id": "9beece67-dc7e-484e-8813-54e86aee931e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI服务配置变更监控\nAuditLogs\n| extend TargetResourcesText = tostring(TargetResources), AdditionalDetailsText = tostring(AdditionalDetails)\n| where TimeGenerated > ago(30d)\n| where OperationName has_any ('Add', 'Update', 'Delete', 'Modify', 'Create', 'Remove', 'Grant', 'Revoke')\n| where TargetResourcesText has_any ('cognitive', 'openai', 'machinelearning', 'bot', 'ai') or\n        AdditionalDetailsText has_any ('CognitiveServices', 'OpenAI', 'MachineLearning', 'BotService') or\n        Category == 'ApplicationManagement'\n| extend\n    ResourceName = coalesce(\n        tostring(TargetResources[0].displayName),\n        tostring(TargetResources[0].userPrincipalName),\n        tostring(TargetResources[0].id),\n        'Unknown Resource'\n    ),\n    Actor = coalesce(\n        tostring(InitiatedBy.user.userPrincipalName),\n        tostring(InitiatedBy.app.displayName),\n        tostring(InitiatedBy.app.servicePrincipalName),\n        'System Operation'\n    ),\n    SourceIP = coalesce(\n        tostring(InitiatedBy.user.ipAddress),\n        tostring(InitiatedBy.app.ipAddress),\n        'IP Not Recorded'\n    ),\n    AIServiceType = case(\n        TargetResourcesText has 'cognitive' or AdditionalDetailsText has 'CognitiveServices', '\ud83e\udde0 Cognitive Services',\n        TargetResourcesText has 'openai' or AdditionalDetailsText has 'OpenAI', '\ud83e\udd16 Azure OpenAI',\n        TargetResourcesText has 'machinelearning' or AdditionalDetailsText has 'MachineLearning', '\ud83d\udcca Machine Learning',\n        TargetResourcesText has 'bot' or AdditionalDetailsText has 'BotService', '\ud83e\udd16 Bot Service',\n        TargetResourcesText has 'copilot' or AdditionalDetailsText has 'Copilot', '\ud83d\udcbc Microsoft Copilot',\n        Category == 'ApplicationManagement', '\ud83d\udcf1 Application Management',\n        '\u2699\ufe0f Other Services'\n    ),\n    RiskLevel = case(\n        OperationName has_any ('Delete', 'Remove', 'Revoke'), '\ud83d\udd34 High-Risk Operation',\n        OperationName has_any ('Grant', 'Add') and TargetResourcesText has_any ('admin', 'owner', 'contributor'), '\ud83d\udd34 Privilege Escalation',\n        OperationName has_any ('Update', 'Modify') and TargetResourcesText has_any ('key', 'secret', 'credential'), '\ud83d\udfe0 Sensitive Change',\n        OperationName has_any ('Create', 'Add'), '\ud83d\udfe1 Resource Creation',\n        '\ud83d\udfe2 Routine Operation'\n    ),\n    ChangeDetails = case(\n        OperationName has 'Add', strcat('Added: ', tostring(TargetResources[0].type)),\n        OperationName has 'Delete', strcat('Deleted: ', tostring(TargetResources[0].type)),\n        OperationName has 'Grant', strcat('Permission Action: ', OperationName),\n        strcat('Operation: ', OperationName)\n    ),\n    OriginalTime = TimeGenerated\n| project\n    ['Timestamp'] = format_datetime(TimeGenerated, 'MM-dd HH:mm:ss'),\n    ['AI 服务类型'] = AIServiceType,\n    ['Resource Name'] = ResourceName,\n    ['Operation Type'] = OperationName,\n    ['风险等级'] = RiskLevel,\n    ['Actor'] = Actor,\n    ['Source IP Address'] = SourceIP,\n    ['Change Details'] = ChangeDetails,\n    ['Operation Result'] = Result,\n    OriginalTime\n| order by OriginalTime desc\n| project-away OriginalTime\n| take 30",
                            "size": 0,
                            "title": "\u2699\ufe0f AI服务配置变更监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Result",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Success",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Failure",
                                                    "representation": "redBright"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Time",
                                        "formatter": 6,
                                        "formatOptions": {
                                            "customColumnWidthSetting": "12%"
                                        }
                                    }
                                ],
                                "rowLimit": 50,
                                "filter": true,
                                "sortBy": [
                                    {
                                        "itemKey": "Time",
                                        "sortOrder": 2
                                    }
                                ]
                            },
                            "sortBy": [
                                {
                                    "itemKey": "Time",
                                    "sortOrder": 2
                                }
                            ]
                        },
                        "name": "model_configuration_monitoring_fixed",
                        "id": "3b38848a-7833-4a32-9546-fd1d6d08acec"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI服务访问授权监控\n// Tracks AI service access permissions and authorization changes\n// Uses Entra ID AuditLogs for application consent and permission grants\nlet t0 = {TimeRange:start};\nAuditLogs\n| where TimeGenerated > t0\n| where Category == \"ApplicationManagement\"\n| where OperationName has_any (\"Consent to application\", \"Add service principal\", \"Add OAuth2PermissionGrant\")\n| where TargetResources[0].displayName has_any (\"AI\", \"Cognitive\", \"OpenAI\", \"Bot\", \"Copilot\", \"GPT\", \"Machine Learning\") or \n        tostring(TargetResources[0].modifiedProperties) has_any (\"Cognitive\", \"OpenAI\", \"AI\")\n| extend\n    AppName = tostring(TargetResources[0].displayName),\n    AppId = tostring(TargetResources[0].id),\n    PermissionsGranted = tostring(TargetResources[0].modifiedProperties[0].newValue)\n| extend\n    Actor = coalesce(\n        tostring(InitiatedBy.user.userPrincipalName),\n        tostring(InitiatedBy.app.displayName),\n        \"System Operation\"\n    ),\n    AIServiceType = case(\n        AppName has \"Cognitive\" or tostring(TargetResources) has \"Cognitive\", \"\ud83e\udde0 Cognitive Services\",\n        AppName has \"OpenAI\" or tostring(TargetResources) has \"OpenAI\", \"\ud83e\udd16 Azure OpenAI\",\n        AppName has \"Copilot\" or tostring(TargetResources) has \"Copilot\", \"\ud83d\udcbc Microsoft Copilot\",\n        AppName has \"Bot\" or tostring(TargetResources) has \"Bot\", \"\ud83e\udd1d Bot Services\",\n        AppName has \"ML\" or AppName has \"Machine Learning\", \"\ud83d\udcca Machine Learning\",\n        \"\u2699\ufe0f Other AI Services\"\n    ),\n    SecurityLevel = case(\n        PermissionsGranted has_any (\"full_control\", \"admin\", \"owner\", \".default\"), \"\ud83d\udd34 High Risk\",\n        PermissionsGranted has_any (\"write\", \"contributor\", \"ReadWrite\"), \"\ud83d\udfe0 Medium Risk\",\n        PermissionsGranted has_any (\"read\", \"reader\"), \"\ud83d\udfe1 Low Risk\",\n        \"\u26aa Unknown Risk\"\n    )\n| project\n    ['Time'] = format_datetime(TimeGenerated, 'MM-dd HH:mm:ss'),\n    ['AI 服务类型'] = AIServiceType,\n    ['Application Name'] = coalesce(AppName, \"Unknown Application\"),\n    ['Application ID'] = AppId,\n    ['Authorization Operation'] = OperationName,\n    ['Granted Permissions'] = PermissionsGranted,\n    ['风险等级'] = SecurityLevel,\n    ['Executor'] = Actor,\n    ['Operation Result'] = Result,\n    TimeGenerated\n| order by TimeGenerated desc\n| project-away TimeGenerated\n| take 30",
                            "size": 0,
                            "title": "\ud83d\udd11 AI服务访问授权监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "风险等级",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Operation Result",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Success",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Failure",
                                                    "representation": "redBright"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Time",
                                        "formatter": 6,
                                        "formatOptions": {
                                            "customColumnWidthSetting": "12%"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "model_security_maturity_fixed",
                        "id": "c0ff88f7-0024-480f-86f0-654a846881e3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI Agent & Application Usage Tracking\n// Tracks AI Agent and AI application usage from Entra ID\n// Uses SigninLogs and AuditLogs for actual deployment and usage data\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    // AI Application sign-ins from Entra ID\n    SigninLogs\n    | where TimeGenerated > t0\n    | where AppDisplayName has_any (\"AI\", \"Agent\", \"Copilot\", \"GPT\", \"Chat\", \"Model\", \"Studio\")\n    | extend\n        Source = \"Entra ID - User Access\",\n        AgentName = AppDisplayName,\n        AgentID = AppId,\n        AgentType = case(\n            AppDisplayName has \"Copilot\", \"Microsoft Copilot\",\n            AppDisplayName has \"AI Studio\", \"AI Studio Application\",\n            AppDisplayName has \"GitHub\", \"GitHub Copilot\",\n            AppDisplayName has \"Security\", \"Security Copilot\",\n            AppDisplayName has \"Agent\", \"Custom Agent\",\n            \"AI Application\"\n        ),\n        DeploymentStatus = case(\n            ResultType == 0, \"Active\",\n            ResultType != 0, \"Access Issues\",\n            \"Unknown\"\n        ),\n        Owner = UserPrincipalName,\n        LastModified = TimeGenerated\n    | project Source, AgentName, AgentID, AgentType, DeploymentStatus, Owner, LastModified\n    ),\n    (\n    // AI Application management from AuditLogs\n    AuditLogs\n    | where TimeGenerated > t0\n    | where OperationName has_any (\"Add application\", \"Update application\", \"Add service principal\")\n    | where TargetResources[0].displayName has_any (\"AI\", \"Agent\", \"Copilot\", \"GPT\", \"Model\", \"Studio\")\n    | extend\n        Source = \"Entra ID - App Management\",\n        AgentName = tostring(TargetResources[0].displayName),\n        AgentID = tostring(TargetResources[0].id),\n        AgentType = case(\n            tostring(TargetResources[0].type) == \"Application\", \"Enterprise Application\",\n            tostring(TargetResources[0].type) == \"ServicePrincipal\", \"Service Principal\",\n            \"Other App Type\"\n        ),\n        DeploymentStatus = case(\n            Result == \"success\", \"Active\",\n            Result == \"failure\", \"Failed\",\n            \"Unknown\"\n        ),\n        Owner = tostring(InitiatedBy.user.userPrincipalName),\n        LastModified = TimeGenerated\n    | project Source, AgentName, AgentID, AgentType, DeploymentStatus, Owner, LastModified\n    )\n| where isnotempty(AgentName)\n| summarize\n    TotalActivity = count(),\n    ActiveCount = countif(DeploymentStatus == \"Active\"),\n    FailedCount = countif(DeploymentStatus == \"Access Issues\" or DeploymentStatus == \"Failed\"),\n    UniqueOwners = dcount(Owner),\n    Owners = make_set(Owner, 5),\n    FirstSeen = min(LastModified),\n    LastActivity = max(LastModified),\n    ActivityDays = datetime_diff('day', max(LastModified), min(LastModified)) + 1\n  by Source, AgentName, AgentID, AgentType\n| extend\n    HealthStatus = case(\n        FailedCount == 0 and ActiveCount > 0, \" Healthy\",\n        FailedCount > 0 and ActiveCount > FailedCount, \" Degraded\",\n        FailedCount >= ActiveCount, \" Critical\",\n        \"? Unknown\"\n    ),\n    AgentAge = case(\n        ActivityDays < 7, \"New (< 1 week)\",\n        ActivityDays < 30, \"Recent (< 1 month)\",\n        ActivityDays < 90, \"Established (< 3 months)\",\n        \"Mature (3+ months)\"\n    ),\n    UsageFrequency = round(todouble(TotalActivity) / todouble(ActivityDays), 1)\n| project\n    ['Application Name'] = AgentName,\n    ['Application Type'] = AgentType,\n    ['Source'] = Source,\n    ['Health Status'] = HealthStatus,\n    ['Age'] = AgentAge,\n    ['Total Activity'] = TotalActivity,\n    ['Usage/Day'] = UsageFrequency,\n    ['Active Sessions'] = ActiveCount,\n    ['Failed/Issues'] = FailedCount,\n    ['Unique Users'] = UniqueOwners,\n    ['User List'] = tostring(Owners),\n    ['首次发现'] = format_datetime(FirstSeen, 'MM-dd HH:mm'),\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm'),\n    ['Days Active'] = ActivityDays\n| order by ['Total Activity'] desc, ['最后活动'] desc",
                            "size": 0,
                            "title": "\ud83d\udcf1 AI应用使用与访问跟踪",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Health Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Healthy",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Degraded",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": " Unknown",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Deployments",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Failed",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    }
                                ],
                                "filter": true,
                                "rowLimit": 50
                            }
                        },
                        "name": "ai_agent_inventory"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "model_inventory"
            },
            "name": "model_inventory_group",
            "id": "03508cb0-001b-4345-aec5-18398c4b11f8"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #ff9800, #c66900); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83d\udd12 AI数据治理与隐私保护</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: 该视图利用 Microsoft Purview 与其他安全工具的真实数据监控AI系统数据使用与敏感数据保护，确保组织遵循数据治理政策与隐私法规。通过跟踪实际数据来源中的数据分类、使用与访问模式，帮助安全团队识别潜在数据泄露风险与未授权访问。\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #fff4e5; padding: 10px; border-left: 4px solid #ff9800; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #ff9800;\">\ud83d\udcca 数据源与分类</h4>\n    <p style=\"font-size: 13px;\">基于 Purview 分析的实际数据分类与敏感信息，监控AI模型使用的数据</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #fff4e5; padding: 10px; border-left: 4px solid #ff9800; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #ff9800;\">\ud83d\udd0d 数据访问审计</h4>\n    <p style=\"font-size: 13px;\">基于实际审计日志跟踪数据访问模式、异常行为与授权合规性</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "data_governance_header",
                        "id": "683c5ba9-76ee-4261-9990-2b1288b6e376"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI-related Data Sensitivity Analysis - Fixed (Using Available Data Sources)\n// Solution 1: Use CloudAppEvents to get file access information\nlet aiFilePatterns = dynamic([\"model\", \"train\", \"data\", \"dataset\", \"ml\", \"ai\", \"predict\", \"analytics\", \"neural\", \"json\", \"csv\", \"pkl\", \"h5\", \"keras\", \"tensorflow\", \"pytorch\"]);\n\nCloudAppEvents\n| where TimeGenerated > ago(30d)\n| where ActionType in (\"FileAccessed\", \"FileDownloaded\", \"FileModified\", \"FileUploaded\")\n| where ObjectName has_any (aiFilePatterns) or ObjectId has_any (aiFilePatterns)\n| extend \n    FileExtension = tostring(split(ObjectName, \".\")[-1]),\n    IsAIRelated = ObjectName has_any(aiFilePatterns) or ObjectId has_any(aiFilePatterns)\n| where IsAIRelated\n| extend \n    DataCategory = case(\n        FileExtension in (\"h5\", \"pb\", \"pt\", \"pkl\", \"onnx\", \"tflite\", \"bin\"), \"\ud83e\udd16 AI模型 Files\",\n        FileExtension in (\"json\", \"yaml\", \"yml\", \"toml\", \"ini\", \"config\"), \"\u2699\ufe0f Configuration Files\",\n        FileExtension in (\"csv\", \"tsv\", \"parquet\", \"avro\", \"xls\", \"xlsx\"), \"\ud83d\udcca Dataset Files\",\n        FileExtension in (\"py\", \"ipynb\", \"r\", \"js\"), \"\ud83d\udcbb Code Files\",\n        \"\ud83d\udcc1 Other Files\"\n    ),\n    SensitivityLevel = case(\n        ObjectName has_any (\"confidential\", \"secret\", \"sensitive\", \"personal\", \"pii\"), \"\ud83d\udd34 High Sensitivity\",\n        ObjectName has_any (\"internal\", \"restricted\"), \"\ud83d\udfe0 Medium Sensitivity\", \n        ObjectName has \"public\", \"\ud83d\udfe2 Public\",\n        \"\u26aa Unclassified\"\n    )\n| summarize \n    FileCount = count(),\n    UniqueUsers = dcount(AccountDisplayName),\n    SensitiveFileCount = countif(SensitivityLevel has \"Sensitivity\"),\n    LastAccess = max(TimeGenerated)\n  by DataCategory, SensitivityLevel, Application\n| extend \n    SensitiveRatio = round(100.0 * SensitiveFileCount / FileCount, 1)\n| project \n    ['Data Category'] = DataCategory,\n    ['Sensitivity Label'] = SensitivityLevel,\n    ['Application Platform'] = Application,\n    ['Total Files'] = FileCount,\n    ['Sensitive Files'] = SensitiveFileCount,\n    ['Sensitivity Ratio'] = strcat(tostring(SensitiveRatio), '%'),\n    ['Access Users'] = UniqueUsers,\n    ['Last Access'] = format_datetime(LastAccess, 'MM-dd HH:mm')\n| order by ['Sensitive Files'] desc\n| take 25",
                            "size": 0,
                            "title": "\ud83d\udd0d AI相关数据敏感性分析 - Microsoft Purview",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sensitivity Label",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Sensitive Files",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "Sensitivity Ratio",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redGreen"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "data_source_classification",
                        "id": "a50ce1b2-2d7c-43ab-8708-b96a96d2b543"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI数据访问审计记录 (Fixed)\nlet aiDataPatterns = dynamic([\"model\", \"train\", \"data\", \"dataset\", \"ml-\", \"ai-\", \"openai\", \"cognitive\", \"predict\"]);\n\nCloudAppEvents\n| where TimeGenerated > ago(30d)\n| where ActionType in (\"FileDownloaded\", \"FileAccessed\", \"FileModified\", \"FileUploaded\")\n| where ObjectName has_any (aiDataPatterns) or ObjectId has_any (aiDataPatterns) or Application has_any (\"Copilot\", \"AI\", \"OpenAI\")\n| extend \n    AISensitivity = case(\n        ObjectName has_any (\"confidential\", \"secret\", \"sensitive\", \"personal\", \"pii\"), \"\ud83d\udd34 Sensitive AI Data\",\n        ObjectName has_any (\"internal\", \"restricted\"), \"\ud83d\udfe0 Internal AI Data\",\n        \"\ud83d\udfe2 General AI Data\"\n    ),\n    AIDataType = case(\n        ObjectName has_any (\"model\", \".h5\", \".pb\", \".pt\", \".pkl\", \".onnx\"), \"\ud83e\udd16 AI模型\",\n        ObjectName has_any (\"dataset\", \"train\", \".csv\", \".json\", \"data\"), \"\ud83d\udcca Training Data\",\n        ObjectName has_any (\"config\", \"parameter\", \"setting\"), \"\u2699\ufe0f Configuration File\", \n        Application has \"Copilot\", \"\ud83d\udcbc Copilot Data\",\n        \"\ud83d\udcc1 Other AI Resources\"\n    ),\n    AccessRisk = case(\n        ActionType == \"FileDownloaded\" and ObjectName has_any (\"confidential\", \"secret\", \"sensitive\"), \"\ud83d\udd34 High Risk Access\",\n        ActionType == \"FileModified\" and ObjectName has_any (\"sensitive\", \"confidential\"), \"\ud83d\udfe0 Medium Risk Access\",\n        ActionType == \"FileUploaded\", \"\ud83d\udce4 Data Upload\",\n        \"\ud83d\udfe2 Normal Access\"\n    )\n| project \n    ['Time'] = format_datetime(TimeGenerated, 'MM-dd HH:mm:ss'),\n    ['User'] = AccountDisplayName,\n    ['Operation'] = ActionType,\n    ['Resource Name'] = ObjectName,\n    ['Data Type'] = AIDataType,\n    ['Sensitivity'] = AISensitivity,\n    ['Risk Rating'] = AccessRisk,\n    ['IP Address'] = IPAddress,\n    ['Application'] = Application,\n    ['Device'] = DeviceType\n| order by ['Time'] desc\n| take 50",
                            "size": 0,
                            "title": "\ud83d\udcc2 AI数据访问审计记录",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sensitivity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Risk Rating",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udce4",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Access Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "data_access_audit_fixed",
                        "id": "f520cccf-ab02-4844-9ec4-38159c7ace7c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI数据访问模式分析 - Based on SigninLogs and AuditLogs (Fixed)\nlet aiApps = dynamic([\"Copilot\", \"AI\", \"OpenAI\", \"Cognitive\", \"ChatGPT\", \"Claude\", \"Bard\"]);\n\nSigninLogs\n| where TimeGenerated > ago(30d)\n| where AppDisplayName has_any (aiApps)\n| extend \n    AIDataType = case(\n        AppDisplayName has_any (\"OpenAI\", \"GPT\", \"ChatGPT\"), \"\ud83e\udd16 AI模型 Files\",\n        AppDisplayName has_any (\"Copilot\", \"Microsoft 365\"), \"\ud83d\udcbc Copilot Data\",\n        AppDisplayName has_any (\"Cognitive\", \"AI Studio\"), \"\ud83d\udcca Training Datasets\",\n        AppDisplayName has_any (\"Claude\", \"Bard\"), \"\u2601\ufe0f Third-party AI\",\n        \"\ud83d\udcc1 Other AI Resources\"\n    ),\n    SensitivityLevel = case(\n        AppDisplayName has_any (\"Enterprise\", \"Business\", \"Microsoft\"), \"\ud83d\udfe2 Public\",\n        AppDisplayName has_any (\"Personal\", \"Consumer\", \"Free\"), \"\ud83d\udd34 High Sensitivity\",\n        Location !in (\"US\", \"CA\", \"GB\", \"AU\"), \"\ud83d\udfe0 Medium Sensitivity\",\n        \"\u26aa Unclassified\"\n    )\n| extend\n    AccessRisk = case(\n        SensitivityLevel == \"\ud83d\udd34 High Sensitivity\" and AIDataType == \"\ud83e\udd16 AI模型 Files\", \"\ud83d\udd34 High Risk Download\",\n        SensitivityLevel has \"Sensitivity\" and ResultType != 0, \"\ud83d\udfe0 Sensitive Data Modification\",\n        AppDisplayName has_any (\"ChatGPT\", \"Claude\", \"Bard\"), \"\ud83d\udce4 Data Upload\",\n        \"\ud83d\udfe2 Normal Access\"\n    )\n| summarize \n    AccessCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    HighRiskAccess = countif(AccessRisk has \"Risk\"),\n    LastAccess = max(TimeGenerated)\n  by AIDataType, SensitivityLevel, AccessRisk\n| project \n    ['AI Data Type'] = AIDataType,\n    ['Sensitivity Level'] = SensitivityLevel,\n    ['Access Risk'] = AccessRisk,\n    ['Access Count'] = AccessCount,\n    ['Users Involved'] = UniqueUsers,\n    ['High Risk Access'] = HighRiskAccess,\n    ['Last Access'] = format_datetime(LastAccess, 'MM-dd HH:mm')\n| order by ['Access Count'] desc",
                            "size": 0,
                            "title": "\ud83d\udcca AI数据访问模式分析",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Sensitivity Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26aa",
                                                    "representation": "gray"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Access Risk",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udce4",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Access Count",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "ai_data_access_patterns_fixed",
                        "id": "af8b5587-9a7b-4329-9332-e0b4770065a7"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI应用数据合规监控 (Based on SigninLogs and SecurityAlert)\nlet approvedAIApps = dynamic([\"Security Copilot\", \"Azure AI Studio\", \"Microsoft 365 Copilot\", \"Bing Chat Enterprise\"]);\nlet restrictedAIApps = dynamic([\"ChatGPT\", \"Claude\", \"Google Bard\", \"Notion AI\"]);\n\nSigninLogs\n| where TimeGenerated > ago(30d)\n| where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\", \"claude\", \"bard\")\n| extend \n    ComplianceStatus = case(\n        AppDisplayName has_any (approvedAIApps), \"\u2705 Compliant Application\",\n        AppDisplayName has_any (restrictedAIApps), \"\ud83d\udeab Restricted Application\", \n        \"\u26a0\ufe0f Unknown Application\"\n    ),\n    UsageRisk = case(\n        AppDisplayName has_any (restrictedAIApps) and Location !in (\"US\", \"CA\", \"GB\", \"AU\"), \"\ud83d\udd34 High Risk Usage\",\n        AppDisplayName has_any (restrictedAIApps), \"\ud83d\udfe0 Non-compliant Usage\",\n        \"\ud83d\udfe2 Normal Usage\"\n    ),\n    DataLocation = case(\n        Location == \"US\", \"\ud83c\uddfa\ud83c\uddf8 United States\",\n        Location == \"CN\", \"\ud83c\udde8\ud83c\uddf3 China\", \n        Location == \"GB\", \"\ud83c\uddec\ud83c\udde7 United Kingdom\",\n        Location == \"CA\", \"\ud83c\udde8\ud83c\udde6 Canada\",\n        Location == \"AU\", \"\ud83c\udde6\ud83c\uddfa Australia\",\n        strcat(\"\ud83c\udf10 \", Location)\n    )\n| summarize \n    LoginCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    RiskySessions = countif(UsageRisk has \"Risk\"),\n    ViolationSessions = countif(UsageRisk has \"compliant\")\n  by AppDisplayName, ComplianceStatus, UsageRisk, DataLocation\n| project \n    ['AI Application'] = AppDisplayName,\n    ['Compliance Status'] = ComplianceStatus,\n    ['Usage Risk'] = UsageRisk,\n    ['Data Location'] = DataLocation,\n    ['总登录次数'] = LoginCount,\n    ['Unique Users'] = UniqueUsers,\n    ['Risky Sessions'] = RiskySessions,\n    ['Violation Sessions'] = ViolationSessions\n| order by ['Violation Sessions'] desc, ['Risky Sessions'] desc",
                            "size": 0,
                            "title": "\u2705 AI应用数据合规监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Compliance Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u2705",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udeab",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\u26a0\ufe0f",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Usage Risk",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Violation Sessions",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Risky Sessions",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "ai_compliance_monitoring",
                        "id": "b883bda5-8f8d-4162-983d-d669656ae2cb"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  Sensitive Data AI Processing Alert Analysis\n// Tracks security alerts related to AI services accessing or processing sensitive data\n// Uses SecurityAlert table for DLP and data security alerts\nlet t0 = {TimeRange:start};\nSecurityAlert\n| where TimeGenerated > t0\n| where AlertName has_any (\"DLP\", \"Data\", \"Privacy\", \"Leak\", \"Exfiltration\", \"Sensitive\", \"Information\")\n| where Description has_any (\"AI\", \"Copilot\", \"ChatGPT\", \"Model\", \"Prompt\", \"OpenAI\", \"Cognitive\") or\n        Entities has_any (\"AI\", \"Copilot\", \"OpenAI\")\n| extend\n    DataType = case(\n        Description has_any (\"PII\", \"personal\", \"SSN\", \"credit card\", \"passport\"), \" Personal Identification Information\",\n        Description has_any (\"financial\", \"payment\", \"bank\", \"account\"), \" Financial Data\",\n        Description has_any (\"health\", \"medical\", \"PHI\", \"patient\"), \" Health Data\",\n        Description has_any (\"confidential\", \"secret\", \"classified\", \"proprietary\"), \" Confidential Information\",\n        Description has_any (\"password\", \"credential\", \"token\", \"key\"), \"? Credentials\",\n        \" General Sensitive Data\"\n    )\n| extend\n    AIContext = case(\n        Description has \"Copilot\" or Entities has \"Copilot\", \" Microsoft Copilot\",\n        Description has \"ChatGPT\" or Entities has \"ChatGPT\", \" ChatGPT\",\n        Description has \"OpenAI\" or Entities has \"OpenAI\", \" OpenAI Service\",\n        Description has \"Cognitive\" or Entities has \"Cognitive\", \" Cognitive Services\",\n        Description has \"Model\", \" AI模型\",\n        \" Other AI Service\"\n    ),\n    RiskScore = case(\n        Alert严重级别 == \"High\" and DataType has \"Identification\", 95,\n        Alert严重级别 == \"High\" and DataType has \"Financial\", 90,\n        Alert严重级别 == \"High\" and DataType has \"Health\", 90,\n        Alert严重级别 == \"High\" and DataType has \"Credentials\", 95,\n        Alert严重级别 == \"High\", 80,\n        Alert严重级别 == \"Medium\" and DataType has_any (\"Identification\", \"Financial\", \"Health\"), 70,\n        Alert严重级别 == \"Medium\", 60,\n        Alert严重级别 == \"Low\", 40,\n        30\n    )\n| project\n    ['Time'] = format_datetime(TimeGenerated, 'MM-dd HH:mm'),\n    ['AI Service'] = AIContext,\n    ['Data Type'] = DataType,\n    ['Alert 严重级别'] = Alert严重级别,\n    ['风险评分'] = RiskScore,\n    ['告警名称'] = AlertName,\n    ['Affected Entity'] = coalesce(CompromisedEntity, tostring(parse_json(tostring(Entities))[0]), \"Unknown\"),\n    ['Status'] = Status,\n    ['Description'] = substring(Description, 0, 100)\n| order by ['风险评分'] desc, ['Time'] desc\n| take 30",
                            "size": 0,
                            "title": "\ud83d\udd12 Sensitive Data AI Processing Alert Analysis",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Alert 严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "sensitive_data_ai_alerts",
                        "id": "dbb19249-b02e-466b-a9e0-df3f771ea603"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI 数据治理 Compliance Score - Real-time 指标s from actual data\nlet totalAILogins = toscalar(\n    SigninLogs\n    | where TimeGenerated > ago(30d)\n    | where AppDisplayName has_any (\"AI\", \"Copilot\", \"chat\", \"gpt\")\n    | summarize count()\n);\n\nlet complianceLogins = toscalar(\n    SigninLogs\n    | where TimeGenerated > ago(30d)\n    | where AppDisplayName has_any (\"Security Copilot\", \"Azure AI Studio\", \"Microsoft 365 Copilot\")\n    | summarize count()\n);\n\nlet violationLogins = toscalar(\n    SigninLogs\n    | where TimeGenerated > ago(30d)\n    | where AppDisplayName has_any (\"ChatGPT\", \"Claude\", \"Google Bard\")\n    | summarize count()\n);\n\nlet dataLeakAlerts = toscalar(\n    SecurityAlert\n    | where TimeGenerated > ago(30d)\n    | where AlertName has_any (\"DLP\", \"Data\", \"Leak\") and Description has_any (\"AI\", \"Copilot\")\n    | summarize count()\n);\n\nlet complianceRate = case(totalAILogins > 0, round(todouble(complianceLogins) / todouble(totalAILogins) * 100, 1), 0.0);\nlet violationRate = case(totalAILogins > 0, round(todouble(violationLogins) / todouble(totalAILogins) * 100, 1), 0.0);\nlet dataRiskScore = case(\n    dataLeakAlerts >= 10, 90,\n    dataLeakAlerts >= 5, 70,\n    dataLeakAlerts >= 1, 50,\n    20\n);\nlet overallRisk = case(\n    violationRate > 30 or dataRiskScore >= 70, \"\ud83d\udd25 High Risk\",\n    violationRate > 15 or dataRiskScore >= 50, \"\ud83d\udfe0 Medium Risk\", \n    violationRate > 5, \"\ud83d\udfe1 Needs Attention\",\n    \"\ud83d\udfe2 Low Risk\"\n);\n\n// Create table using union of print statements\nprint 指标 = \"\u2705 AI Usage 合规率\", Value = strcat(tostring(complianceRate), \"%\"), Description = \"Percentage of compliant AI application usage\"\n| union (print 指标 = \"\u26a0\ufe0f AI 违规率\", Value = strcat(tostring(violationRate), \"%\"), Description = \"Percentage of restricted AI application usage\")\n| union (print 指标 = \"\ud83d\udcca Data 风险评分\", Value = tostring(dataRiskScore), Description = \"风险评分 based on data leak alerts\")\n| union (print 指标 = \"\ud83c\udfaf Overall 风险等级\", Value = overallRisk, Description = \"Comprehensive 数据治理 风险评估\")",
                            "size": 0,
                            "title": "\ud83d\udcca AI 数据治理 Compliance Score",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Value",
                                        "formatter": 1,
                                        "formatOptions": {
                                            "customColumnWidthSetting": "20%"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "ai_governance_score",
                        "id": "74371eca-4e7a-48e9-adf8-5c968adc33ba"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI Agent Governance & Security Monitoring\n// Azure AI Foundry and AI Studio agent deployment and compliance tracking\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    // Purview AI Hub - Agent governance logs\n    PurviewAuditLogs\n    | where TimeGenerated > t0\n    | where OperationName has_any (\"AIAgent\", \"Agent\", \"Deployment\", \"ModelDeploy\")\n    | extend\n        Source = \"Purview AI Hub\",\n        AgentName = tostring(TargetResources[0].displayName),\n        Activity = OperationName,\n        ComplianceStatus = case(\n            ResultStatus == \"Success\" and OperationName has \"Deploy\", \"Compliant\",\n            ResultStatus == \"Failure\", \"Non-Compliant\",\n            OperationName has \"Delete\", \"Under Review\",\n            \"Pending\"\n        ),\n        RiskLevel = case(\n            ResultStatus == \"Failure\" or OperationName has \"Delete\", \"High\",\n            OperationName has_any (\"Modify\", \"Update\"), \"Medium\",\n            \"Low\"\n        )\n    | project TimeGenerated, Source, AgentName, Activity, ComplianceStatus, RiskLevel, User = UserId, IPAddress = ClientIP\n    ),\n    (\n    // Azure AI Foundry - Agent audit logs  \n    AuditLogs\n    | where TimeGenerated > t0\n    | where OperationName has_any (\"AI\", \"Agent\", \"Model\", \"Deployment\")\n    | extend\n        Source = \"AI Foundry\",\n        AgentName = tostring(TargetResources[0].displayName),\n        Activity = OperationName,\n        ComplianceStatus = case(\n            Result == \"success\" and OperationName has \"Create\", \"Compliant\",\n            Result == \"failure\", \"Non-Compliant\",\n            OperationName has \"Delete\", \"Under Review\",\n            \"Pending\"\n        ),\n        RiskLevel = case(\n            Result == \"failure\", \"High\",\n            OperationName has \"Delete\", \"High\",\n            OperationName has_any (\"Update\", \"Modify\"), \"Medium\",\n            \"Low\"\n        )\n    | project TimeGenerated, Source, AgentName, Activity, ComplianceStatus, RiskLevel, User = tostring(InitiatedBy.user.userPrincipalName), IPAddress = tostring(InitiatedBy.user.ipAddress)\n    ),\n    (\n    // AI Studio access - Sign-in governance\n    SigninLogs\n    | where TimeGenerated > t0\n    | where AppDisplayName has_any (\"AI Studio\", \"AI Foundry\", \"Azure AI\")\n    | extend\n        Source = \"AI Studio Access\",\n        AgentName = \"N/A\",\n        Activity = strcat(\"Sign-in: \", AppDisplayName),\n        ComplianceStatus = case(\n            ResultType == \"0\" and RiskLevelDuringSignIn == \"none\", \"Compliant\",\n            RiskLevelDuringSignIn == \"high\", \"Non-Compliant\",\n            ResultType != \"0\", \"Non-Compliant\",\n            \"Pending\"\n        ),\n        RiskLevel = case(\n            RiskLevelDuringSignIn == \"high\" or ResultType != \"0\", \"High\",\n            RiskLevelDuringSignIn == \"medium\", \"Medium\",\n            \"Low\"\n        )\n    | project TimeGenerated, Source, AgentName, Activity, ComplianceStatus, RiskLevel, User = UserPrincipalName, IPAddress\n    )\n| summarize\n    TotalActivities = count(),\n    CompliantCount = countif(ComplianceStatus == \"Compliant\"),\n    NonCompliantCount = countif(ComplianceStatus == \"Non-Compliant\"),\n    HighRiskCount = countif(RiskLevel == \"High\"),\n    MediumRiskCount = countif(RiskLevel == \"Medium\"),\n    UniqueAgents = dcountif(AgentName, AgentName != \"N/A\"),\n    UniqueUsers = dcount(User),\n    UniqueIPs = dcount(IPAddress),\n    FirstActivity = min(TimeGenerated),\n    LastActivity = max(TimeGenerated)\n  by Source\n| extend\n    ComplianceRate = round((todouble(CompliantCount) / todouble(TotalActivities)) * 100, 1),\n    RiskScore = (HighRiskCount * 3) + (MediumRiskCount * 2) + NonCompliantCount\n| extend GovernanceStatus = case(\n    ComplianceRate >= 95 and RiskScore < 10, \"Excellent Governance\",\n    ComplianceRate >= 85 and RiskScore < 20, \"Good Governance\",\n    ComplianceRate >= 70 and RiskScore < 40, \"Needs Improvement\",\n    \"Poor Governance - Action Required\"\n)\n| project\n    ['Data Source'] = Source,\n    ['Governance Status'] = GovernanceStatus,\n    ['Total Activities'] = TotalActivities,\n    ['合规率 %'] = ComplianceRate,\n    ['风险评分'] = RiskScore,\n    ['Compliant'] = CompliantCount,\n    ['Non-Compliant'] = NonCompliantCount,\n    ['High-Risk Events'] = HighRiskCount,\n    ['Unique Agents'] = UniqueAgents,\n    ['Unique Users'] = UniqueUsers,\n    ['唯一IP数'] = UniqueIPs,\n    ['First Activity'] = format_datetime(FirstActivity, 'MM-dd HH:mm'),\n    ['最后活动'] = format_datetime(LastActivity, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['Total Activities'] desc",
                            "size": 0,
                            "title": "\ud83e\udd16 AI Agent Governance & 合规监控",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Governance Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Excellent",
                                                    "representation": "green"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Good",
                                                    "representation": "blue"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Needs",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Poor",
                                                    "representation": "redBright"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "合规率 %",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "风险评分",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "Non-Compliant",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "ai_agent_governance"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "//  AI Agent Content Safety & Prompt Shield Violations\n// Simplified query for Content Safety monitoring\nlet t0 = {TimeRange:start};\nSecurityAlert\n| where TimeGenerated > t0\n| extend AlertNameLower = tolower(AlertName), DescriptionLower = tolower(Description)\n| where AlertNameLower has_any (\"content\", \"prompt\", \"shield\", \"safety\", \"jailbreak\", \"injection\", \"toxic\", \"harmful\", \"abuse\", \"violation\") or\n        DescriptionLower has_any (\"content\", \"prompt\", \"shield\", \"safety\", \"jailbreak\", \"injection\", \"toxic\", \"harmful\")\n| extend\n    ViolationType = case(\n        AlertNameLower has \"prompt\" and AlertNameLower has_any (\"injection\", \"shield\"), \"\ud83d\udee1\ufe0f Prompt Shield - Injection Attack\",\n        AlertNameLower has \"jailbreak\", \"\ud83d\udea8 Jailbreak Attempt\",\n        AlertNameLower has \"hate\" or DescriptionLower has \"hate\", \"\u26a0\ufe0f Content Safety - Hate Speech\",\n        AlertNameLower has \"violence\" or DescriptionLower has \"violence\", \"\ud83d\udd34 Content Safety - Violence\",\n        AlertNameLower has \"sexual\" or DescriptionLower has \"sexual\", \"\ud83d\udd1e Content Safety - Sexual Content\",\n        AlertNameLower has \"selfharm\" or DescriptionLower has \"self-harm\", \"\u2695\ufe0f Content Safety - Self-Harm\",\n        AlertNameLower has \"toxic\" or DescriptionLower has \"toxic\", \"\u2620\ufe0f Toxicity Detection\",\n        \"\u26a0\ufe0f Other Content Violation\"\n    ),\n    UserPrincipal = coalesce(CompromisedEntity, tostring(parse_json(tostring(Entities))[0].Name), \"Unknown User\")\n| summarize\n    ViolationCount = count(),\n    CriticalCount = countif(Alert严重级别 == \"High\"),\n    MediumCount = countif(Alert严重级别 == \"Medium\"),\n    LowCount = countif(Alert严重级别 == \"Low\"),\n    UniqueUsers = dcount(UserPrincipal),\n    FirstViolation = min(TimeGenerated),\n    LastViolation = max(TimeGenerated),\n    SampleAlerts = make_set(AlertName, 3)\n  by ViolationType, Alert严重级别\n| extend\n    严重级别Score = case(\n        Alert严重级别 == \"High\", ViolationCount * 5,\n        Alert严重级别 == \"Medium\", ViolationCount * 3,\n        ViolationCount * 1\n    )\n| project\n    ['Violation Type'] = ViolationType,\n    ['严重级别'] = Alert严重级别,\n    ['Total Violations'] = ViolationCount,\n    ['严重级别 Score'] = 严重级别Score,\n    ['Critical Events'] = CriticalCount,\n    ['Medium Events'] = MediumCount,\n    ['Low Events'] = LowCount,\n    ['Unique Users'] = UniqueUsers,\n    ['Sample Alerts'] = tostring(SampleAlerts),\n    ['First Violation'] = format_datetime(FirstViolation, 'MM-dd HH:mm'),\n    ['Last Violation'] = format_datetime(LastViolation, 'MM-dd HH:mm')\n| order by ['严重级别 Score'] desc, ['Total Violations'] desc",
                            "size": 0,
                            "title": "\ud83d\udee1\ufe0f AI Agent Content Safety & Prompt Shield Violations",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "严重级别",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别 Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Violations",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ],
                                "filter": true
                            }
                        },
                        "name": "agent_content_safety"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "data_governance"
            },
            "name": "data_governance_group",
            "id": "66ac63f3-3e54-4f69-8554-f65ec602f82a"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "<div style=\"background: linear-gradient(to right, #6366f1, #4f46e5); padding: 10px; border-radius: 5px; color: white; margin-bottom: 15px;\">\n  <h2 style=\"margin: 0;\">\ud83c\udfa8 Multimodal AI 威胁检测</h2>\n  <h4 style=\"margin: 5px 0; opacity: 0.9;\">作者: Jason Liang</h4>\n</div>\n\n> **价值说明**: Emerging 威胁检测 for multimodal AI systems spanning text, images, audio, and video. Covers deepfake attacks, cross-modal injection, synthetic media detection, bio指标 spoofing, and other advanced attack techniques. Addresses security risks in multimodal LLMs including GPT-4V, Claude-3, and Gemini.\n\n<div style=\"display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;\">\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0f4ff; padding: 10px; border-left: 4px solid #6366f1; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #6366f1;\">\ud83c\udfad Deepfake Detection</h4>\n    <p style=\"font-size: 13px; color: #333;\">Detect AI-generated fake images, videos, and audio content</p>\n  </div>\n  <div style=\"flex: 1; min-width: 200px; background-color: #f0f4ff; padding: 10px; border-left: 4px solid #6366f1; border-radius: 4px;\">\n    <h4 style=\"margin: 0; color: #6366f1;\">\ud83d\udd00 Cross-Modal Attacks</h4>\n    <p style=\"font-size: 13px; color: #333;\">Analyze cross-modal attacks such as text\u2192image, audio\u2192video</p>\n  </div>\n</div>\n\n---"
                        },
                        "name": "multimodal_header",
                        "id": "8c768a98-3be5-459c-8660-6bc15d925ebc"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Multimodal AI Usage & Security Overview\n// Based on Azure AI Services, OpenAI, and Application logs\nlet t0 = {TimeRange:start};\nunion isfuzzy=true\n    (\n    AzureDiagnostics\n    | where TimeGenerated > t0\n    | where ResourceProvider == \"MICROSOFT.COGNITIVESERVICES\" or Category contains \"OpenAI\"\n    | extend ServiceType = case(\n        properties_s contains \"vision\" or properties_s contains \"image\" or OperationName contains \"Vision\", \"Computer Vision\",\n        properties_s contains \"speech\" or properties_s contains \"audio\" or OperationName contains \"Speech\", \"Speech Services\",\n        properties_s contains \"video\" or OperationName contains \"Video\", \"Video Analysis\",\n        properties_s contains \"gpt-4\" or properties_s contains \"dalle\" or OperationName contains \"OpenAI\", \"GPT-4/DALL-E\",\n        \"Text Processing\"\n    )\n    | extend RiskIndicator = case(\n        OperationName contains \"Delete\" or ResultType == \"Failure\", \"High Risk\",\n        properties_s contains \"error\" or httpStatusCode_d >= 400, \"Medium Risk\",\n        \"Normal\"\n    )\n    | project TimeGenerated, ServiceType, RiskIndicator, OperationName, ResultType, CallerIPAddress\n    ),\n    (\n    SigninLogs\n    | where TimeGenerated > t0\n    | where AppDisplayName has_any (\"OpenAI\", \"Cognitive\", \"Vision\", \"Speech\")\n    | extend ServiceType = \"AI Service Access\"\n    | extend RiskIndicator = case(\n        RiskLevelDuringSignIn == \"high\" or RiskLevelAggregated == \"high\", \"High Risk\",\n        RiskLevelDuringSignIn == \"medium\" or RiskLevelAggregated == \"medium\", \"Medium Risk\",\n        \"Normal\"\n    )\n    | project TimeGenerated, ServiceType, RiskIndicator, OperationName = AppDisplayName, ResultType = ResultType, CallerIPAddress = IPAddress\n    )\n| summarize \n    TotalRequests = count(),\n    HighRiskCount = countif(RiskIndicator == \"High Risk\"),\n    MediumRiskCount = countif(RiskIndicator == \"Medium Risk\"),\n    UniqueIPs = dcount(CallerIPAddress),\n    FailureCount = countif(ResultType == \"Failure\" or ResultType != \"0\"),\n    FirstActivity = min(TimeGenerated),\n    LatestActivity = max(TimeGenerated)\n  by ServiceType\n| extend \n    RiskScore = (HighRiskCount * 3) + (MediumRiskCount * 2) + FailureCount,\n    SuccessRate = round((todouble(TotalRequests - FailureCount) / todouble(TotalRequests)) * 100, 1)\n| extend ThreatLevel = case(\n    RiskScore >= 50, \"\ud83d\udd25 Critical Threat\",\n    RiskScore >= 20, \"\ud83d\udd34 High Threat\",\n    RiskScore >= 5, \"\ud83d\udfe0 Medium Threat\",\n    \"\ud83d\udfe2 Low Threat\"\n)\n| project \n    ['服务类型'] = ServiceType,\n    ['Threat Level'] = ThreatLevel,\n    ['Total Requests'] = TotalRequests,\n    ['风险评分'] = RiskScore,\n    ['High-Risk Events'] = HighRiskCount,\n    ['Medium-Risk Events'] = MediumRiskCount,\n    ['Failure Count'] = FailureCount,\n    ['成功率 %'] = SuccessRate,\n    ['Unique IP Count'] = UniqueIPs,\n    ['First Activity'] = format_datetime(FirstActivity, 'MM-dd HH:mm'),\n    ['Latest Activity'] = format_datetime(LatestActivity, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['Total Requests'] desc",
                            "size": 0,
                            "title": "\ud83c\udfa8 Multimodal AI Usage & Security Overview",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Threat Level",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd25",
                                                    "representation": "red"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "严重级别 Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellowOrangeRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "Critical Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "High-严重级别 Alerts",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "multimodal_threat_analysis",
                        "id": "eb894b41-1abd-4c6e-ad18-1186f38f9086"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI Service Usage 趋势分析\n// Monitors AI service sign-in trends over selected time period\nlet lookbackDays = toint({TrendDays});\nlet t0 = ago(lookbackDays * 1d);\nSigninLogs\n| where TimeGenerated > t0\n| extend AppNameLower = tolower(AppDisplayName), ResourceLower = tolower(ResourceDisplayName)\n| where AppNameLower has_any (\"openai\", \"cognitive\", \"vision\", \"speech\", \"ai\", \"copilot\", \"azure\", \"microsoft\") or\n        ResourceLower has_any (\"openai\", \"cognitive\", \"ai\")\n| extend ServiceCategory = case(\n    AppNameLower has \"vision\" or ResourceLower has \"vision\", \"\ud83d\uddbc\ufe0f Vision Services\",\n    AppNameLower has \"speech\" or ResourceLower has \"speech\", \"\ud83c\udfa4 Speech Services\",\n    AppNameLower has \"openai\" or ResourceLower has \"openai\", \"\ud83e\udd16 OpenAI Services\",\n    AppNameLower has \"copilot\", \"\ud83d\udcbc Microsoft Copilot\",\n    AppNameLower has \"cognitive\" or ResourceLower has \"cognitive\", \"\ud83e\udde0 Cognitive Services\",\n    \"\ud83d\udd27 Other AI Services\"\n)\n| extend IsSuccess = iff(ResultType == \"0\", 1, 0)\n| extend IsAnomaly = iff(RiskLevelDuringSignIn in (\"high\", \"medium\") or ResultType != \"0\", 1, 0)\n| extend DayBucket = bin(TimeGenerated, 1d)\n| summarize \n    TotalEvents = count(),\n    SuccessfulEvents = countif(IsSuccess == 1),\n    FailedEvents = countif(IsSuccess == 0),\n    AnomalousEvents = countif(IsAnomaly == 1),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName)\n  by DayBucket, ServiceCategory\n| extend \n    SuccessRate = round((todouble(SuccessfulEvents) / todouble(TotalEvents)) * 100, 1),\n    AnomalyRate = round((todouble(AnomalousEvents) / todouble(TotalEvents)) * 100, 1)\n| extend Trend = case(\n    AnomalyRate >= 30, \"\ud83d\udd34 High Risk\",\n    AnomalyRate >= 10, \"\ud83d\udfe0 Medium Risk\",\n    AnomalyRate > 0, \"\ud83d\udfe1 Low Risk\",\n    \"\ud83d\udfe2 Normal\"\n)\n| project \n    ['Date'] = format_datetime(DayBucket, 'yyyy-MM-dd'),\n    ['Service Category'] = ServiceCategory,\n    ['Status'] = Trend,\n    ['Total Events'] = TotalEvents,\n    ['Successful'] = SuccessfulEvents,\n    ['Failed'] = FailedEvents,\n    ['Anomalous'] = AnomalousEvents,\n    ['Unique Users'] = UniqueUsers,\n    ['Unique Apps'] = UniqueApps,\n    ['成功率 % \u2705'] = SuccessRate,\n    ['Anomaly Rate % \u26a0\ufe0f'] = AnomalyRate\n| order by ['Date'] desc, ['Total Events'] desc\n| take 100",
                            "size": 0,
                            "title": "\ud83c\udfa8 AI Service Usage 趋势分析 (Last {TrendDays} Days)",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Events",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "成功率 % \u2705",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed",
                                            "aggregation": "Average"
                                        }
                                    },
                                    {
                                        "columnMatch": "Anomaly Rate % \u26a0\ufe0f",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright",
                                            "aggregation": "Average"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "deepfake_trend_analysis",
                        "id": "e4e91b7b-026e-4dc8-b320-06d5f0467208"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AI Service User Behavior Analysis\n// Identifies users with unusual AI service access patterns\nlet t0 = {TimeRange:start};\nSigninLogs\n| where TimeGenerated > t0\n| where AppDisplayName has_any (\"OpenAI\", \"Cognitive\", \"Vision\", \"Speech\", \"Azure AI\", \"Azure OpenAI\")\n   or ResourceDisplayName has_any (\"Azure OpenAI\", \"Cognitive Services\", \"Azure AI\")\n| extend \n    RiskScore = case(\n        RiskLevelDuringSignIn == \"high\", 3,\n        RiskLevelDuringSignIn == \"medium\", 2,\n        RiskLevelDuringSignIn == \"low\", 1,\n        0\n    ),\n    IsFailure = iff(ResultType != \"0\", 1, 0)\n| summarize \n    TotalSignins = count(),\n    FailedSignins = sum(IsFailure),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueIPs = dcount(IPAddress),\n    TotalRiskScore = sum(RiskScore),\n    Apps = make_set(AppDisplayName, 5),\n    Locations = make_set(Location, 3),\n    FirstAccess = min(TimeGenerated),\n    LatestAccess = max(TimeGenerated)\n  by UserPrincipalName, UserDisplayName\n| extend \n    CombinedRiskScore = TotalRiskScore + (FailedSignins * 2),\n    SuccessRate = round((todouble(TotalSignins - FailedSignins) / todouble(TotalSignins)) * 100, 1)\n| extend ThreatProfile = case(\n    CombinedRiskScore >= 50 or UniqueIPs >= 10, \"\ud83d\udd34 High-Risk User\",\n    CombinedRiskScore >= 20 or UniqueIPs >= 5, \"\ud83d\udfe0 Medium-Risk User\",\n    CombinedRiskScore > 0, \"\ud83d\udfe1 Low-Risk User\",\n    \"\ud83d\udfe2 Normal User\"\n)\n| extend AccessDuration = datetime_diff('day', LatestAccess, FirstAccess)\n| where CombinedRiskScore > 0 or FailedSignins > 0\n| project \n    ['User'] = UserDisplayName,\n    ['UPN'] = UserPrincipalName,\n    ['Threat Profile'] = ThreatProfile,\n    ['风险评分'] = CombinedRiskScore,\n    ['Total Signins'] = TotalSignins,\n    ['Failed Signins'] = FailedSignins,\n    ['成功率 %'] = SuccessRate,\n    ['Unique Apps'] = UniqueApps,\n    ['唯一IP数'] = UniqueIPs,\n    ['Access Duration (Days)'] = AccessDuration,\n    ['AI Services'] = strcat_array(Apps, ', '),\n    ['Locations'] = strcat_array(Locations, ', '),\n    ['First Access'] = format_datetime(FirstAccess, 'MM-dd HH:mm'),\n    ['Latest Access'] = format_datetime(LatestAccess, 'MM-dd HH:mm')\n| order by ['风险评分'] desc, ['Total Signins'] desc\n| take 20",
                            "size": 0,
                            "title": "\ud83c\udfa8 AI Service User Behavior Analysis",
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Threat Profile",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udd34",
                                                    "representation": "redBright"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe0",
                                                    "representation": "orange"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe1",
                                                    "representation": "yellow"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "\ud83d\udfe2",
                                                    "representation": "green"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Cross-Modal Score",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Attacks",
                                        "formatter": 3,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "cross_modal_correlation",
                        "id": "5202975a-0474-425d-9911-7cba00c9c3a9"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "multimodal_ai"
            },
            "name": "multimodal_ai_group",
            "id": "aba1128b-eec1-4930-930c-3a9f7a9f5c9d"
        },
        {
            "type": 1,
            "content": {
                "json": "<div style=\"background: linear-gradient(to right, #0078D4, #004E8C); color: white; padding: 10px; border-radius: 5px; margin-top: 20px; text-align: center;\">\n  <h3 style=\"margin: 0;\">Microsoft Sentinel AI安全情报监控平台</h3>\n  <p style=\"margin: 5px 0 0 0;\">\u00a9 Microsoft Corporation, 2025 | Version 2.0.0 | 作者: Jason Liang</p>\n</div>"
            },
            "name": "footer",
            "id": "b5289bf2-5990-43a5-89d8-d59097106631"
        }
    ],
    "fallbackResourceIds": [
        "/subscriptions/99005f96-e572-4035-b476-836fd9d83d64/resourceGroups/cybersoc/providers/Microsoft.OperationalInsights/workspaces/CyberSOC"
    ],
    "fromTemplateId": "sentinel-UserWorkbook",
    "$schema": "https://raw.githubusercontent.com/microsoft/Application-Insights-Workbooks/master/schema/workbook.json",
    "context": {
        "ownerId": "/subscriptions/99005f96-e572-4035-b476-836fd9d83d64/resourceGroups/cybersoc/providers/Microsoft.OperationalInsights/workspaces/CyberSOC"
    }
}
